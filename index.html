<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Mobile Web App Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Discipline">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1e1b4b">
  <meta name="msapplication-TileColor" content="#1e1b4b">
  <meta name="format-detection" content="telephone=no">

  <!-- SEO and Social Meta Tags -->
  <meta name="description" content="Track your daily habits and build discipline with rewards and penalties">
  <meta name="application-name" content="Discipline Tracker">

  <title>Discipline Tracker</title>
  <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Discipline Tracker&quot;,&quot;short_name&quot;:&quot;Discipline&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%231e1b4b&quot;,&quot;theme_color&quot;:&quot;%231e1b4b&quot;}">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap');

    * {
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    .mono {
      font-family: 'Space Mono', monospace;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.8); }
    }

    .animate-pulse-red {
      animation: pulse-red 1.5s ease-in-out infinite;
    }

    .animate-slide-in {
      animation: slideIn 0.3s ease-out;
    }

    .animate-flicker {
      animation: flicker 1.5s ease-in-out infinite;
    }

    .habit-btn {
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .habit-btn:active {
      transform: scale(0.95);
    }

    .glass {
      background: rgba(15, 15, 35, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }

    .glow {
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.2);
    }

    body {
      overscroll-behavior: none;
      background: #0a0a1a;
    }

    /* Tier-based dynamic backgrounds - refined */
    @keyframes goldAura {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes crisisGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(0.9); }
    }

    .tier-elite {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.08), rgba(139, 92, 246, 0.03), rgba(212, 175, 55, 0.08));
      background-size: 200% 200%;
      animation: goldAura 6s ease-in-out infinite;
    }

    .tier-solid {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.06), rgba(139, 92, 246, 0.03));
    }

    .tier-decent {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.06), rgba(139, 92, 246, 0.03));
    }

    .tier-struggling {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(139, 92, 246, 0.03));
    }

    .tier-crisis {
      animation: crisisGlow 2s ease-in-out infinite;
    }

    /* Ghost streak styling */
    .ghost-streak {
      position: absolute;
      opacity: 0.2;
      font-size: 2.5rem;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    /* Sparkline styles */
    .sparkline {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 24px;
    }

    .sparkline-bar {
      width: 4px;
      border-radius: 1px;
      transition: height 0.3s ease;
    }

    /* Long press animation */
    @keyframes longPressProgress {
      from { width: 0%; }
      to { width: 100%; }
    }

    .long-press-indicator {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #6366f1);
      border-radius: 0 0 8px 8px;
    }

    /* Swipe hint */
    .swipe-hint {
      opacity: 0.5;
      font-size: 10px;
      text-align: center;
      padding: 4px;
    }

    /* Stealth mode */
    .stealth-mode .habit-icon {
      font-family: 'Space Mono', monospace;
      font-size: 0.9rem;
    }

    /* 30-Day Heatmap styles */
    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      border-radius: 3px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .heatmap-cell:hover {
      transform: scale(1.2);
      z-index: 10;
    }

    .heatmap-level-0 { background: rgba(255, 255, 255, 0.03); }
    .heatmap-level-1 { background: rgba(99, 102, 241, 0.25); }
    .heatmap-level-2 { background: rgba(99, 102, 241, 0.45); }
    .heatmap-level-3 { background: rgba(99, 102, 241, 0.65); }
    .heatmap-level-4 { background: rgba(16, 185, 129, 0.75); }

    /* Page flip animation */
    @keyframes pageFlip {
      0% { transform: rotateY(0deg); }
      50% { transform: rotateY(-20deg); }
      100% { transform: rotateY(0deg); }
    }

    .page-flip {
      animation: pageFlip 0.3s ease-out;
    }

    @keyframes pagePop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    .page-pop {
      animation: pagePop 0.2s ease-out;
    }

    /* Counter button styles */
    .counter-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.15s ease;
      user-select: none;
    }

    .counter-btn:active {
      transform: scale(0.9);
    }

    .counter-btn-plus {
      background: linear-gradient(135deg, #059669, #047857);
      color: white;
      box-shadow: 0 2px 10px rgba(5, 150, 105, 0.3);
    }

    .counter-btn-minus {
      background: rgba(255, 255, 255, 0.1);
      color: #a78bfa;
    }

    .counter-btn-minus:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .counter-display {
      min-width: 40px;
      text-align: center;
      font-weight: bold;
      font-family: 'Space Mono', monospace;
    }

    /* Weekly Matrix Grid styles */
    .weekly-matrix {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .matrix-table {
      min-width: 100%;
      border-collapse: separate;
      border-spacing: 2px;
    }

    .matrix-cell {
      text-align: center;
      padding: 6px 4px;
      font-size: 10px;
      border-radius: 4px;
      min-width: 40px;
      transition: all 0.15s ease;
    }

    .matrix-cell:hover {
      transform: scale(1.05);
      z-index: 5;
    }

    .matrix-header {
      font-weight: 600;
      color: #a78bfa;
      background: rgba(139, 92, 246, 0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .matrix-habit-name {
      text-align: left;
      padding: 6px 8px;
      font-weight: 500;
      font-size: 11px;
      white-space: nowrap;
      position: sticky;
      left: 0;
      background: rgba(15, 15, 35, 0.95);
      z-index: 5;
      min-width: 100px;
    }

    .matrix-score-full {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.6), rgba(5, 150, 105, 0.6));
      color: white;
    }

    .matrix-score-partial {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.5), rgba(217, 119, 6, 0.5));
      color: white;
    }

    .matrix-score-zero {
      background: rgba(239, 68, 68, 0.15);
      color: rgba(239, 68, 68, 0.7);
    }

    .matrix-score-negative {
      background: rgba(239, 68, 68, 0.4);
      color: white;
    }

    .matrix-future {
      background: rgba(255, 255, 255, 0.03);
      color: rgba(255, 255, 255, 0.2);
    }

    .matrix-off-day {
      background: rgba(100, 100, 100, 0.2);
      color: rgba(255, 255, 255, 0.3);
    }

    .matrix-today-col {
      box-shadow: inset 0 0 0 2px rgba(139, 92, 246, 0.5);
    }

    .matrix-total-row {
      font-weight: bold;
      background: rgba(139, 92, 246, 0.15);
      border-top: 2px solid rgba(139, 92, 246, 0.3);
    }

    .matrix-habit-row:nth-child(odd) .matrix-habit-name {
      background: rgba(15, 15, 35, 0.98);
    }

    /* Tier indicators for habit rows */
    .tier-marker {
      display: inline-block;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      margin-right: 4px;
    }

    .tier-marker-1 { background: #f59e0b; } /* Neural */
    .tier-marker-2 { background: #10b981; } /* Nutrition */
    .tier-marker-3 { background: #3b82f6; } /* Physical */
    .tier-marker-4 { background: #8b5cf6; } /* Mind */
    .tier-marker-5 { background: #6b7280; } /* Maintenance */

    /* Screen Timer Styles */
    .screen-timer {
      position: relative;
      overflow: hidden;
    }

    .screen-timer-running {
      animation: timerPulse 2s ease-in-out infinite;
    }

    @keyframes timerPulse {
      0%, 100% { box-shadow: 0 0 10px rgba(99, 102, 241, 0.3); }
      50% { box-shadow: 0 0 25px rgba(99, 102, 241, 0.6); }
    }

    .timer-progress-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      transition: width 1s linear;
      border-radius: 0 2px 2px 0;
    }

    .quota-bar {
      height: 8px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }

    .quota-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .quota-fill-safe {
      background: linear-gradient(90deg, #10b981, #059669);
    }

    .quota-fill-warning {
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }

    .quota-fill-danger {
      background: linear-gradient(90deg, #ef4444, #dc2626);
    }

    .timer-display {
      font-family: 'Space Mono', monospace;
      font-size: 2rem;
      font-weight: bold;
      letter-spacing: 2px;
    }

    .mode-selector {
      display: flex;
      gap: 8px;
    }

    .mode-btn {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.15s ease;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .mode-btn:hover:not(.mode-active) {
      background: rgba(255, 255, 255, 0.1);
    }

    .mode-active {
      border-color: white;
    }

    .time-leak-warning {
      animation: leakPulse 1s ease-in-out infinite;
    }

    @keyframes leakPulse {
      0%, 100% { background-color: rgba(239, 68, 68, 0.2); }
      50% { background-color: rgba(239, 68, 68, 0.4); }
    }

    /* Productivity Slider Styles */
    .productivity-slider-container {
      position: relative;
      padding: 8px 0;
    }

    .productivity-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 12px;
      border-radius: 6px;
      outline: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .productivity-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3), 0 0 0 4px rgba(255, 255, 255, 0.2);
      transition: all 0.15s ease;
    }

    .productivity-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.4), 0 0 0 6px rgba(255, 255, 255, 0.3);
    }

    .productivity-slider::-webkit-slider-thumb:active {
      transform: scale(0.95);
    }

    .productivity-slider::-moz-range-thumb {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    /* Slider track color variations */
    .slider-level-0 {
      background: linear-gradient(90deg, #dc2626, #991b1b);
    }
    .slider-level-1 {
      background: linear-gradient(90deg, #f97316, #ea580c);
    }
    .slider-level-2 {
      background: linear-gradient(90deg, #eab308, #ca8a04);
    }
    .slider-level-3 {
      background: linear-gradient(90deg, #22c55e, #16a34a);
    }
    .slider-level-4 {
      background: linear-gradient(90deg, #06b6d4, #0891b2, #d4af37);
    }

    .productivity-notches {
      display: flex;
      justify-content: space-between;
      padding: 0 12px;
      margin-top: 4px;
    }

    .productivity-notch {
      width: 2px;
      height: 8px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 1px;
    }

    .productivity-notch-active {
      background: rgba(255, 255, 255, 0.8);
      height: 10px;
    }

    .productivity-tier-label {
      text-align: center;
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .tier-label-0 {
      background: rgba(220, 38, 38, 0.2);
      border: 1px solid rgba(220, 38, 38, 0.4);
    }
    .tier-label-1 {
      background: rgba(249, 115, 22, 0.2);
      border: 1px solid rgba(249, 115, 22, 0.4);
    }
    .tier-label-2 {
      background: rgba(234, 179, 8, 0.2);
      border: 1px solid rgba(234, 179, 8, 0.4);
    }
    .tier-label-3 {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.4);
    }
    .tier-label-4 {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(212, 175, 55, 0.2));
      border: 1px solid rgba(6, 182, 212, 0.4);
    }

    @keyframes flowPulse {
      0%, 100% { box-shadow: 0 0 10px rgba(6, 182, 212, 0.3); }
      50% { box-shadow: 0 0 25px rgba(212, 175, 55, 0.5); }
    }

    .flow-state-active {
      animation: flowPulse 2s ease-in-out infinite;
    }

    /* ============================================
       SMART CONTEXT COMMAND CENTER STYLES
       ============================================ */

    .command-center {
      position: relative;
      border-radius: 1rem;
      overflow: hidden;
      transition: all 0.4s ease;
    }

    /* State-based backgrounds */
    @keyframes eliteShimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    @keyframes crisisAlert {
      0%, 100% { box-shadow: inset 0 0 20px rgba(239, 68, 68, 0.3); }
      50% { box-shadow: inset 0 0 40px rgba(239, 68, 68, 0.5); }
    }

    .command-center.state-elite {
      background: linear-gradient(90deg,
        rgba(212, 175, 55, 0.1) 0%,
        rgba(255, 215, 0, 0.2) 50%,
        rgba(212, 175, 55, 0.1) 100%);
      background-size: 200% 100%;
      animation: eliteShimmer 3s linear infinite;
      border: 1px solid rgba(212, 175, 55, 0.3);
    }

    .command-center.state-solid {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.05));
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .command-center.state-decent {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.05));
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .command-center.state-struggling {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(234, 88, 12, 0.08));
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .command-center.state-crisis {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(185, 28, 28, 0.1));
      border: 1px solid rgba(239, 68, 68, 0.4);
      animation: crisisAlert 1.5s ease-in-out infinite;
    }

    /* Progress bar */
    .progress-track {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease, background 0.3s ease;
    }

    .progress-fill.elite { background: linear-gradient(90deg, #d4af37, #ffd700); }
    .progress-fill.solid { background: linear-gradient(90deg, #3b82f6, #6366f1); }
    .progress-fill.decent { background: linear-gradient(90deg, #22c55e, #10b981); }
    .progress-fill.struggling { background: linear-gradient(90deg, #f59e0b, #ea580c); }
    .progress-fill.crisis { background: linear-gradient(90deg, #ef4444, #dc2626); }

    /* Tier markers on progress bar */
    .progress-markers {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .progress-marker {
      position: absolute;
      top: -2px;
      bottom: -2px;
      width: 2px;
      background: rgba(255, 255, 255, 0.3);
    }

    /* Sync indicator */
    .sync-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      display: inline-block;
    }

    .sync-dot.connected {
      background: #22c55e;
      box-shadow: 0 0 6px rgba(34, 197, 94, 0.6);
      animation: pulse 2s ease-in-out infinite;
    }

    .sync-dot.disconnected {
      background: #6b7280;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Compact stat pills */
    .stat-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.08);
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .stat-pill:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* Streak drilldown modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ============================================================================
    // CONSTANTS & CONFIGURATION
    // ============================================================================

    // Week starts Sunday Jan 25, 2026 (use local timezone to avoid date shift)
    const JOURNEY_START = new Date(2026, 0, 25); // Month is 0-indexed (0 = January)
    const STORAGE_KEY = 'discipline-tracker-v5'; // Bump version for date fix
    const SHEETS_CONFIG_KEY = 'discipline-tracker-sheets-config';

    // HABITS ordered by importance (Progressive Disclosure - critical at top)
    const HABITS = [
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // MORNING: Start Your Day Right
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      { id: 'weight', name: 'Weight Logged', icon: 'âš–ï¸', points: 0.1, stealthName: 'LOG_02', stealthIcon: 'â–¡' },
      { id: 'prayer', name: 'Hanuman Chalisa', icon: 'ðŸ™', points: 0.5, stealthName: 'MIND_02', stealthIcon: 'âœ§' },
      { id: 'meditation', name: 'Meditation', icon: 'ðŸ§˜â€â™‚ï¸', points: 1, stealthName: 'MIND_01', stealthIcon: 'â—Ž' },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // MIDDAY: Fuel
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      { id: 'lunch', name: 'Lunch', icon: 'ðŸ³', points: 2, stealthName: 'FUEL_01', stealthIcon: 'â–²' },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // EVENING: Training & Wind Down
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      { id: 'gym', name: 'Gym', icon: 'ðŸ’ª', points: 1, stealthName: 'MOVE_01', stealthIcon: 'â—' },
      { id: 'dinner', name: 'Dinner', icon: 'ðŸ½ï¸', points: 2, stealthName: 'FUEL_02', stealthIcon: 'â–¼' },
      { id: 'reading', name: 'Reading', icon: 'ðŸ“š', points: 2, stealthName: 'GROW_01', stealthIcon: 'â–£' },
      { id: 'journal', name: 'Journaling', icon: 'ðŸ“', points: 1, stealthName: 'MIND_03', stealthIcon: 'â–¢' },
      { id: 'loseit', name: 'Diet Logged', icon: 'ðŸ¥—', points: 2, stealthName: 'LOG_01', stealthIcon: 'â—‡' },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // NIGHT: Sleep
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      { id: 'sleep', name: 'Sleep', icon: 'ðŸ˜´', points: 1, isTime: true, stealthName: 'REST_01', stealthIcon: 'â—' },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ALL DAY: Foundation Habit
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      { id: 'nofap', name: 'Dopamine Baseline', icon: 'ðŸ’Ž', points: 3, stealthName: 'CORE_01', stealthIcon: 'â—†' },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // WEEKLY
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      { id: 'therapy', name: 'Mental Reset', icon: 'ðŸ§ ', points: 2, isWeekly: true, stealthName: 'MIND_04', stealthIcon: 'â¬¡' },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // GROWTH: When Time Permits
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      { id: 'career', name: 'Career Dev', icon: 'ðŸš€', points: 1, stealthName: 'GROW_02', stealthIcon: 'â–³' },

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // MAINTENANCE: As Needed
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      { id: 'dishes', name: 'Dishes', icon: 'ðŸ½ï¸', points: 0.5, stealthName: 'MAINT_02', stealthIcon: 'â—' },
      { id: 'laundry', name: 'Laundry', icon: 'ðŸ§º', points: 0.5, stealthName: 'MAINT_01', stealthIcon: 'â–½' },
      { id: 'cleaning', name: 'Cleaning', icon: 'ðŸ§¹', points: 0.5, stealthName: 'MAINT_03', stealthIcon: 'â–·' }
    ];

    const TIERS = {
      ELITE: { name: 'ELITE', min: 94, icon: 'ðŸ‘‘', color: 'from-yellow-400 to-amber-600', reward: 100 },
      SOLID: { name: 'SOLID', min: 83, icon: 'ðŸ’ª', color: 'from-blue-400 to-blue-600', reward: 60 },
      DECENT: { name: 'DECENT', min: 70, icon: 'âœ“', color: 'from-green-400 to-green-600', reward: 30 },
      STRUGGLING: { name: 'STRUGGLING', min: 55, icon: 'âš ï¸', color: 'from-orange-400 to-red-500', penalty: 75 },
      CRISIS: { name: 'CRISIS', min: 0, icon: 'ðŸš¨', color: 'from-rose-600 to-red-800', penalty: 200 }
    };

    // Screen Time Quota Configuration
    const SCREEN_QUOTA = {
      ENTERTAINMENT_DAILY_LIMIT: 90,  // minutes
      TIME_LEAK_PENALTY: -5,          // points penalty for exceeding quota
      EDUCATIONAL_CAREER_RATE: 30     // minutes of educational content = 1 career point
    };

    const SCREEN_MODES = {
      EDUCATIONAL: { id: 'educational', name: 'Educational/Informative', icon: 'ðŸ“š', color: 'from-emerald-500 to-teal-600' },
      ENTERTAINMENT: { id: 'entertainment', name: 'Entertainment', icon: 'ðŸ“º', color: 'from-amber-500 to-orange-600' }
    };

    // Productivity Scale: Cognitive Throughput Rating (0-4)
    const PRODUCTIVITY_TIERS = [
      {
        level: 0,
        name: 'System Failure',
        description: 'No meaningful work done (illness or total procrastination)',
        points: 0,
        color: 'text-red-400',
        icon: 'ðŸ”´'
      },
      {
        level: 1,
        name: 'Maintenance',
        description: 'Shallow work only: emails, meetings, admin tasks',
        points: 1,
        color: 'text-orange-400',
        icon: 'ðŸŸ '
      },
      {
        level: 2,
        name: 'Functional',
        description: 'Standard output: tickets, some coding, basic analysis',
        points: 2,
        color: 'text-yellow-400',
        icon: 'ðŸŸ¡'
      },
      {
        level: 3,
        name: 'Power State',
        description: 'Deep work: architecting models, complex SQL/Python',
        points: 3,
        color: 'text-green-400',
        icon: 'ðŸŸ¢'
      },
      {
        level: 4,
        name: 'Flow State',
        description: 'Exceptional output: major blockers solved, zero distractions',
        points: 4,
        color: 'text-cyan-400',
        icon: 'ðŸ’Ž'
      }
    ];

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================

    // Generate time slots from 10 PM to 4 AM (in 15-min increments)
    const TIME_SLOTS = (() => {
      const slots = [];
      // 10 PM to 11:45 PM (22:00 - 23:45)
      for (let h = 22; h <= 23; h++) {
        for (let m = 0; m < 60; m += 15) {
          const hour24 = h.toString().padStart(2, '0');
          const min = m.toString().padStart(2, '0');
          const hour12 = h > 12 ? h - 12 : h;
          const ampm = 'PM';
          slots.push({
            value: `${hour24}:${min}`,
            label: `${hour12}:${min} ${ampm}`
          });
        }
      }
      // 12 AM to 4 AM (00:00 - 04:00)
      for (let h = 0; h <= 4; h++) {
        for (let m = 0; m < 60; m += 15) {
          if (h === 4 && m > 0) break; // Stop at 4:00 AM
          const hour24 = h.toString().padStart(2, '0');
          const min = m.toString().padStart(2, '0');
          const hour12 = h === 0 ? 12 : h;
          slots.push({
            value: `${hour24}:${min}`,
            label: `${hour12}:${min} AM`
          });
        }
      }
      return slots;
    })();

    const isSameDay = (d1, d2) => {
      return d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate();
    };

    const isPastDay = (dateStr) => {
      const date = new Date(dateStr);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      date.setHours(0, 0, 0, 0);
      return date < today;
    };

    const isFutureDay = (dateStr) => {
      const date = new Date(dateStr);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      date.setHours(0, 0, 0, 0);
      return date > today;
    };

    const formatDate = (dateStr) => {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    };

    // Check if a day is Friday or Saturday (weekend buffer days for sleep)
    const isWeekendDay = (dateStr) => {
      const date = new Date(dateStr);
      const day = date.getDay();
      return day === 5 || day === 6; // Friday = 5, Saturday = 6
    };

    // Check if a day is Saturday or Sunday (non-work days)
    const isNonWorkDay = (dateStr) => {
      const date = new Date(dateStr);
      const day = date.getDay();
      return day === 0 || day === 6; // Sunday = 0, Saturday = 6
    };

    // Check if a day is Sunday
    const isSunday = (dateStr) => {
      const date = new Date(dateStr);
      return date.getDay() === 0;
    };

    // Calculate sleep points based on time (Sleep Velocity)
    // 10:30 PM = +2 (Elite), 11:00 PM = +1 (Goal), 11:30 PM = 0, 12:30 AM+ = -1 (Penalty)
    // Simplified sleep scoring: +1pt before 11pm, -1pt after 11pm
    const calculateSleepPoints = (sleepTimeStr, isWeekend) => {
      if (!sleepTimeStr) return 0;
      if (isWeekend) return 1; // Flat reward for Friday/Saturday (Free-Roam)

      const [hours, minutes] = sleepTimeStr.split(':').map(Number);
      let totalMinutes = hours * 60 + minutes;
      // If time is between 00:00-06:00, treat as late night (add 24h worth)
      if (hours < 6) totalMinutes += 24 * 60;

      // 23:00 (11:00 PM) = 1380 mins
      return totalMinutes <= 1380 ? 1 : -1;
    };

    // Check if Sunday sleep was on time (for Monday career penalty)
    const wasSundaySleepOnTime = (week) => {
      // Find Sunday in the week (day index where getDay() === 0)
      const sundayDay = week.days.find(d => isSunday(d.date));
      if (!sundayDay || !sundayDay.sleepTime) return true; // Default to true if no data

      const sleepPoints = calculateSleepPoints(sundayDay.sleepTime, false);
      return sleepPoints >= 1; // Must be at goal (11:00 PM) or better
    };

    // Check if a weekly habit was completed on any day this week
    const isWeeklyHabitComplete = (week, habitId) => {
      const habit = HABITS.find(h => h.id === habitId);
      if (!habit) return false;
      return week.days.some(day => (day.habits[habitId] ?? 0) >= habit.points);
    };

    // Get the day index where a weekly habit was completed (for display)
    const getWeeklyHabitCompletionDay = (week, habitId) => {
      const habit = HABITS.find(h => h.id === habitId);
      if (!habit) return -1;
      return week.days.findIndex(day => (day.habits[habitId] ?? 0) >= habit.points);
    };

    const createEmptyDay = (date) => ({
      date: date.toISOString(),
      habits: {
        nofap: 0, gym: 0, lunch: 0, dinner: 0, loseit: 0, weight: 0,
        laundry: 0, dishes: 0, cleaning: 0, meditation: 0,
        prayer: 0, sleep: 0, journal: 0, reading: 0, career: 0, therapy: 0
      },
      pagesRead: 0,
      sleepTime: null,      // Store actual sleep time (HH:MM format)
      isVitalRest: false,   // Vital Rest Day (auto-awards gym point)
      completedTasks: [],
      isOffDay: false,
      isLocked: false,
      isFilled: false,
      lastUpdated: null,
      // Screen Time Tracking
      screenTime: {
        educational: 0,     // minutes of educational content
        entertainment: 0,   // minutes of entertainment content
        sessions: []        // Array of { mode, startTime, endTime, duration }
      },
      // Productivity Rating (Cognitive Throughput)
      productivityRating: null  // 0-4 scale, null = not rated yet
    });

    const createWeek = (startDate) => {
      const days = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        days.push(createEmptyDay(date));
      }
      return { startDate: startDate.toISOString(), days };
    };

    // Auto-generate new weeks when current date passes end of existing weeks
    const checkAndCreateNewWeeks = (currentState) => {
      if (!currentState || !currentState.weeks || currentState.weeks.length === 0) {
        return currentState;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let newState = { ...currentState };
      let lastWeek = newState.weeks[newState.weeks.length - 1];
      let lastDayOfLastWeek = new Date(lastWeek.days[6].date);
      lastDayOfLastWeek.setHours(0, 0, 0, 0);

      // Keep creating weeks until today is covered
      while (today > lastDayOfLastWeek) {
        // Create next week starting the day after last week ended
        const nextStart = new Date(lastDayOfLastWeek);
        nextStart.setDate(nextStart.getDate() + 1);

        const newWeek = createWeek(nextStart);
        newState = {
          ...newState,
          weeks: [...newState.weeks, newWeek],
          currentWeek: newState.weeks.length, // Point to the new week
          viewMode: 'today' // Switch to today view for new week
        };

        lastWeek = newWeek;
        lastDayOfLastWeek = new Date(lastWeek.days[6].date);
        lastDayOfLastWeek.setHours(0, 0, 0, 0);
      }

      // Find the week that contains today and set it as current
      const todayTime = today.getTime();
      for (let i = 0; i < newState.weeks.length; i++) {
        const weekStart = new Date(newState.weeks[i].days[0].date);
        const weekEnd = new Date(newState.weeks[i].days[6].date);
        weekStart.setHours(0, 0, 0, 0);
        weekEnd.setHours(23, 59, 59, 999);

        if (todayTime >= weekStart.getTime() && todayTime <= weekEnd.getTime()) {
          newState.currentWeek = i;
          break;
        }
      }

      return newState;
    };

    const initializeState = () => {
      return {
        version: "4.0",
        currentWeek: 0,
        weeks: [createWeek(JOURNEY_START)],
        adHocTasks: [],
        streakDays: 0,
        longestStreak: 0,
        guiltFreeBalance: 0,
        nreBalance: 0,
        journeyStartDate: JOURNEY_START.toISOString(),
        viewMode: "today",
        lastModified: Date.now(), // For collision detection
        deviceId: Math.random().toString(36).substring(7) // Unique device identifier
      };
    };

    // ============================================================================
    // STORAGE FUNCTIONS
    // ============================================================================

    const loadFromStorage = () => {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (e) {
        console.error('Failed to load from localStorage:', e);
      }
      return null;
    };

    const saveToStorage = (data) => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('Failed to save to localStorage:', e);
      }
    };

    // ============================================================================
    // SCORING LOGIC
    // ============================================================================

    // Progressive reading points - rewards deeper reading sessions
    // Tier 1: 1-15 pages = 1pt (habit building)
    // Tier 2: 16-30 pages = 2pts (proper session)
    // Tier 3: 31-50 pages = 4pts (deep work)
    // Tier 4: 51-75 pages = 7pts (significant reading)
    // Tier 5: 76-100 pages = 11pts (marathon session)
    // Tier 6: 101-150 pages = 17pts (exceptional)
    // Tier 7: 151+ pages = 20pts (max/day)
    const calculateReadingPoints = (pages) => {
      if (!pages || pages <= 0) return 0;
      if (pages >= 151) return 20;  // Cap: Ultra achievement
      if (pages >= 101) return 17;  // Exceptional
      if (pages >= 76) return 11;   // Marathon session
      if (pages >= 51) return 7;    // Significant reading
      if (pages >= 31) return 4;    // Deep work
      if (pages >= 16) return 2;    // Proper session
      return 1;                      // Habit building (1-15 pages)
    };

    // Get reading tier progress info for UI
    const getReadingTierInfo = (pages) => {
      const tiers = [
        { min: 0, max: 0, points: 0, nextAt: 1 },
        { min: 1, max: 15, points: 1, nextAt: 16 },
        { min: 16, max: 30, points: 2, nextAt: 31 },
        { min: 31, max: 50, points: 4, nextAt: 51 },
        { min: 51, max: 75, points: 7, nextAt: 76 },
        { min: 76, max: 100, points: 11, nextAt: 101 },
        { min: 101, max: 150, points: 17, nextAt: 151 },
        { min: 151, max: Infinity, points: 20, nextAt: null }
      ];

      const p = pages || 0;
      const tier = tiers.find(t => p >= t.min && p <= t.max) || tiers[0];
      const tierSize = tier.max === Infinity ? 1 : (tier.max - tier.min + 1);
      const pagesInTier = p - tier.min;
      const progressPercent = tier.nextAt ? Math.min(100, (pagesInTier / tierSize) * 100) : 100;
      const pagesToNext = tier.nextAt ? tier.nextAt - p : 0;

      return { points: tier.points, pagesToNext, progressPercent, isMaxed: !tier.nextAt };
    };

    // Calculate core habit score (excludes bonus tasks)
    // Now accepts week for Sunday Reset clause and Vital Rest validation
    const calculateCoreScore = (day, week = null) => {
      if (day.isOffDay) return 0;

      const isWeekend = isWeekendDay(day.date);
      const isMonday = new Date(day.date).getDay() === 1;

      let score = 0;
      HABITS.forEach(habit => {
        if (habit.id === 'reading') {
          // Progressive tiered reading points (1-20pts based on pages read)
          score += calculateReadingPoints(day.pagesRead);
        } else if (habit.id === 'sleep') {
          // Sleep Velocity: Variable points based on time
          score += calculateSleepPoints(day.sleepTime, isWeekend);
        } else if (habit.id === 'gym') {
          // Vital Rest Day: Auto-award 1pt if marked as rest day
          if (day.isVitalRest) {
            score += 1; // Recovery point
          } else {
            score += day.habits[habit.id] ?? 0;
          }
        } else if (habit.id === 'career') {
          // Sunday Reset Clause: If Sunday sleep was late, halve Monday career points
          let careerPoints = day.habits[habit.id] ?? 0;
          if (isMonday && week && !wasSundaySleepOnTime(week)) {
            careerPoints = Math.floor(careerPoints / 2);
          }
          // Educational screen time bonus: 1 career point per 30 min
          const educationalMins = day.screenTime?.educational || 0;
          const educationalBonus = Math.floor(educationalMins / SCREEN_QUOTA.EDUCATIONAL_CAREER_RATE);
          score += careerPoints + educationalBonus;
        } else if (habit.isWeekly && week) {
          // Weekly habits: Only count points on the day it was completed
          // (avoid double-counting across the week)
          const habitValue = day.habits[habit.id] ?? 0;
          if (habitValue >= habit.points) {
            score += habit.points;
          }
        } else {
          // Handle missing habits (like weight added later)
          score += day.habits[habit.id] ?? 0;
        }
      });

      // Screen Time Penalty: Time Leak if entertainment exceeds quota
      const entertainmentMins = day.screenTime?.entertainment || 0;
      if (entertainmentMins > SCREEN_QUOTA.ENTERTAINMENT_DAILY_LIMIT) {
        score += SCREEN_QUOTA.TIME_LEAK_PENALTY; // -5 pts
      }

      // Productivity Rating: Cognitive Throughput bonus (workdays only - not Sat/Sun)
      if (!isNonWorkDay(day.date) && day.productivityRating !== null && day.productivityRating !== undefined) {
        score += PRODUCTIVITY_TIERS[day.productivityRating].points;
      }

      return score;
    };

    // Count vital rest days used in a week
    const countVitalRestDays = (week) => {
      return week.days.filter(d => d.isVitalRest).length;
    };

    // Calculate bonus task score
    const calculateBonusScore = (day, tasks) => {
      if (day.isOffDay) return 0;

      let score = 0;
      day.completedTasks.forEach(taskId => {
        const task = tasks.find(t => t.id === taskId);
        if (task) score += task.points;
      });

      return score;
    };

    const calculateDailyScore = (day, tasks, week = null) => {
      return calculateCoreScore(day, week) + calculateBonusScore(day, tasks);
    };

    const calculateWeekStats = (week, tasks, streakDays) => {
      const activeDaysCount = week.days.filter(d => !d.isOffDay).length;
      const activeRatio = activeDaysCount / 7;

      // Calculate core and bonus scores separately (pass week for Sunday Reset)
      const dailyCoreScores = week.days.map(day => calculateCoreScore(day, week));
      const dailyBonusScores = week.days.map(day => calculateBonusScore(day, tasks));
      const dailyScores = week.days.map(day => calculateDailyScore(day, tasks, week));

      const weeklyCoreScore = dailyCoreScores.reduce((sum, s) => sum + s, 0);
      const weeklyBonusScore = dailyBonusScores.reduce((sum, s) => sum + s, 0);
      const weeklyRawScore = dailyScores.reduce((sum, s) => sum + s, 0);

      // Proportional meal slack: 20% of total possible meals for active days
      let mealsSkipped = 0;
      week.days.forEach(day => {
        if (!day.isOffDay) {
          if (day.habits.lunch === 0) mealsSkipped++;
          if (day.habits.dinner === 0) mealsSkipped++;
        }
      });

      const freeMealAllowance = Math.floor((activeDaysCount * 2) * 0.22); // ~3 free skips per week
      const extraMealsSkipped = Math.max(0, mealsSkipped - freeMealAllowance);
      const mealPenalty = extraMealsSkipped * 2;

      const baseScore = weeklyRawScore - mealPenalty;

      const streakBonus =
        streakDays >= 30 ? 20 :
        streakDays >= 21 ? 15 :
        streakDays >= 14 ? 10 :
        streakDays >= 7 ? 5 : 0;

      const totalScore = baseScore + streakBonus;

      // Dynamic tier thresholds based on active days
      const dynamicThresholds = {
        elite: Math.round(94 * activeRatio),
        solid: Math.round(83 * activeRatio),
        decent: Math.round(70 * activeRatio),
        struggling: Math.round(55 * activeRatio)
      };

      // Core score threshold for bonus eligibility (60% of core max)
      const maxCoreScore = activeDaysCount * 19; // Max possible core score per day
      const coreThreshold = maxCoreScore * 0.6;
      const bonusEligible = weeklyCoreScore >= coreThreshold;

      // Calculate effective score: bonus only counts if core threshold met
      const effectiveScore = bonusEligible ? totalScore : (totalScore - weeklyBonusScore);

      let tier = TIERS.CRISIS;
      if (effectiveScore >= dynamicThresholds.elite) tier = TIERS.ELITE;
      else if (effectiveScore >= dynamicThresholds.solid) tier = TIERS.SOLID;
      else if (effectiveScore >= dynamicThresholds.decent) tier = TIERS.DECENT;
      else if (effectiveScore >= dynamicThresholds.struggling) tier = TIERS.STRUGGLING;

      return {
        dailyScores,
        weeklyCoreScore,
        weeklyBonusScore,
        weeklyRawScore,
        mealsSkipped,
        freeMealAllowance,
        mealPenalty,
        baseScore,
        streakBonus,
        totalScore,
        effectiveScore,
        tier,
        dynamicThresholds,
        activeDaysCount,
        bonusEligible,
        coreThreshold
      };
    };

    // ============================================================================
    // MAIN COMPONENT
    // ============================================================================

    function DisciplineTracker() {
      const [state, setState] = useState(null);
      const [showTaskModal, setShowTaskModal] = useState(false);
      const [showInfoModal, setShowInfoModal] = useState(false);
      const [showBackfillPrompt, setShowBackfillPrompt] = useState(false);
      const [showSheetsModal, setShowSheetsModal] = useState(false);
      const [isLoaded, setIsLoaded] = useState(false);
      const [stealthMode, setStealthMode] = useState(false);
      const [lastSaved, setLastSaved] = useState(Date.now());
      const [longPressTimer, setLongPressTimer] = useState(null);
      const [longPressProgress, setLongPressProgress] = useState(0);
      const [touchStart, setTouchStart] = useState(null);
      const [pageFlipAnim, setPageFlipAnim] = useState(null); // Track which day is animating
      const [sheetsConfig, setSheetsConfig] = useState(null);
      const [syncStatus, setSyncStatus] = useState('disconnected'); // disconnected, syncing, synced, error
      const [showConflictModal, setShowConflictModal] = useState(false);
      const [conflictData, setConflictData] = useState(null); // { local, remote }
      const [showSundayPreFlight, setShowSundayPreFlight] = useState(false);
      const [sundayPreFlightDismissed, setSundayPreFlightDismissed] = useState(false);

      // Screen Timer State
      const [timerRunning, setTimerRunning] = useState(false);
      const [timerMode, setTimerMode] = useState('entertainment'); // 'educational' or 'entertainment'
      const [timerStartTime, setTimerStartTime] = useState(null);
      const [timerElapsed, setTimerElapsed] = useState(0); // seconds
      const [showTimerPanel, setShowTimerPanel] = useState(false);

      // Dynamic Vitals Banner State
      const [showStreakDrilldown, setShowStreakDrilldown] = useState(false);
      const [earningsAnimating, setEarningsAnimating] = useState(false);

      // Neural Reset Modal State (for Dopamine Baseline)
      const [showNeuralResetModal, setShowNeuralResetModal] = useState(false);
      const [neuralResetDayIndex, setNeuralResetDayIndex] = useState(null);

      // Haptic feedback utility
      const triggerHaptic = (type = 'light') => {
        if ('vibrate' in navigator) {
          switch(type) {
            case 'heavy': navigator.vibrate(50); break;  // Core habit
            case 'medium': navigator.vibrate(30); break; // Regular habit
            case 'light': navigator.vibrate(15); break;  // Bonus task
            case 'sparkle': navigator.vibrate([10, 30, 10]); break; // Special
            default: navigator.vibrate(20);
          }
        }
      };

      // Screen Timer - update elapsed time every second
      useEffect(() => {
        if (!timerRunning || !timerStartTime) return;

        const interval = setInterval(() => {
          const now = Date.now();
          const elapsed = Math.floor((now - timerStartTime) / 1000);
          setTimerElapsed(elapsed);
        }, 1000);

        return () => clearInterval(interval);
      }, [timerRunning, timerStartTime]);

      // Sunday Pre-Flight Check - Show modal at 9 PM on Sundays
      useEffect(() => {
        const checkSundayPreFlight = () => {
          const now = new Date();
          const dayOfWeek = now.getDay(); // 0 = Sunday
          const hour = now.getHours();

          // Show modal on Sunday at 9 PM or later (if not already dismissed today)
          if (dayOfWeek === 0 && hour >= 21 && !sundayPreFlightDismissed) {
            setShowSundayPreFlight(true);
          }
        };

        checkSundayPreFlight();
        const interval = setInterval(checkSundayPreFlight, 60000); // Check every minute
        return () => clearInterval(interval);
      }, [sundayPreFlightDismissed]);

      // Touch handlers for swipe gestures
      const handleTouchStart = (e) => {
        setTouchStart(e.touches[0].clientX);
      };

      const handleTouchEnd = (e, navigateWeek) => {
        if (!touchStart) return;
        const touchEnd = e.changedTouches[0].clientX;
        const diff = touchStart - touchEnd;
        if (Math.abs(diff) > 100) { // Minimum swipe distance
          if (diff > 0) {
            navigateWeek('next');
          } else {
            navigateWeek('prev');
          }
        }
        setTouchStart(null);
      };

      // Long press handlers for Vital Rest
      const startLongPress = (dayIndex, callback) => {
        setLongPressProgress(0);
        const timer = setInterval(() => {
          setLongPressProgress(prev => {
            if (prev >= 100) {
              clearInterval(timer);
              callback(dayIndex);
              triggerHaptic('heavy');
              return 0;
            }
            return prev + 10;
          });
        }, 80); // 800ms total for full press
        setLongPressTimer(timer);
      };

      const cancelLongPress = () => {
        if (longPressTimer) {
          clearInterval(longPressTimer);
          setLongPressTimer(null);
        }
        setLongPressProgress(0);
      };

      useEffect(() => {
        const stored = loadFromStorage();
        if (stored) {
          // Check if we need to create new weeks for current date
          const updatedState = checkAndCreateNewWeeks(stored);
          setState(updatedState);
          // Save if new weeks were created
          if (updatedState.weeks.length !== stored.weeks.length) {
            saveToStorage(updatedState);
          }
        } else {
          const initial = initializeState();
          // Check for new weeks even on fresh init
          const updatedInitial = checkAndCreateNewWeeks(initial);
          setState(updatedInitial);
          saveToStorage(updatedInitial);

          const currentWeekData = updatedInitial.weeks[updatedInitial.currentWeek];
          const unfilledPastDays = currentWeekData.days.filter(d =>
            isPastDay(d.date) && !d.isFilled && !d.isOffDay
          );
          if (unfilledPastDays.length > 0) {
            setShowBackfillPrompt(true);
          }
        }

        // Load Google Sheets config
        try {
          const sheetsConfigStored = localStorage.getItem(SHEETS_CONFIG_KEY);
          if (sheetsConfigStored) {
            const config = JSON.parse(sheetsConfigStored);
            setSheetsConfig(config);
            setSyncStatus('synced');
          } else {
            // Prompt for Google Sheets setup on first load
            setTimeout(() => setShowSheetsModal(true), 1500);
          }
        } catch (e) {
          console.error('Failed to load sheets config:', e);
        }

        setIsLoaded(true);
      }, []);

      // Google Sheets sync function - PUSH to sheets
      const syncToGoogleSheets = async (data) => {
        if (!sheetsConfig || !sheetsConfig.webAppUrl) return;

        setSyncStatus('syncing');
        try {
          // Use fetch with no-cors for POST (we can't read response but it works)
          await fetch(sheetsConfig.webAppUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              data: data,
              deviceId: data.deviceId,
              timestamp: new Date().toISOString()
            })
          });
          setSyncStatus('synced');
          setLastSaved(Date.now());
        } catch (error) {
          console.error('Sync push failed:', error);
          setSyncStatus('error');
        }
      };

      // Fetch data FROM Google Sheets - PULL from sheets
      const fetchFromGoogleSheets = async () => {
        if (!sheetsConfig || !sheetsConfig.webAppUrl) return null;

        setSyncStatus('syncing');
        try {
          // For GET requests, we need to use a different approach due to CORS
          // Google Apps Script returns JSONP-compatible response
          const response = await fetch(sheetsConfig.webAppUrl, {
            method: 'GET',
            redirect: 'follow'
          });

          if (response.ok) {
            const result = await response.json();
            setSyncStatus('synced');
            if (result.success && result.data) {
              return result.data;
            }
          }
          return null;
        } catch (error) {
          console.error('Sync fetch failed:', error);
          setSyncStatus('error');
          return null;
        }
      };

      // Archive completed bonus tasks from a week (for historical tracking)
      const archiveWeekTasks = (weekIndex) => {
        const week = state.weeks[weekIndex];
        if (!week) return [];

        const archived = [];
        const weekStart = new Date(week.days[0].date);

        week.days.forEach((day, dayIdx) => {
          if (day.completedTasks && day.completedTasks.length > 0) {
            day.completedTasks.forEach(taskId => {
              const task = state.adHocTasks.find(t => t.id === taskId);
              if (task) {
                archived.push({
                  ...task,
                  completedDate: day.date,
                  weekNumber: weekIndex + 1,
                  dayOfWeek: new Date(day.date).toLocaleDateString('en-US', { weekday: 'short' })
                });
              }
            });
          }
        });

        return archived;
      };

      // Get archived tasks for current week view (safe access before loading check)
      const currentWeekArchivedTasks = state ? archiveWeekTasks(state.currentWeek) : [];

      // Manual sync button handler - pull from sheets and compare
      const manualSync = async () => {
        if (!sheetsConfig) {
          setShowSheetsModal(true);
          return;
        }

        const remoteData = await fetchFromGoogleSheets();
        if (remoteData && remoteData.lastModified) {
          // Compare timestamps
          if (remoteData.lastModified > (state?.lastModified || 0)) {
            // Remote is newer - ask user what to do
            setConflictData({ local: state, remote: remoteData });
            setShowConflictModal(true);
          } else {
            // Local is newer or same - push to sheets
            await syncToGoogleSheets(state);
            triggerHaptic('sparkle');
          }
        } else {
          // No remote data or couldn't fetch - just push
          await syncToGoogleSheets(state);
          triggerHaptic('sparkle');
        }
      };

      // Save sheets config
      const saveSheetsConfig = (config) => {
        try {
          localStorage.setItem(SHEETS_CONFIG_KEY, JSON.stringify(config));
          setSheetsConfig(config);
          setSyncStatus('synced');
          setShowSheetsModal(false);
        } catch (e) {
          console.error('Failed to save sheets config:', e);
        }
      };

      // Collision detection: check if another device/tab modified the data
      const checkForConflict = (newState) => {
        const storedRaw = localStorage.getItem(STORAGE_KEY);
        if (!storedRaw) return false;

        try {
          const stored = JSON.parse(storedRaw);
          // If stored version has a newer timestamp and different device ID, there's a conflict
          if (stored.lastModified && stored.deviceId &&
              stored.lastModified > (state?.lastModified || 0) &&
              stored.deviceId !== newState.deviceId) {
            return stored;
          }
        } catch (e) {
          console.error('Error checking for conflict:', e);
        }
        return false;
      };

      const saveState = (newState, forceOverwrite = false) => {
        // Update lastModified timestamp
        newState.lastModified = Date.now();
        newState.deviceId = state?.deviceId || newState.deviceId;

        // Check for conflicts (unless forcing overwrite)
        if (!forceOverwrite) {
          const conflict = checkForConflict(newState);
          if (conflict) {
            setConflictData({ local: newState, remote: conflict });
            setShowConflictModal(true);
            return; // Don't save until conflict is resolved
          }
        }

        setState(newState);
        saveToStorage(newState);
        setLastSaved(Date.now());

        // Also sync to Google Sheets if configured
        if (sheetsConfig && sheetsConfig.webAppUrl) {
          syncToGoogleSheets(newState);
        }
      };

      // Resolve conflict by choosing local or remote data
      const resolveConflict = (choice) => {
        if (choice === 'local' && conflictData?.local) {
          saveState(conflictData.local, true); // Force overwrite
        } else if (choice === 'remote' && conflictData?.remote) {
          setState(conflictData.remote);
          setLastSaved(Date.now());
        }
        setConflictData(null);
        setShowConflictModal(false);
      };

      const stats = useMemo(() => {
        if (!state) return null;
        const week = state.weeks[state.currentWeek];
        return calculateWeekStats(week, state.adHocTasks, state.streakDays);
      }, [state]);

      // Calculate sparkline data (7-day score trend)
      const sparklineData = useMemo(() => {
        if (!state || !stats) return [];
        const week = state.weeks[state.currentWeek];
        return week.days.map((day, idx) => {
          const score = calculateDailyScore(day, state.adHocTasks, week);
          const maxPossible = 21; // Rough max daily score
          return {
            score,
            percent: Math.min(100, (score / maxPossible) * 100),
            isFuture: isFutureDay(day.date),
            isToday: isSameDay(new Date(day.date), new Date())
          };
        });
      }, [state, stats]);

      // Calculate 30-day heatmap data (GitHub-style contribution graph)
      const heatmapData = useMemo(() => {
        if (!state) return [];
        const today = new Date();
        const data = [];

        // Go back 35 days to fill a 5-row x 7-col grid
        for (let i = 34; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split('T')[0];

          // Find this day in any week
          let dayData = null;
          let week = null;
          for (const w of state.weeks) {
            const found = w.days.find(d => d.date.split('T')[0] === dateStr);
            if (found) {
              dayData = found;
              week = w;
              break;
            }
          }

          let level = 0;
          let score = 0;
          if (dayData && !dayData.isOffDay) {
            score = calculateDailyScore(dayData, state.adHocTasks, week);
            // Map score to level 0-4
            if (score >= 18) level = 4;      // Elite day
            else if (score >= 14) level = 3; // Great day
            else if (score >= 10) level = 2; // Good day
            else if (score >= 5) level = 1;  // Some effort
            else level = 0;                   // Minimal
          } else if (dayData && dayData.isOffDay) {
            level = -1; // Off day marker
          }

          data.push({
            date: dateStr,
            level,
            score,
            isToday: i === 0,
            isFuture: date > today,
            isOffDay: dayData?.isOffDay || false
          });
        }
        return data;
      }, [state]);

      // Get tier class for dynamic background
      const getTierClass = () => {
        if (!stats) return '';
        switch(stats.tier.name) {
          case 'ELITE': return 'tier-elite';
          case 'SOLID': return 'tier-solid';
          case 'DECENT': return 'tier-decent';
          case 'STRUGGLING': return 'tier-struggling';
          case 'CRISIS': return 'tier-crisis';
          default: return '';
        }
      };

      if (!isLoaded || !state) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-950 via-indigo-950 to-slate-950 flex items-center justify-center">
            <div className="text-white text-2xl font-bold animate-pulse">Loading...</div>
          </div>
        );
      }

      const currentWeek = state.weeks[state.currentWeek];
      const today = new Date();
      const todayDay = currentWeek.days.find(d => isSameDay(new Date(d.date), today));

      const toggleHabit = (dayIndex, habitId) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;
        if (habitId === 'reading' || habitId === 'sleep') return; // These use separate inputs

        const habit = HABITS.find(h => h.id === habitId);
        if (!habit) return; // Safety check

        // Handle weekly habits - only allow toggle on one day per week
        if (habit.isWeekly) {
          const completionDayIdx = getWeeklyHabitCompletionDay(currentWeek, habitId);
          // If already completed on a different day, don't allow toggling here
          if (completionDayIdx !== -1 && completionDayIdx !== dayIndex) {
            return; // Already done this week on another day
          }
        }

        // Handle missing habit in old saved data
        const currentValue = day.habits[habitId] ?? 0;
        const newValue = currentValue === habit.points ? 0 : habit.points;

        // Haptic feedback based on habit importance
        if (newValue > 0) {
          if (habit.points >= 3) {
            triggerHaptic('heavy');  // Core habits (Dopamine Baseline)
          } else if (habit.points >= 2) {
            triggerHaptic('medium'); // Important habits
          } else {
            triggerHaptic('light');  // Regular habits
          }
        }

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].habits[habitId] = newValue;
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        if (habitId === 'nofap') {
          if (newValue === 3) {
            newState.streakDays++;
            if (newState.streakDays > newState.longestStreak) {
              newState.longestStreak = newState.streakDays;
            }
          } else {
            // Weekend Soft Landing: Sat/Sun failures only subtract 2 days
            // Weekday failures (Mon-Thu) reset streak to 0
            const dayDate = new Date(currentWeek.days[dayIndex].date);
            const dayOfWeek = dayDate.getDay();
            const isWeekendDay = dayOfWeek === 0 || dayOfWeek === 6; // Sun=0, Sat=6

            if (isWeekendDay) {
              // Soft landing: subtract 2 instead of full reset
              newState.streakDays = Math.max(0, newState.streakDays - 2);
            } else {
              // Weekday: full reset
              newState.streakDays = 0;
            }
          }
        }

        saveState(newState);
        setLastSaved(Date.now());
      };

      // Neural Reset function for Dopamine Baseline (long-press triggered)
      const triggerNeuralReset = (dayIndex, resetType) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].habits.nofap = 0;
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        if (resetType === 'soft') {
          // Soft reset: subtract 2 days (weekend maintenance mode)
          newState.streakDays = Math.max(0, newState.streakDays - 2);
        } else {
          // Hard reset: full streak reset to 0
          newState.streakDays = 0;
        }

        saveState(newState);
        setShowNeuralResetModal(false);
        setNeuralResetDayIndex(null);
        triggerHaptic('heavy');
      };

      const updateReading = (dayIndex, pages) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].pagesRead = Math.max(0, parseInt(pages) || 0);
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        saveState(newState);
      };

      const updateSleepTime = (dayIndex, time) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].sleepTime = time;
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        saveState(newState);
      };

      const updateProductivityRating = (dayIndex, rating) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        // Haptic feedback at each notch
        const tier = PRODUCTIVITY_TIERS[rating];
        if (rating === 4) {
          triggerHaptic('sparkle'); // Special for Flow State
        } else if (rating >= 3) {
          triggerHaptic('medium');
        } else {
          triggerHaptic('light');
        }

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].productivityRating = rating;
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        saveState(newState);
      };

      const toggleVitalRest = (dayIndex) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        // Check if already at max (2) vital rest days this week
        const restCount = countVitalRestDays(currentWeek);
        if (!day.isVitalRest && restCount >= 2) {
          alert('Maximum 2 Vital Rest days per week');
          return;
        }

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].isVitalRest = !day.isVitalRest;
        // If marking as vital rest, clear gym habit (it's auto-awarded)
        if (newState.weeks[state.currentWeek].days[dayIndex].isVitalRest) {
          newState.weeks[state.currentWeek].days[dayIndex].habits.gym = 0;
        }
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        saveState(newState);
      };

      // Check if a day was backfilled (updated more than 24h after the day's date)
      const isBackfilled = (day) => {
        if (!day.lastUpdated) return false;
        const dayDate = new Date(day.date);
        const updateDate = new Date(day.lastUpdated);
        const hoursDiff = (updateDate - dayDate) / (1000 * 60 * 60);
        return hoursDiff > 24;
      };

      const toggleOffDay = (dayIndex) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked) return;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].isOffDay = !day.isOffDay;
        if (newState.weeks[state.currentWeek].days[dayIndex].isOffDay) {
          newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        }
        saveState(newState);
      };

      const toggleLock = (dayIndex) => {
        const day = currentWeek.days[dayIndex];
        if (day.isOffDay) return;
        if (!day.isFilled && !day.isLocked) {
          alert('Fill in data before locking this day');
          return;
        }

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].isLocked = !day.isLocked;
        saveState(newState);
      };

      const toggleTask = (dayIndex, taskId) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        const newState = JSON.parse(JSON.stringify(state));
        const completedTasks = newState.weeks[state.currentWeek].days[dayIndex].completedTasks;

        if (completedTasks.includes(taskId)) {
          newState.weeks[state.currentWeek].days[dayIndex].completedTasks =
            completedTasks.filter(id => id !== taskId);
        } else {
          newState.weeks[state.currentWeek].days[dayIndex].completedTasks.push(taskId);
          triggerHaptic('sparkle'); // Special sparkle vibration for bonus tasks
        }

        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        saveState(newState);
        setLastSaved(Date.now());
      };

      const addTask = (name, points) => {
        const newState = JSON.parse(JSON.stringify(state));
        newState.adHocTasks.push({
          id: Date.now().toString(),
          name,
          points
        });
        saveState(newState);
        setShowTaskModal(false);
      };

      const deleteTask = (taskId) => {
        const newState = JSON.parse(JSON.stringify(state));
        newState.adHocTasks = newState.adHocTasks.filter(t => t.id !== taskId);

        newState.weeks.forEach(week => {
          week.days.forEach(day => {
            day.completedTasks = day.completedTasks.filter(id => id !== taskId);
          });
        });

        saveState(newState);
      };

      // ========== SCREEN TIMER FUNCTIONS ==========

      // Start the screen timer
      const startTimer = (mode) => {
        setTimerMode(mode);
        setTimerStartTime(Date.now());
        setTimerElapsed(0);
        setTimerRunning(true);
        triggerHaptic('medium');
      };

      // Stop the screen timer and record the session
      const stopTimer = () => {
        if (!timerRunning || !timerStartTime) return;

        const endTime = Date.now();
        const durationMinutes = Math.floor((endTime - timerStartTime) / 60000);

        if (durationMinutes > 0 && state) {
          // Find today's day
          const currentWeek = state.weeks[state.currentWeek];
          const today = new Date();
          const todayIdx = currentWeek.days.findIndex(d => isSameDay(new Date(d.date), today));

          if (todayIdx !== -1) {
            const newState = JSON.parse(JSON.stringify(state));
            const day = newState.weeks[state.currentWeek].days[todayIdx];

            // Initialize screenTime if missing (backward compat)
            if (!day.screenTime) {
              day.screenTime = { educational: 0, entertainment: 0, sessions: [] };
            }

            // Add to appropriate category
            if (timerMode === 'educational') {
              day.screenTime.educational = (day.screenTime.educational || 0) + durationMinutes;
            } else {
              day.screenTime.entertainment = (day.screenTime.entertainment || 0) + durationMinutes;
            }

            // Record session
            day.screenTime.sessions = day.screenTime.sessions || [];
            day.screenTime.sessions.push({
              mode: timerMode,
              startTime: new Date(timerStartTime).toISOString(),
              endTime: new Date(endTime).toISOString(),
              duration: durationMinutes
            });

            day.isFilled = true;
            day.lastUpdated = new Date().toISOString();

            saveState(newState);
          }
        }

        // Reset timer state
        setTimerRunning(false);
        setTimerStartTime(null);
        setTimerElapsed(0);
        triggerHaptic('sparkle');
      };

      // Format seconds to MM:SS or HH:MM:SS
      const formatTimerDisplay = (seconds) => {
        const hrs = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        if (hrs > 0) {
          return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      };

      // Get today's screen time stats
      const getTodayScreenTime = () => {
        if (!state) return { educational: 0, entertainment: 0, quotaRemaining: 90, isOverQuota: false };

        const currentWeek = state.weeks[state.currentWeek];
        const today = new Date();
        const todayDay = currentWeek.days.find(d => isSameDay(new Date(d.date), today));

        if (!todayDay || !todayDay.screenTime) {
          return { educational: 0, entertainment: 0, quotaRemaining: 90, isOverQuota: false };
        }

        const educational = todayDay.screenTime.educational || 0;
        const entertainment = todayDay.screenTime.entertainment || 0;
        const quotaRemaining = Math.max(0, SCREEN_QUOTA.ENTERTAINMENT_DAILY_LIMIT - entertainment);
        const isOverQuota = entertainment > SCREEN_QUOTA.ENTERTAINMENT_DAILY_LIMIT;

        return { educational, entertainment, quotaRemaining, isOverQuota };
      };

      const switchViewMode = (mode) => {
        const newState = JSON.parse(JSON.stringify(state));
        newState.viewMode = mode;
        saveState(newState);
      };

      // Filter out future days - they serve no purpose
      const daysToShow = state.viewMode === 'today'
        ? (todayDay ? [todayDay] : [])
        : currentWeek.days.filter(day => !isFutureDay(day.date));

      // Check if viewing a past (sealed) week
      const isViewingPastWeek = (() => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const weekEndDate = new Date(currentWeek.days[6].date);
        weekEndDate.setHours(23, 59, 59, 999);
        return today > weekEndDate;
      })();

      // Calculate week stats for display
      const calculateWeekMetrics = (week) => {
        let totalPages = 0;
        let sleepTimes = [];
        let mealsLogged = 0;
        let totalMeals = 0;
        let activeDays = 0;

        week.days.forEach(day => {
          if (day.isOffDay || isFutureDay(day.date)) return;
          activeDays++;

          // Knowledge Velocity (total pages)
          totalPages += day.pagesRead || 0;

          // Sleep times for average
          if (day.sleepTime) {
            const [hours, mins] = day.sleepTime.split(':').map(Number);
            let totalMins = hours * 60 + mins;
            if (hours < 6) totalMins += 24 * 60; // After midnight adjustment
            sleepTimes.push(totalMins);
          }

          // Nutrition compliance
          if (day.habits.lunch > 0) mealsLogged++;
          if (day.habits.dinner > 0) mealsLogged++;
          totalMeals += 2;
        });

        const avgSleepMins = sleepTimes.length > 0
          ? Math.round(sleepTimes.reduce((a, b) => a + b, 0) / sleepTimes.length)
          : null;

        const avgSleepFormatted = avgSleepMins
          ? `${Math.floor((avgSleepMins % (24 * 60)) / 60)}:${String(avgSleepMins % 60).padStart(2, '0')}`
          : 'N/A';

        const nutritionPercent = totalMeals > 0
          ? Math.round((mealsLogged / totalMeals) * 100)
          : 0;

        return {
          knowledgeVelocity: totalPages,
          avgSleep: avgSleepFormatted,
          avgSleepMins,
          nutritionCompliance: nutritionPercent,
          activeDays
        };
      };

      const currentWeekMetrics = calculateWeekMetrics(currentWeek);

      // Week-over-Week delta (compare with previous week if exists)
      const previousWeekMetrics = state.currentWeek > 0
        ? calculateWeekMetrics(state.weeks[state.currentWeek - 1])
        : null;

      const wowDelta = previousWeekMetrics ? {
        pagesDelta: currentWeekMetrics.knowledgeVelocity - previousWeekMetrics.knowledgeVelocity,
        sleepDelta: currentWeekMetrics.avgSleepMins && previousWeekMetrics.avgSleepMins
          ? currentWeekMetrics.avgSleepMins - previousWeekMetrics.avgSleepMins
          : null,
        nutritionDelta: currentWeekMetrics.nutritionCompliance - previousWeekMetrics.nutritionCompliance
      } : null;

      // Week navigation
      const navigateWeek = (direction) => {
        const newState = JSON.parse(JSON.stringify(state));
        if (direction === 'prev' && state.currentWeek > 0) {
          newState.currentWeek = state.currentWeek - 1;
          newState.viewMode = 'all-days'; // Switch to all-days when viewing past weeks
          saveState(newState);
          triggerHaptic('light');
        } else if (direction === 'next' && state.currentWeek < state.weeks.length - 1) {
          newState.currentWeek = state.currentWeek + 1;
          saveState(newState);
          triggerHaptic('light');
        }
      };

      // Jump to specific week
      const jumpToWeek = (weekIndex) => {
        if (weekIndex >= 0 && weekIndex < state.weeks.length) {
          const newState = JSON.parse(JSON.stringify(state));
          newState.currentWeek = weekIndex;
          if (weekIndex < state.weeks.length - 1) {
            newState.viewMode = 'all-days'; // Past weeks show all days
          }
          saveState(newState);
          triggerHaptic('light');
        }
      };

      return (
        <div
          className={`min-h-screen bg-gradient-to-br from-slate-950 via-indigo-950 to-slate-950 text-white ${getTierClass()} ${stealthMode ? 'stealth-mode' : ''}`}
          onTouchStart={handleTouchStart}
          onTouchEnd={(e) => handleTouchEnd(e, navigateWeek)}
        >
          <div className="container mx-auto px-4 py-8 max-w-2xl">
            {/* Header */}
            <div className="text-center mb-8 animate-slide-in relative">
              {/* Stealth Mode Toggle (left) */}
              <button
                onClick={() => {
                  setStealthMode(!stealthMode);
                  triggerHaptic('sparkle');
                }}
                className={`absolute left-0 top-0 w-10 h-10 rounded-full glass flex items-center justify-center transition-all ${stealthMode ? 'bg-purple-500/30 text-white' : 'text-purple-300 hover:bg-white/10'}`}
                title="Stealth Mode"
              >
                {stealthMode ? 'â—ˆ' : 'â—‡'}
              </button>

              {/* Info Button (right) */}
              <button
                onClick={() => setShowInfoModal(true)}
                className="absolute right-0 top-0 w-10 h-10 rounded-full glass flex items-center justify-center text-purple-300 hover:bg-white/10 transition-all"
              >
                ?
              </button>

              <h1 className="text-3xl sm:text-4xl font-black mb-1 bg-gradient-to-r from-violet-300 via-fuchsia-300 to-violet-300 bg-clip-text text-transparent">
                {stealthMode ? 'SYSTEM TRACKER' : 'DISCIPLINE'}
              </h1>
              <p className="text-purple-400 text-xs mono">{stealthMode ? 'Protocol Active' : 'Level Up or Pay Up'}</p>
            </div>

            {/* Week Navigator - Compact */}
            {state.weeks.length > 1 && (
              <div className="flex items-center justify-center gap-3 mb-4 animate-slide-in">
                <button
                  onClick={() => navigateWeek('prev')}
                  disabled={state.currentWeek === 0}
                  className={`p-2 rounded-lg transition-all ${state.currentWeek === 0 ? 'opacity-30 cursor-not-allowed' : 'bg-white/10 hover:bg-white/20'}`}
                >â†</button>

                <div className="flex gap-1 overflow-x-auto">
                  {state.weeks.map((week, idx) => {
                    const isCurrentView = idx === state.currentWeek;
                    const isMostRecent = idx === state.weeks.length - 1;
                    return (
                      <button
                        key={idx}
                        onClick={() => jumpToWeek(idx)}
                        className={`w-8 h-8 rounded-full text-xs font-bold transition-all ${
                          isCurrentView
                            ? 'bg-purple-600 text-white'
                            : isMostRecent
                            ? 'bg-emerald-600/30 text-emerald-300'
                            : 'bg-white/10 text-purple-400'
                        }`}
                      >
                        {idx + 1}
                      </button>
                    );
                  })}
                </div>

                <button
                  onClick={() => navigateWeek('next')}
                  disabled={state.currentWeek === state.weeks.length - 1}
                  className={`p-2 rounded-lg transition-all ${state.currentWeek === state.weeks.length - 1 ? 'opacity-30 cursor-not-allowed' : 'bg-white/10 hover:bg-white/20'}`}
                >â†’</button>

                {isViewingPastWeek && (
                  <span className="px-2 py-1 bg-amber-500/20 text-amber-300 rounded-full text-[10px]">
                    ðŸ”’ Sealed
                  </span>
                )}
              </div>
            )}

            {/* Sealed Week Watermark */}
            {isViewingPastWeek && (
              <div className="text-center mb-4 text-amber-400/60 text-sm">
                âš ï¸ Viewing historical data - Changes disabled
              </div>
            )}

            {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                SMART CONTEXT COMMAND CENTER - Adaptive State-Based Dashboard
                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
            {(() => {
              // State-based styling
              const tierState = stats.tier.name.toLowerCase();
              const progressPercent = Math.min(100, Math.max(0, (stats.effectiveScore / 94) * 100));

              // Calculate points to next tier
              const getNextTierInfo = () => {
                if (stats.effectiveScore >= 94) return { name: 'ELITE', pts: 0, text: 'MAXED OUT' };
                if (stats.effectiveScore >= 83) return { name: 'ELITE', pts: 94 - stats.effectiveScore, text: `+${94 - stats.effectiveScore} to ELITE` };
                if (stats.effectiveScore >= 70) return { name: 'SOLID', pts: 83 - stats.effectiveScore, text: `+${83 - stats.effectiveScore} to SOLID` };
                if (stats.effectiveScore >= 55) return { name: 'DECENT', pts: 70 - stats.effectiveScore, text: `+${70 - stats.effectiveScore} to escape penalty` };
                return { name: 'STRUGGLING', pts: 55 - stats.effectiveScore, text: `+${55 - stats.effectiveScore} to STRUGGLING` };
              };
              const nextTier = getNextTierInfo();

              // Count leaks
              const leakCount = (stats.mealPenalty > 0 ? 1 : 0) +
                currentWeek.days.filter(day =>
                  !isFutureDay(day.date) && !day.isOffDay && day.sleepTime && !isWeekendDay(day.date) &&
                  (() => {
                    const [hours] = day.sleepTime.split(':').map(Number);
                    return (hours < 6 ? hours + 24 : hours) >= 23;
                  })()
                ).length;

              return (
                <div className={`command-center glass p-4 mb-6 animate-slide-in state-${tierState}`}>
                  {/* Top Row: Week + Tier Label + Sync */}
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                      <span className="text-sm font-bold text-purple-300">W{state.currentWeek + 1}</span>
                      <span className="text-purple-500">â€¢</span>
                      <span className={`text-sm font-bold ${
                        tierState === 'elite' ? 'text-amber-400' :
                        tierState === 'solid' ? 'text-blue-400' :
                        tierState === 'decent' ? 'text-green-400' :
                        tierState === 'struggling' ? 'text-orange-400' :
                        'text-red-400'
                      }`}>
                        {stats.tier.icon} {stats.tier.name}
                      </span>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className={`sync-dot ${sheetsConfig ? 'connected' : 'disconnected'}`}></span>
                      <span className="text-[10px] text-purple-400">{sheetsConfig ? 'Synced' : 'Local'}</span>
                    </div>
                  </div>

                  {/* Progress Bar with Score */}
                  <div className="mb-3">
                    <div className="progress-track relative">
                      <div
                        className={`progress-fill ${tierState}`}
                        style={{ width: `${progressPercent}%` }}
                      ></div>
                      {/* Tier markers */}
                      <div className="progress-markers">
                        <div className="progress-marker" style={{ left: '58.5%' }} title="70 - Decent"></div>
                        <div className="progress-marker" style={{ left: '88.3%' }} title="83 - Solid"></div>
                      </div>
                    </div>
                    <div className="flex justify-between items-center mt-2">
                      <span className="text-2xl font-black mono">{stats.effectiveScore}</span>
                      <span className="text-xs text-purple-400">/ 94</span>
                      <span className={`text-xs ${stats.tier.penalty ? 'text-red-400' : 'text-emerald-400'}`}>
                        {nextTier.text}
                      </span>
                    </div>
                  </div>

                  {/* Stat Pills Row */}
                  <div className="flex flex-wrap justify-center gap-2">
                    <div
                      className="stat-pill cursor-pointer"
                      onClick={() => setShowStreakDrilldown(true)}
                    >
                      <span>ðŸ”¥</span>
                      <span className="font-bold">{state.streakDays}</span>
                      <span className="text-purple-400 text-[10px]">streak</span>
                    </div>

                    <div className="stat-pill">
                      <span>ðŸ’°</span>
                      <span className="font-bold text-emerald-400">${state.guiltFreeBalance}</span>
                      <span className="text-purple-400 text-[10px]">earned</span>
                    </div>

                    {leakCount > 0 && (
                      <div className="stat-pill bg-red-500/20">
                        <span>âš ï¸</span>
                        <span className="font-bold text-red-400">{leakCount}</span>
                        <span className="text-red-300 text-[10px]">leak{leakCount > 1 ? 's' : ''}</span>
                      </div>
                    )}

                    {state.nreBalance > 0 && (
                      <div className="stat-pill bg-red-500/10">
                        <span className="text-red-400 text-[10px]">NRE</span>
                        <span className="font-bold text-red-400">${state.nreBalance}</span>
                      </div>
                    )}
                  </div>

                  {/* Crisis Mode Warning */}
                  {stats.tier.penalty && (
                    <div className="mt-3 pt-3 border-t border-red-500/30 text-center">
                      <span className="text-red-400 text-sm font-bold animate-pulse">
                        âš ï¸ -${stats.tier.penalty} PENALTY ACTIVE
                      </span>
                    </div>
                  )}

                  {/* Elite Mode Celebration */}
                  {stats.tier.name === 'ELITE' && (
                    <div className="mt-3 pt-3 border-t border-amber-500/30 text-center">
                      <span className="text-amber-400 text-sm font-bold">
                        ðŸ‘‘ ELITE STATUS ACHIEVED
                      </span>
                    </div>
                  )}
                </div>
              );
            })()}

            {/* Streak Drill-Down Modal */}
            {showStreakDrilldown && (
              <div className="modal-overlay" onClick={() => setShowStreakDrilldown(false)}>
                <div className="glass rounded-2xl p-6 max-w-sm w-full" onClick={(e) => e.stopPropagation()}>
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-bold">Streak History</h3>
                    <button
                      onClick={() => setShowStreakDrilldown(false)}
                      className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center"
                    >Ã—</button>
                  </div>

                  <div className="grid grid-cols-2 gap-4 mb-4">
                    <div className="glass rounded-xl p-4 text-center">
                      <div className="text-3xl mb-1">ðŸ”¥</div>
                      <div className="text-2xl font-black">{state.streakDays}</div>
                      <div className="text-xs text-purple-300">Current</div>
                    </div>
                    <div className="glass rounded-xl p-4 text-center">
                      <div className="text-3xl mb-1">ðŸ†</div>
                      <div className="text-2xl font-black">{state.longestStreak}</div>
                      <div className="text-xs text-purple-300">Best</div>
                    </div>
                  </div>

                  <button
                    onClick={() => setShowStreakDrilldown(false)}
                    className="w-full py-2 rounded-lg font-semibold bg-purple-600 hover:bg-purple-500"
                  >Close</button>
                </div>
              </div>
            )}

            {/* Neural Reset Modal */}
            {showNeuralResetModal && neuralResetDayIndex !== null && (
              <div className="modal-overlay" onClick={() => { setShowNeuralResetModal(false); setNeuralResetDayIndex(null); }}>
                <div className="glass rounded-2xl p-6 max-w-sm w-full" onClick={(e) => e.stopPropagation()}>
                  <div className="text-center mb-6">
                    <div className="text-5xl mb-3">ðŸ§ </div>
                    <h3 className="text-xl font-bold mb-2">Initiate Neural Reset?</h3>
                    <p className="text-sm text-purple-300">
                      This will mark today as a relapse and affect your streak.
                    </p>
                  </div>

                  <div className="space-y-3">
                    {/* Soft Reset - Weekend Only */}
                    {(() => {
                      const dayDate = new Date(currentWeek.days[neuralResetDayIndex]?.date);
                      const dayOfWeek = dayDate.getDay();
                      const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                      return isWeekend ? (
                        <button
                          onClick={() => triggerNeuralReset(neuralResetDayIndex, 'soft')}
                          className="w-full py-3 px-4 rounded-xl font-semibold bg-gradient-to-r from-amber-600 to-orange-600 text-white text-left"
                        >
                          <div className="flex items-center gap-3">
                            <span className="text-2xl">ðŸ›¡ï¸</span>
                            <div>
                              <div className="text-sm font-bold">Soft Reset</div>
                              <div className="text-xs opacity-80">Weekend Mode: -2 days only</div>
                            </div>
                          </div>
                        </button>
                      ) : null;
                    })()}

                    {/* Hard Reset */}
                    <button
                      onClick={() => triggerNeuralReset(neuralResetDayIndex, 'hard')}
                      className="w-full py-3 px-4 rounded-xl font-semibold bg-gradient-to-r from-red-600 to-rose-700 text-white text-left"
                    >
                      <div className="flex items-center gap-3">
                        <span className="text-2xl">ðŸ’¥</span>
                        <div>
                          <div className="text-sm font-bold">Hard Reset</div>
                          <div className="text-xs opacity-80">Full streak reset to zero</div>
                        </div>
                      </div>
                    </button>

                    {/* Cancel */}
                    <button
                      onClick={() => { setShowNeuralResetModal(false); setNeuralResetDayIndex(null); }}
                      className="w-full py-3 rounded-xl font-semibold bg-white/10 hover:bg-white/20 text-purple-300"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* View Mode Toggle */}
            <div className="flex gap-2 mb-6 animate-slide-in">
              <button
                onClick={() => switchViewMode('today')}
                className={`flex-1 py-3 rounded-xl font-bold transition-all text-sm ${
                  state.viewMode === 'today'
                    ? 'bg-gradient-to-r from-violet-600 to-indigo-600 text-white'
                    : 'glass text-purple-300 hover:bg-white/10'
                }`}
              >
                Today
              </button>
              <button
                onClick={() => switchViewMode('all-days')}
                className={`flex-1 py-3 rounded-xl font-bold transition-all text-sm ${
                  state.viewMode === 'all-days'
                    ? 'bg-gradient-to-r from-violet-600 to-indigo-600 text-white'
                    : 'glass text-purple-300 hover:bg-white/10'
                }`}
              >
                Days
              </button>
              <button
                onClick={() => switchViewMode('grid')}
                className={`flex-1 py-3 rounded-xl font-bold transition-all text-sm ${
                  state.viewMode === 'grid'
                    ? 'bg-gradient-to-r from-violet-600 to-indigo-600 text-white'
                    : 'glass text-purple-300 hover:bg-white/10'
                }`}
              >
                Matrix
              </button>
            </div>

            {/* Weekly Matrix Grid View */}
            {state.viewMode === 'grid' && (
              <div className="glass rounded-xl p-4 mb-6 animate-slide-in">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold text-purple-200">Weekly Performance Matrix</h3>
                  <div className="text-xs text-purple-400 mono">
                    Week {state.currentWeek + 1}
                  </div>
                </div>

                <div className="weekly-matrix">
                  <table className="matrix-table w-full">
                    <thead>
                      <tr>
                        <th className="matrix-cell matrix-header matrix-habit-name">Habit</th>
                        {currentWeek.days.map((day, idx) => {
                          const date = new Date(day.date);
                          const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                          const isToday = isSameDay(date, new Date());
                          const isFuture = isFutureDay(day.date);
                          return (
                            <th
                              key={idx}
                              className={`matrix-cell matrix-header ${isToday ? 'matrix-today-col' : ''} ${isFuture ? 'opacity-40' : ''}`}
                            >
                              <div className="font-bold">{dayNames[date.getDay()]}</div>
                              <div className="text-[9px] opacity-70">{date.getDate()}</div>
                            </th>
                          );
                        })}
                        <th className="matrix-cell matrix-header">Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {/* Habit Rows */}
                      {HABITS.map((habit, habitIdx) => {
                        // Determine tier marker color
                        let tierMarker = 5; // default maintenance
                        if (habitIdx < 3) tierMarker = 1; // Morning habits
                        else if (habitIdx < 7) tierMarker = 2; // Nutrition (lunch, dinner, diet, weight)
                        else if (habitIdx < 9) tierMarker = 3; // Physical (gym, yoga)
                        else if (habitIdx < 15) tierMarker = 4; // Mind (meditation, prayer, journal, therapy, reading, career)

                        // Calculate habit total for the week
                        let habitWeekTotal = 0;

                        return (
                          <tr key={habit.id} className="matrix-habit-row">
                            <td className="matrix-cell matrix-habit-name">
                              <span className={`tier-marker tier-marker-${tierMarker}`} />
                              <span className="habit-icon mr-1">{stealthMode ? habit.stealthIcon : habit.icon}</span>
                              <span>{stealthMode ? habit.stealthName : habit.name}</span>
                            </td>
                            {currentWeek.days.map((day, dayIdx) => {
                              const isToday = isSameDay(new Date(day.date), new Date());
                              const isFuture = isFutureDay(day.date);
                              const isWeekend = isWeekendDay(day.date);

                              if (day.isOffDay) {
                                return (
                                  <td key={dayIdx} className={`matrix-cell matrix-off-day ${isToday ? 'matrix-today-col' : ''}`}>
                                    -
                                  </td>
                                );
                              }

                              if (isFuture) {
                                return (
                                  <td key={dayIdx} className={`matrix-cell matrix-future ${isToday ? 'matrix-today-col' : ''}`}>
                                    -
                                  </td>
                                );
                              }

                              let cellValue = 0;
                              let cellDisplay = '';
                              let cellClass = 'matrix-score-zero';

                              // Handle special habits
                              if (habit.id === 'sleep') {
                                cellValue = calculateSleepPoints(day.sleepTime, isWeekend);
                                cellDisplay = cellValue >= 0 ? `+${cellValue}` : cellValue;
                                if (cellValue >= 2) cellClass = 'matrix-score-full';
                                else if (cellValue >= 1) cellClass = 'matrix-score-partial';
                                else if (cellValue < 0) cellClass = 'matrix-score-negative';
                              } else if (habit.id === 'reading') {
                                cellValue = calculateReadingPoints(day.pagesRead);
                                cellDisplay = `+${cellValue}`;
                                if (cellValue >= 7) cellClass = 'matrix-score-full';      // 51+ pages
                                else if (cellValue >= 2) cellClass = 'matrix-score-partial'; // 16+ pages
                              } else if (habit.id === 'gym' && day.isVitalRest) {
                                cellValue = 1;
                                cellDisplay = 'R';
                                cellClass = 'matrix-score-partial';
                              } else if (habit.isWeekly) {
                                // Weekly habit: Show where it was completed
                                const weeklyComplete = isWeeklyHabitComplete(currentWeek, habit.id);
                                const completionDayIdx = getWeeklyHabitCompletionDay(currentWeek, habit.id);
                                const isCompletedOnThisDay = completionDayIdx === dayIdx;

                                if (isCompletedOnThisDay) {
                                  cellValue = habit.points;
                                  cellDisplay = `+${habit.points}`;
                                  cellClass = 'matrix-score-full';
                                } else if (weeklyComplete) {
                                  cellValue = 0; // Don't double count
                                  cellDisplay = 'âœ“';
                                  cellClass = 'matrix-score-partial';
                                } else {
                                  cellValue = 0;
                                  cellDisplay = '-';
                                  cellClass = 'matrix-score-zero';
                                }
                              } else {
                                cellValue = day.habits[habit.id] ?? 0;
                                cellDisplay = cellValue > 0 ? `+${cellValue}` : '0';
                                cellClass = cellValue >= habit.points ? 'matrix-score-full' : cellValue > 0 ? 'matrix-score-partial' : 'matrix-score-zero';
                              }

                              habitWeekTotal += cellValue;

                              return (
                                <td
                                  key={dayIdx}
                                  className={`matrix-cell ${cellClass} ${isToday ? 'matrix-today-col' : ''}`}
                                  title={`${habit.name}: ${cellValue} pts`}
                                >
                                  {cellDisplay}
                                </td>
                              );
                            })}
                            <td className="matrix-cell matrix-total-row">
                              {(() => {
                                // Recalculate for the total column
                                let total = 0;
                                currentWeek.days.forEach(day => {
                                  if (day.isOffDay || isFutureDay(day.date)) return;
                                  const isWeekend = isWeekendDay(day.date);
                                  if (habit.id === 'sleep') {
                                    total += calculateSleepPoints(day.sleepTime, isWeekend);
                                  } else if (habit.id === 'reading') {
                                    total += calculateReadingPoints(day.pagesRead);
                                  } else if (habit.id === 'gym' && day.isVitalRest) {
                                    total += 1;
                                  } else if (habit.isWeekly) {
                                    // Weekly habits only count once - check if this is completion day
                                    const completionDayIdx = getWeeklyHabitCompletionDay(currentWeek, habit.id);
                                    const thisDayIdx = currentWeek.days.findIndex(d => d === day);
                                    if (completionDayIdx === thisDayIdx) {
                                      total += habit.points;
                                    }
                                  } else {
                                    total += day.habits[habit.id] ?? 0;
                                  }
                                });
                                return total;
                              })()}
                            </td>
                          </tr>
                        );
                      })}

                      {/* Productivity Rating Row */}
                      <tr className="matrix-habit-row">
                        <td className="matrix-cell matrix-habit-name">
                          <span className="tier-marker tier-marker-4" />
                          <span className="habit-icon mr-1">ðŸ§ </span>
                          <span>Productivity</span>
                        </td>
                        {currentWeek.days.map((day, dayIdx) => {
                          const isToday = isSameDay(new Date(day.date), new Date());
                          const isFuture = isFutureDay(day.date);

                          if (day.isOffDay) {
                            return (
                              <td key={dayIdx} className={`matrix-cell matrix-off-day ${isToday ? 'matrix-today-col' : ''}`}>
                                -
                              </td>
                            );
                          }

                          if (isFuture) {
                            return (
                              <td key={dayIdx} className={`matrix-cell matrix-future ${isToday ? 'matrix-today-col' : ''}`}>
                                -
                              </td>
                            );
                          }

                          // Productivity only on workdays (not Sat/Sun)
                          if (isNonWorkDay(day.date)) {
                            return (
                              <td key={dayIdx} className={`matrix-cell matrix-score-zero ${isToday ? 'matrix-today-col' : ''}`} title="No work on weekends">
                                -
                              </td>
                            );
                          }

                          const rating = day.productivityRating;
                          const hasRating = rating !== null && rating !== undefined;
                          const tier = hasRating ? PRODUCTIVITY_TIERS[rating] : null;

                          let cellClass = 'matrix-score-zero';
                          if (hasRating) {
                            if (rating >= 4) cellClass = 'matrix-score-full';
                            else if (rating >= 3) cellClass = 'matrix-score-full';
                            else if (rating >= 2) cellClass = 'matrix-score-partial';
                            else if (rating >= 1) cellClass = 'matrix-score-partial';
                            else cellClass = 'matrix-score-negative';
                          }

                          return (
                            <td
                              key={dayIdx}
                              className={`matrix-cell ${cellClass} ${isToday ? 'matrix-today-col' : ''}`}
                              title={hasRating ? `${tier.name}: ${tier.points} pts` : 'Not rated'}
                            >
                              {hasRating ? (rating === 4 ? 'ðŸ’Ž' : `+${tier.points}`) : '-'}
                            </td>
                          );
                        })}
                        <td className="matrix-cell matrix-total-row">
                          {(() => {
                            let total = 0;
                            currentWeek.days.forEach(day => {
                              if (day.isOffDay || isFutureDay(day.date) || isNonWorkDay(day.date)) return;
                              if (day.productivityRating !== null && day.productivityRating !== undefined) {
                                total += PRODUCTIVITY_TIERS[day.productivityRating].points;
                              }
                            });
                            return total;
                          })()}
                        </td>
                      </tr>

                      {/* Daily Totals Row */}
                      <tr className="matrix-total-row">
                        <td className="matrix-cell matrix-habit-name font-bold">
                          DAILY TOTAL
                        </td>
                        {currentWeek.days.map((day, dayIdx) => {
                          const isToday = isSameDay(new Date(day.date), new Date());
                          const isFuture = isFutureDay(day.date);

                          if (day.isOffDay) {
                            return (
                              <td key={dayIdx} className={`matrix-cell matrix-off-day ${isToday ? 'matrix-today-col' : ''}`}>
                                OFF
                              </td>
                            );
                          }

                          if (isFuture) {
                            return (
                              <td key={dayIdx} className={`matrix-cell matrix-future ${isToday ? 'matrix-today-col' : ''}`}>
                                -
                              </td>
                            );
                          }

                          const dayScore = calculateDailyScore(day, state.adHocTasks, currentWeek);
                          return (
                            <td
                              key={dayIdx}
                              className={`matrix-cell font-bold ${isToday ? 'matrix-today-col' : ''} ${
                                dayScore >= 18 ? 'text-green-400' :
                                dayScore >= 12 ? 'text-blue-400' :
                                dayScore >= 8 ? 'text-yellow-400' : 'text-red-400'
                              }`}
                            >
                              {dayScore}
                            </td>
                          );
                        })}
                        <td className="matrix-cell font-bold text-purple-300">
                          {stats.effectiveScore}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                {/* Matrix Legend */}
                <div className="mt-4 flex flex-wrap gap-3 justify-center text-[10px]">
                  <div className="flex items-center gap-1">
                    <div className="w-4 h-4 rounded matrix-score-full" />
                    <span className="text-purple-300">Full</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <div className="w-4 h-4 rounded matrix-score-partial" />
                    <span className="text-purple-300">Partial</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <div className="w-4 h-4 rounded matrix-score-zero" />
                    <span className="text-purple-300">Missed</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <div className="w-4 h-4 rounded matrix-score-negative" />
                    <span className="text-purple-300">Penalty</span>
                  </div>
                </div>

                {/* Tier Legend */}
                <div className="mt-3 flex flex-wrap gap-3 justify-center text-[10px] border-t border-purple-500/20 pt-3">
                  <div className="flex items-center gap-1">
                    <span className="tier-marker tier-marker-1" />
                    <span className="text-purple-400">Neural</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <span className="tier-marker tier-marker-2" />
                    <span className="text-purple-400">Nutrition</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <span className="tier-marker tier-marker-3" />
                    <span className="text-purple-400">Physical</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <span className="tier-marker tier-marker-4" />
                    <span className="text-purple-400">Mind</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <span className="tier-marker tier-marker-5" />
                    <span className="text-purple-400">Maintenance</span>
                  </div>
                </div>
              </div>
            )}

            {/* Days Display (List View) */}
            {state.viewMode !== 'grid' && (
            <div className="space-y-4">
              {daysToShow.map((day, dayIndex) => {
                const actualDayIndex = state.viewMode === 'today'
                  ? currentWeek.days.findIndex(d => d.date === day.date)
                  : dayIndex;

                const isPast = isPastDay(day.date);
                const isToday = todayDay && day.date === todayDay.date;
                const isFuture = isFutureDay(day.date);
                const needsBackfill = isPast && !day.isFilled && !day.isOffDay;

                const dayScore = calculateDailyScore(day, state.adHocTasks, currentWeek);

                const wasBackfilled = isBackfilled(day);

                let badge = null;
                let badgeColor = '';
                if (isFuture) {
                  badge = 'Future';
                  badgeColor = 'text-purple-400';
                } else if (isToday) {
                  badge = 'TODAY';
                  badgeColor = 'text-cyan-400 font-bold';
                } else if (needsBackfill) {
                  badge = 'Missing Data';
                  badgeColor = 'text-amber-400';
                } else if (day.isLocked) {
                  badge = wasBackfilled ? 'Locked (Backfilled)' : 'Locked';
                  badgeColor = 'text-blue-400';
                } else if (day.isFilled) {
                  badge = wasBackfilled ? 'Backfilled' : 'Filled';
                  badgeColor = wasBackfilled ? 'text-amber-300' : 'text-green-400';
                }

                return (
                  <div
                    key={day.date}
                    className={`rounded-xl p-6 transition-all animate-slide-in ${
                      isFuture ? 'glass opacity-50' :
                      needsBackfill ? 'bg-amber-500/20 border-2 border-amber-500/50' :
                      day.isOffDay ? 'glass opacity-60' :
                      day.isLocked ? 'bg-blue-500/10 border-2 border-blue-500/50' :
                      'glass'
                    }`}
                    style={{ animationDelay: `${dayIndex * 0.05}s` }}
                  >
                    {/* Day Header */}
                    <div className="flex items-center justify-between mb-4">
                      <div>
                        <div className="text-xl font-bold">{formatDate(day.date)}</div>
                        {badge && <div className={`text-sm ${badgeColor} mono mt-1`}>{badge}</div>}
                      </div>
                      <div className="text-right">
                        <div className="text-3xl font-black mono">{day.isOffDay ? '-' : dayScore}</div>
                        <div className="text-xs text-purple-300 mono">points</div>
                      </div>
                    </div>

                    {!isFuture && !day.isOffDay && (
                      <>
                        {/* Habits Grid */}
                        <div className="grid grid-cols-2 gap-2 mb-4">
                          {HABITS.map(habit => {
                            const isDisabled = day.isLocked || isViewingPastWeek;
                            const isWeekend = isWeekendDay(day.date);

                            // Special handling for Sleep (time select 10 PM - 4 AM)
                            if (habit.id === 'sleep') {
                              const sleepTime = day.sleepTime || '';
                              const sleepPoints = calculateSleepPoints(sleepTime, isWeekend);

                              return (
                                <div
                                  key={habit.id}
                                  className={`p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                    isDisabled
                                      ? 'opacity-50 bg-gray-700'
                                      : sleepPoints >= 1
                                      ? 'bg-gradient-to-r from-emerald-600 to-teal-700 text-white'
                                      : sleepPoints < 0
                                      ? 'bg-gradient-to-r from-rose-600 to-red-800 text-white'
                                      : 'bg-white/5 text-purple-300'
                                  }`}
                                >
                                  <span className="flex items-center gap-2">
                                    <span className="text-lg habit-icon">{stealthMode ? habit.stealthIcon : habit.icon}</span>
                                    <span className="text-xs">{stealthMode ? habit.stealthName : (isWeekend ? 'Sleep (Free)' : habit.name)}</span>
                                  </span>
                                  <div className="flex flex-col items-end">
                                    <select
                                      className="w-24 bg-white/20 text-center rounded text-xs p-1 text-white appearance-none cursor-pointer"
                                      value={sleepTime}
                                      onChange={(e) => {
                                        updateSleepTime(actualDayIndex, e.target.value);
                                        if (e.target.value) triggerHaptic('medium');
                                      }}
                                      disabled={isDisabled}
                                    >
                                      <option value="" className="bg-slate-800">Select</option>
                                      {TIME_SLOTS.map(slot => (
                                        <option key={slot.value} value={slot.value} className="bg-slate-800">
                                          {slot.label}
                                        </option>
                                      ))}
                                    </select>
                                    <span className={`text-[10px] mono mt-1 ${sleepPoints < 0 ? 'text-red-300' : 'opacity-75'}`}>
                                      {sleepPoints >= 0 ? '+' : ''}{sleepPoints}pt
                                    </span>
                                  </div>
                                </div>
                              );
                            }

                            // Special handling for reading (quantitative input with counter)
                            if (habit.id === 'reading') {
                              const pagesRead = day.pagesRead || 0;
                              const tierInfo = getReadingTierInfo(pagesRead);
                              const readingPoints = tierInfo.points;
                              const isComplete = pagesRead >= 16; // Tier 2+ = proper session
                              const isExceptional = pagesRead >= 51; // Tier 4+ = significant reading
                              const isAnimating = pageFlipAnim === `${actualDayIndex}-reading`;

                              const incrementPages = () => {
                                if (isDisabled) return;
                                updateReading(actualDayIndex, pagesRead + 5);
                                triggerHaptic('light');
                                setPageFlipAnim(`${actualDayIndex}-reading`);
                                setTimeout(() => setPageFlipAnim(null), 300);
                              };

                              const decrementPages = () => {
                                if (isDisabled || pagesRead <= 0) return;
                                updateReading(actualDayIndex, Math.max(0, pagesRead - 5));
                              };

                              return (
                                <div
                                  key={habit.id}
                                  className={`p-3 rounded-lg font-semibold text-sm ${
                                    isDisabled
                                      ? 'opacity-50 bg-gray-700'
                                      : isExceptional
                                      ? 'bg-gradient-to-r from-amber-600 to-orange-700 text-white'
                                      : isComplete
                                      ? 'bg-gradient-to-r from-emerald-600 to-teal-700 text-white'
                                      : pagesRead >= 1
                                      ? 'bg-gradient-to-r from-slate-600 to-slate-700 text-white'
                                      : 'bg-white/5 text-purple-300'
                                  }`}
                                >
                                  <div className="flex items-center justify-between mb-2">
                                    <span className="flex items-center gap-2">
                                      <span className={`text-lg habit-icon ${isAnimating ? 'page-flip' : ''}`}>
                                        {stealthMode ? habit.stealthIcon : habit.icon}
                                      </span>
                                      <span className="text-xs">{stealthMode ? habit.stealthName : habit.name}</span>
                                    </span>
                                    <span className="text-[10px] mono opacity-75">+{readingPoints}pt</span>
                                  </div>

                                  {/* Counter-style input */}
                                  <div className="flex items-center justify-center gap-2">
                                    <button
                                      onClick={decrementPages}
                                      disabled={isDisabled || pagesRead <= 0}
                                      className={`counter-btn counter-btn-minus ${(isDisabled || pagesRead <= 0) ? 'opacity-30' : ''}`}
                                    >
                                      -
                                    </button>

                                    <div className={`counter-display text-lg ${isAnimating ? 'page-pop' : ''}`}>
                                      {pagesRead}
                                      <span className="text-[10px] opacity-60 ml-1">pg</span>
                                    </div>

                                    <button
                                      onClick={incrementPages}
                                      disabled={isDisabled}
                                      className={`counter-btn counter-btn-plus ${isDisabled ? 'opacity-30' : ''}`}
                                    >
                                      +
                                    </button>
                                  </div>

                                  {/* Progress to next tier */}
                                  <div className="mt-2 h-1 bg-white/10 rounded-full overflow-hidden">
                                    <div
                                      className={`h-full transition-all duration-300 ${
                                        tierInfo.isMaxed
                                          ? 'bg-gradient-to-r from-amber-500 to-yellow-400'
                                          : 'bg-gradient-to-r from-violet-600 to-indigo-600'
                                      }`}
                                      style={{ width: `${tierInfo.progressPercent}%` }}
                                    />
                                  </div>
                                  <div className="text-[9px] text-center mt-1 opacity-60">
                                    {tierInfo.isMaxed
                                      ? 'ðŸ† Maximum tier reached!'
                                      : `${tierInfo.pagesToNext} pages to next tier (+${calculateReadingPoints(pagesRead + tierInfo.pagesToNext) - readingPoints}pt)`
                                    }
                                  </div>
                                </div>
                              );
                            }

                            // Special handling for Gym (with Vital Rest via long-press)
                            if (habit.id === 'gym') {
                              const isVitalRest = day.isVitalRest;
                              const restCount = countVitalRestDays(currentWeek);
                              const canToggleRest = isVitalRest || restCount < 2;
                              const isComplete = isVitalRest || day.habits.gym === habit.points;

                              return (
                                <div
                                  key={habit.id}
                                  className={`p-3 rounded-lg font-semibold text-sm relative overflow-hidden ${
                                    isDisabled
                                      ? 'opacity-50 bg-gray-700'
                                      : isVitalRest
                                      ? 'bg-gradient-to-r from-sky-600 to-indigo-700 text-white'
                                      : isComplete
                                      ? 'bg-gradient-to-r from-emerald-600 to-teal-700 text-white'
                                      : 'bg-white/5 text-purple-300'
                                  }`}
                                  onClick={() => {
                                    if (!isDisabled && !isVitalRest) {
                                      toggleHabit(actualDayIndex, 'gym');
                                    }
                                  }}
                                  onTouchStart={() => {
                                    if (!isDisabled && canToggleRest) {
                                      startLongPress(actualDayIndex, toggleVitalRest);
                                    }
                                  }}
                                  onTouchEnd={cancelLongPress}
                                  onTouchCancel={cancelLongPress}
                                  onMouseDown={() => {
                                    if (!isDisabled && canToggleRest) {
                                      startLongPress(actualDayIndex, toggleVitalRest);
                                    }
                                  }}
                                  onMouseUp={cancelLongPress}
                                  onMouseLeave={cancelLongPress}
                                >
                                  {/* Long press progress indicator */}
                                  {longPressProgress > 0 && (
                                    <div
                                      className="long-press-indicator"
                                      style={{ width: `${longPressProgress}%` }}
                                    />
                                  )}

                                  <div className="flex items-center justify-between">
                                    <span className="flex items-center gap-2">
                                      <span className="text-lg habit-icon">{stealthMode ? habit.stealthIcon : (isVitalRest ? 'ðŸ›Œ' : habit.icon)}</span>
                                      <span className="text-xs">{stealthMode ? habit.stealthName : (isVitalRest ? 'Vital Rest' : habit.name)}</span>
                                    </span>
                                    <span className="text-xs mono opacity-75">
                                      {isVitalRest ? '+1' : day.habits.gym}/{habit.points}
                                    </span>
                                  </div>
                                  <div className="text-[9px] text-center mt-1 opacity-60">
                                    {isVitalRest ? 'Tap to cancel' : `Hold for Rest (${restCount}/2)`}
                                  </div>
                                  {isVitalRest && (
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        toggleVitalRest(actualDayIndex);
                                      }}
                                      className="w-full mt-1 py-1 rounded text-[10px] bg-white/20 hover:bg-white/30"
                                    >
                                      Cancel Rest
                                    </button>
                                  )}
                                </div>
                              );
                            }

                            // Handle habits that might be missing in old saved data (like weight)
                            const habitValue = day.habits[habit.id] ?? 0;
                            const isComplete = habitValue === habit.points;

                            // Handle weekly habits
                            if (habit.isWeekly) {
                              const weeklyComplete = isWeeklyHabitComplete(currentWeek, habit.id);
                              const completionDayIdx = getWeeklyHabitCompletionDay(currentWeek, habit.id);
                              const isCompletedOnThisDay = completionDayIdx === actualDayIndex;
                              const isCompletedOnOtherDay = weeklyComplete && !isCompletedOnThisDay;

                              return (
                                <button
                                  key={habit.id}
                                  onClick={() => toggleHabit(actualDayIndex, habit.id)}
                                  disabled={isDisabled || isCompletedOnOtherDay}
                                  className={`habit-btn p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                    isDisabled
                                      ? 'opacity-50 cursor-not-allowed bg-gray-700'
                                      : isCompletedOnThisDay
                                      ? 'bg-gradient-to-r from-emerald-600 to-teal-700 text-white'
                                      : isCompletedOnOtherDay
                                      ? 'bg-gradient-to-r from-sky-600/50 to-indigo-600/50 text-white/80 cursor-default'
                                      : 'bg-white/5 hover:bg-white/10 text-purple-300'
                                  }`}
                                >
                                  <span className="flex items-center gap-2">
                                    <span className="text-lg habit-icon">{stealthMode ? habit.stealthIcon : habit.icon}</span>
                                    <span className="flex flex-col items-start">
                                      <span className="text-xs">{stealthMode ? habit.stealthName : habit.name}</span>
                                      <span className="text-[9px] text-purple-400/70">
                                        {isCompletedOnOtherDay ? 'âœ“ Done this week' : 'Weekly'}
                                      </span>
                                    </span>
                                  </span>
                                  <span className="text-xs mono opacity-75">
                                    {weeklyComplete ? habit.points : 0}/{habit.points}
                                  </span>
                                </button>
                              );
                            }

                            // Special handling for Dopamine Baseline (Neural Sync - auto-active, long-press to reset)
                            if (habit.id === 'nofap') {
                              const isRelapsed = habitValue === 0;
                              const dayDate = new Date(day.date);
                              const dayOfWeek = dayDate.getDay();
                              const isWeekendDay = dayOfWeek === 0 || dayOfWeek === 6;

                              return (
                                <div
                                  key={habit.id}
                                  className={`p-3 rounded-lg font-semibold text-sm relative overflow-hidden cursor-pointer ${
                                    isDisabled
                                      ? 'opacity-50 bg-gray-700'
                                      : isRelapsed
                                      ? 'bg-gradient-to-r from-rose-600 to-red-800 text-white'
                                      : 'bg-gradient-to-r from-emerald-600 to-teal-700 text-white'
                                  }`}
                                  onTouchStart={() => {
                                    if (!isDisabled && !isRelapsed) {
                                      startLongPress(actualDayIndex, () => {
                                        setNeuralResetDayIndex(actualDayIndex);
                                        setShowNeuralResetModal(true);
                                      });
                                    }
                                  }}
                                  onTouchEnd={cancelLongPress}
                                  onTouchCancel={cancelLongPress}
                                  onMouseDown={() => {
                                    if (!isDisabled && !isRelapsed) {
                                      startLongPress(actualDayIndex, () => {
                                        setNeuralResetDayIndex(actualDayIndex);
                                        setShowNeuralResetModal(true);
                                      });
                                    }
                                  }}
                                  onMouseUp={cancelLongPress}
                                  onMouseLeave={cancelLongPress}
                                >
                                  {/* Long press progress indicator */}
                                  {longPressProgress > 0 && (
                                    <div
                                      className="long-press-indicator"
                                      style={{ width: `${longPressProgress}%` }}
                                    />
                                  )}

                                  <div className="flex items-center justify-between">
                                    <span className="flex items-center gap-2">
                                      <span className="text-lg habit-icon">{stealthMode ? habit.stealthIcon : 'ðŸ§ '}</span>
                                      <span className="text-xs">{stealthMode ? habit.stealthName : 'Neural Baseline'}</span>
                                    </span>
                                    <span className="text-xs mono opacity-75">
                                      {isRelapsed ? '0' : habit.points}/{habit.points}
                                    </span>
                                  </div>
                                  <div className="text-[9px] text-center mt-1 opacity-70">
                                    {isRelapsed
                                      ? 'âŒ Reset Triggered'
                                      : 'âœ“ Active â€¢ Hold to reset'
                                    }
                                  </div>
                                </div>
                              );
                            }

                            return (
                              <button
                                key={habit.id}
                                onClick={() => toggleHabit(actualDayIndex, habit.id)}
                                disabled={isDisabled}
                                className={`habit-btn p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                  isDisabled
                                    ? 'opacity-50 cursor-not-allowed bg-gray-700'
                                    : isComplete
                                    ? 'bg-gradient-to-r from-emerald-600 to-teal-700 text-white'
                                    : 'bg-white/5 hover:bg-white/10 text-purple-300'
                                }`}
                              >
                                <span className="flex items-center gap-2">
                                  <span className="text-lg habit-icon">{stealthMode ? habit.stealthIcon : habit.icon}</span>
                                  <span className="text-xs">{stealthMode ? habit.stealthName : habit.name}</span>
                                </span>
                                <span className="text-xs mono opacity-75">
                                  {habitValue}/{habit.points}
                                </span>
                              </button>
                            );
                          })}
                        </div>

                        {/* Ad-hoc Tasks (Ephemeral filtering) */}
                        {(() => {
                          // Filter tasks: hide if completed on a previous day
                          const tasksForThisDay = state.adHocTasks.filter(task => {
                            const completedEarlier = currentWeek.days.some((d, idx) =>
                              idx < actualDayIndex && d.completedTasks.includes(task.id)
                            );
                            return !completedEarlier;
                          });

                          if (tasksForThisDay.length === 0) return null;

                          return (
                            <div className="space-y-2 mb-4">
                              {tasksForThisDay.map(task => {
                                const isComplete = day.completedTasks.includes(task.id);
                                const isDisabled = day.isLocked || isViewingPastWeek;

                                return (
                                  <button
                                    key={task.id}
                                    onClick={() => toggleTask(actualDayIndex, task.id)}
                                    disabled={isDisabled}
                                    className={`habit-btn w-full p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                      isDisabled
                                        ? 'opacity-50 cursor-not-allowed bg-gray-700'
                                        : isComplete
                                        ? 'bg-gradient-to-r from-amber-500 to-orange-700 text-white'
                                        : 'bg-white/5 hover:bg-white/10 text-purple-300'
                                    }`}
                                  >
                                    <span className="flex items-center gap-2">
                                      <span className="text-lg">*</span>
                                      <span className="text-xs">{task.name}</span>
                                    </span>
                                    <span className="text-xs mono opacity-75">
                                      {isComplete ? task.points : 0}/{task.points}
                                    </span>
                                  </button>
                                );
                              })}
                            </div>
                          );
                        })()}

                        {/* Productivity Rating Slider - Only on workdays (not Sat/Sun) */}
                        {!isNonWorkDay(day.date) && (
                        <div className={`glass rounded-xl p-4 mb-4 ${day.productivityRating === 4 ? 'flow-state-active' : ''}`}>
                          <div className="flex items-center justify-between mb-3">
                            <div className="text-sm font-semibold text-purple-300">
                              Cognitive Throughput
                            </div>
                            <div className="text-xs text-purple-400 mono">
                              {day.productivityRating !== null && day.productivityRating !== undefined
                                ? `+${PRODUCTIVITY_TIERS[day.productivityRating].points} pts`
                                : 'Not rated'}
                            </div>
                          </div>

                          {/* Slider */}
                          <div className="productivity-slider-container">
                            <input
                              type="range"
                              min="0"
                              max="4"
                              step="1"
                              value={day.productivityRating ?? 2}
                              onChange={(e) => {
                                if (!day.isLocked && !isViewingPastWeek) {
                                  updateProductivityRating(actualDayIndex, parseInt(e.target.value));
                                }
                              }}
                              disabled={day.isLocked || isViewingPastWeek}
                              className={`productivity-slider slider-level-${day.productivityRating ?? 2} ${(day.isLocked || isViewingPastWeek) ? 'opacity-50 cursor-not-allowed' : ''}`}
                            />
                            {/* Notches */}
                            <div className="productivity-notches">
                              {[0, 1, 2, 3, 4].map(n => (
                                <div
                                  key={n}
                                  className={`productivity-notch ${(day.productivityRating ?? 2) === n ? 'productivity-notch-active' : ''}`}
                                />
                              ))}
                            </div>
                          </div>

                          {/* Tier Label */}
                          {(() => {
                            const rating = day.productivityRating ?? 2;
                            const tier = PRODUCTIVITY_TIERS[rating];
                            return (
                              <div className={`productivity-tier-label tier-label-${rating}`}>
                                <div className={`text-sm font-bold ${tier.color}`}>
                                  {tier.icon} Tier {rating}: {tier.name}
                                </div>
                                <div className="text-[10px] text-purple-300 mt-1">
                                  {tier.description}
                                </div>
                              </div>
                            );
                          })()}
                        </div>
                        )}

                        {/* Day Controls */}
                        {!isViewingPastWeek && (
                        <div className="flex gap-2">
                          <button
                            onClick={() => toggleOffDay(actualDayIndex)}
                            disabled={day.isLocked}
                            className={`flex-1 py-2 rounded-lg text-xs font-semibold transition-all ${
                              day.isLocked
                                ? 'opacity-50 cursor-not-allowed bg-gray-700'
                                : 'glass hover:bg-white/10 text-purple-300'
                            }`}
                          >
                            Mark Off
                          </button>
                          <button
                            onClick={() => toggleLock(actualDayIndex)}
                            className={`flex-1 py-2 rounded-lg text-xs font-semibold transition-all ${
                              day.isLocked
                                ? 'bg-blue-500/30 hover:bg-blue-500/40 text-blue-300'
                                : 'glass hover:bg-white/10 text-purple-300'
                            }`}
                          >
                            {day.isLocked ? 'Unlock' : 'Lock'}
                          </button>
                        </div>
                        )}
                      </>
                    )}

                    {day.isOffDay && (
                      <div className="text-center py-4">
                        <div className="text-4xl mb-2">O</div>
                        <div className="text-purple-300 text-sm">Off Day</div>
                        {!isViewingPastWeek && (
                        <button
                          onClick={() => toggleOffDay(actualDayIndex)}
                          disabled={day.isLocked}
                          className="mt-3 px-4 py-2 rounded-lg text-xs font-semibold glass hover:bg-white/10 text-purple-300"
                        >
                          Unmark
                        </button>
                        )}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
            )}

            {/* Tasks Management */}
            {(() => {
              // Filter out tasks that have been completed on any day
              const pendingTasks = state.adHocTasks.filter(task => {
                const completedOnAnyDay = currentWeek.days.some(d =>
                  d.completedTasks.includes(task.id)
                );
                return !completedOnAnyDay;
              });

              return (
                <div className="mt-8 animate-slide-in">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-2xl font-bold">Bonus Tasks</h2>
                    <button
                      onClick={() => setShowTaskModal(true)}
                      className="px-4 py-2 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-purple-600 hover:to-pink-600 transition-all"
                    >
                      + Add Task
                    </button>
                  </div>

                  {pendingTasks.length === 0 ? (
                    <div className="glass rounded-xl p-8 text-center text-purple-400">
                      <div className="text-4xl mb-2">*</div>
                      <div className="text-sm">{state.adHocTasks.length > 0 ? 'All tasks completed!' : 'No bonus tasks yet'}</div>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {pendingTasks.map(task => (
                        <div key={task.id} className="glass rounded-xl p-4 flex items-center justify-between">
                          <div>
                            <div className="font-semibold">{task.name}</div>
                            <div className="text-xs text-purple-400 mono">{task.points} points</div>
                          </div>
                          <button
                            onClick={() => {
                              if (confirm(`Delete "${task.name}"?`)) {
                                deleteTask(task.id);
                              }
                            }}
                            className="px-3 py-1 rounded-lg text-xs font-semibold bg-red-500/20 hover:bg-red-500/30 text-red-300 transition-all"
                          >
                            Delete
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              );
            })()}

            {/* Bonus Archive (for past weeks) */}
            {isViewingPastWeek && currentWeekArchivedTasks.length > 0 && (
              <div className="glass rounded-xl p-4 mt-6 animate-slide-in border border-amber-500/20">
                <div className="flex items-center gap-2 mb-3">
                  <span className="text-lg">ðŸ“¦</span>
                  <h3 className="text-sm font-semibold text-amber-300">Bonus Archive - Week {state.currentWeek + 1}</h3>
                </div>
                <div className="space-y-2">
                  {currentWeekArchivedTasks.map((task, idx) => (
                    <div key={idx} className="flex items-center justify-between bg-white/5 rounded-lg px-3 py-2">
                      <div className="flex items-center gap-2">
                        <span className="text-emerald-400">âœ“</span>
                        <span className="text-sm text-purple-200">{task.name}</span>
                      </div>
                      <div className="flex items-center gap-2 text-xs">
                        <span className="text-purple-400">{task.dayOfWeek}</span>
                        <span className="text-emerald-400 mono">+{task.points}pt</span>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="text-xs text-purple-400 mt-3 text-center">
                  {currentWeekArchivedTasks.length} task{currentWeekArchivedTasks.length !== 1 ? 's' : ''} completed this week
                </div>
              </div>
            )}

            {/* 30-Day Heatmap (GitHub-style contribution graph) */}
            <div className="glass rounded-xl p-4 mt-8 animate-slide-in">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-sm font-semibold text-purple-300">30-Day Consistency</h3>
                <div className="flex items-center gap-1 text-[10px] text-purple-400">
                  <span>Less</span>
                  <div className="flex gap-1">
                    <div className="w-3 h-3 rounded-sm heatmap-level-0" />
                    <div className="w-3 h-3 rounded-sm heatmap-level-1" />
                    <div className="w-3 h-3 rounded-sm heatmap-level-2" />
                    <div className="w-3 h-3 rounded-sm heatmap-level-3" />
                    <div className="w-3 h-3 rounded-sm heatmap-level-4" />
                  </div>
                  <span>More</span>
                </div>
              </div>
              <div className="heatmap-grid">
                {heatmapData.map((cell, idx) => (
                  <div
                    key={idx}
                    className={`heatmap-cell ${
                      cell.isFuture ? 'opacity-20 heatmap-level-0' :
                      cell.isOffDay ? 'bg-gray-700/50' :
                      `heatmap-level-${cell.level}`
                    } ${cell.isToday ? 'ring-2 ring-violet-400 ring-offset-1 ring-offset-slate-950' : ''}`}
                    title={`${cell.date}: ${cell.isOffDay ? 'Off Day' : cell.isFuture ? 'Future' : `${cell.score} pts`}`}
                  />
                ))}
              </div>
              <div className="flex justify-between mt-2 text-[10px] text-purple-500">
                <span>5 weeks ago</span>
                <span>Today</span>
              </div>
            </div>

            {/* Footer with Sync Status */}
            <div className="mt-8 text-center text-purple-500 text-xs">
              <div className="flex items-center justify-center gap-3 mb-2">
                {/* Local save indicator */}
                <div className="flex items-center gap-1">
                  <div className={`w-2 h-2 rounded-full ${Date.now() - lastSaved < 2000 ? 'bg-green-400 animate-pulse' : 'bg-green-600'}`} />
                  <span>Local</span>
                </div>

                {/* Google Sheets sync status / connect */}
                <button
                  onClick={() => setShowSheetsModal(true)}
                  className={`flex items-center gap-1 px-2 py-1 rounded-lg transition-all ${
                    sheetsConfig
                      ? syncStatus === 'syncing'
                        ? 'bg-blue-500/20 text-blue-300'
                        : syncStatus === 'error'
                        ? 'bg-red-500/20 text-red-300'
                        : 'bg-green-500/20 text-green-300'
                      : 'bg-purple-500/20 text-purple-300 hover:bg-purple-500/30'
                  }`}
                >
                  <svg className={`w-3 h-3 ${syncStatus === 'syncing' ? 'animate-spin' : ''}`} fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5.5 16a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 16h-8z" />
                  </svg>
                  <span>
                    {sheetsConfig
                      ? syncStatus === 'syncing' ? 'Syncing...' : syncStatus === 'error' ? 'Error' : 'Cloud'
                      : 'Connect'}
                  </span>
                </button>

                {/* Manual Sync Button (when connected) */}
                {sheetsConfig && (
                  <button
                    onClick={manualSync}
                    disabled={syncStatus === 'syncing'}
                    className="flex items-center gap-1 px-2 py-1 rounded-lg bg-indigo-500/20 text-indigo-300 hover:bg-indigo-500/30 transition-all"
                  >
                    <svg className={`w-3 h-3 ${syncStatus === 'syncing' ? 'animate-spin' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span>Sync</span>
                  </button>
                )}
              </div>

              <p className="text-[10px]">{sheetsConfig ? 'Tap Sync to pull/push from Google Sheets' : 'Data saved locally on this device'}</p>

              {/* Swipe hint */}
              <div className="swipe-hint mt-2">
                Swipe left/right to navigate weeks
              </div>
            </div>
          </div>

          {/* Task Modal */}
          {showTaskModal && <TaskModal onClose={() => setShowTaskModal(false)} onAdd={addTask} />}

          {/* Info Modal */}
          {showInfoModal && <InfoModal onClose={() => setShowInfoModal(false)} />}

          {/* Google Sheets Setup Modal */}
          {showSheetsModal && (
            <SheetsModal
              onClose={() => setShowSheetsModal(false)}
              onSave={saveSheetsConfig}
              currentConfig={sheetsConfig}
            />
          )}

          {/* Conflict Resolution Modal */}
          {showConflictModal && conflictData && (
            <ConflictModal
              localData={conflictData.local}
              remoteData={conflictData.remote}
              onResolve={resolveConflict}
            />
          )}

          {/* Backfill Prompt */}
          {showBackfillPrompt && (
            <BackfillPrompt
              onBackfill={() => {
                switchViewMode('all-days');
                setShowBackfillPrompt(false);
              }}
              onContinue={() => setShowBackfillPrompt(false)}
              unfilledCount={currentWeek.days.filter(d => isPastDay(d.date) && !d.isFilled && !d.isOffDay).length}
            />
          )}

          {/* Sunday Pre-Flight Modal */}
          {showSundayPreFlight && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
              <div className="bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900 rounded-2xl p-6 max-w-md w-full border border-purple-500/30 shadow-2xl">
                <div className="text-center mb-6">
                  <div className="text-4xl mb-2">ðŸš€</div>
                  <h2 className="text-xl font-bold text-purple-300">Sunday Pre-Flight Check</h2>
                  <p className="text-sm text-purple-400 mt-2">Prep for a strong Monday</p>
                </div>

                <div className="space-y-4 mb-6">
                  {/* Weight Check */}
                  <div className="glass rounded-lg p-4">
                    <div className="flex items-center gap-3">
                      <span className="text-2xl">âš–ï¸</span>
                      <div className="flex-1">
                        <div className="font-semibold text-white">Weight Logged?</div>
                        <div className="text-xs text-purple-300">
                          {(() => {
                            const today = currentWeek.days.find(d => isSameDay(new Date(d.date), new Date()));
                            const logged = today && today.habits.weight > 0;
                            return logged
                              ? <span className="text-emerald-400">âœ“ Logged today</span>
                              : <span className="text-amber-400">âš  Not logged yet</span>;
                          })()}
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Nutrition Prep Check */}
                  <div className="glass rounded-lg p-4">
                    <div className="flex items-center gap-3">
                      <span className="text-2xl">ðŸ¥—</span>
                      <div className="flex-1">
                        <div className="font-semibold text-white">Nutrition Ready?</div>
                        <div className="text-xs text-purple-300">Lose It! prepped for Monday?</div>
                      </div>
                    </div>
                  </div>

                  {/* Monday Mindset */}
                  <div className="glass rounded-lg p-4 border border-emerald-500/30">
                    <div className="flex items-center gap-3">
                      <span className="text-2xl">ðŸ’ª</span>
                      <div className="flex-1">
                        <div className="font-semibold text-emerald-300">Monday Game Mode</div>
                        <div className="text-xs text-purple-300">High-performance mode activates at midnight</div>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Actions */}
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setShowSundayPreFlight(false);
                      setSundayPreFlightDismissed(true);
                    }}
                    className="flex-1 py-3 rounded-lg font-semibold bg-purple-600 hover:bg-purple-500 text-white transition-all"
                  >
                    Ready for Monday! ðŸš€
                  </button>
                </div>

                <p className="text-[10px] text-center text-purple-400 mt-4">
                  This check appears every Sunday at 9 PM
                </p>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ============================================================================
    // TASK MODAL COMPONENT
    // ============================================================================

    function TaskModal({ onClose, onAdd }) {
      const [name, setName] = useState('');
      const [points, setPoints] = useState(2);

      const handleSubmit = () => {
        if (!name.trim()) {
          alert('Please enter a task name');
          return;
        }
        onAdd(name.trim(), points);
      };

      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 animate-slide-in">
          <div className="glass rounded-2xl p-6 max-w-md w-full">
            <h3 className="text-2xl font-bold mb-4">Add Bonus Task</h3>

            <div className="mb-4">
              <label className="block text-sm font-semibold text-purple-300 mb-2">Task Name</label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="e.g., Call dentist"
                className="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 focus:border-purple-400 focus:outline-none text-white placeholder-purple-400"
                autoFocus
              />
            </div>

            <div className="mb-6">
              <label className="block text-sm font-semibold text-purple-300 mb-2">Points (1-5)</label>
              <div className="flex gap-2">
                {[1, 2, 3, 4, 5].map(p => (
                  <button
                    key={p}
                    onClick={() => setPoints(p)}
                    className={`flex-1 py-3 rounded-lg font-bold transition-all ${
                      points === p
                        ? 'bg-gradient-to-r from-violet-600 to-indigo-600 text-white'
                        : 'glass text-purple-300 hover:bg-white/10'
                    }`}
                  >
                    {p}
                  </button>
                ))}
              </div>
            </div>

            <div className="flex gap-3">
              <button
                onClick={onClose}
                className="flex-1 py-3 rounded-lg font-semibold glass hover:bg-white/10 text-purple-300"
              >
                Cancel
              </button>
              <button
                onClick={handleSubmit}
                className="flex-1 py-3 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-purple-600 hover:to-pink-600"
              >
                Add Task
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================================================
    // GOOGLE SHEETS SETUP MODAL
    // ============================================================================

    function SheetsModal({ onClose, onSave, currentConfig }) {
      const [webAppUrl, setWebAppUrl] = useState(currentConfig?.webAppUrl || '');
      const [step, setStep] = useState(currentConfig ? 'connected' : 'intro');

      const handleSave = () => {
        if (!webAppUrl.trim()) {
          alert('Please enter your Google Apps Script Web App URL');
          return;
        }
        onSave({ webAppUrl: webAppUrl.trim() });
      };

      const handleDisconnect = () => {
        localStorage.removeItem(SHEETS_CONFIG_KEY);
        onSave(null);
        onClose();
      };

      return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 animate-slide-in overflow-y-auto">
          <div className="glass rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-2xl font-bold">Google Sheets Sync</h3>
              <button
                onClick={onClose}
                className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center"
              >
                X
              </button>
            </div>

            {step === 'connected' && currentConfig && (
              <div className="text-center">
                <div className="text-6xl mb-4">âœ“</div>
                <h4 className="text-xl font-bold text-green-400 mb-2">Connected!</h4>
                <p className="text-purple-300 text-sm mb-6">
                  Your data is syncing to Google Sheets.
                </p>
                <div className="glass rounded-lg p-3 mb-6 text-xs text-left">
                  <div className="text-purple-400 mb-1">Web App URL:</div>
                  <div className="text-purple-200 break-all mono">{currentConfig.webAppUrl.substring(0, 50)}...</div>
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={handleDisconnect}
                    className="flex-1 py-3 rounded-lg font-semibold bg-red-500/20 hover:bg-red-500/30 text-red-300"
                  >
                    Disconnect
                  </button>
                  <button
                    onClick={onClose}
                    className="flex-1 py-3 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600"
                  >
                    Done
                  </button>
                </div>
              </div>
            )}

            {step === 'intro' && (
              <>
                <div className="text-center mb-6">
                  <div className="text-6xl mb-4">ðŸ“Š</div>
                  <p className="text-purple-200 text-sm">
                    Back up your data to Google Sheets for safety and analysis.
                  </p>
                </div>

                <div className="glass rounded-lg p-4 mb-6">
                  <h4 className="font-bold text-purple-300 mb-3">Quick Setup (5 mins)</h4>
                  <ol className="text-xs text-purple-200 space-y-2">
                    <li className="flex gap-2">
                      <span className="text-purple-400 font-bold">1.</span>
                      <span>Create a new Google Sheet</span>
                    </li>
                    <li className="flex gap-2">
                      <span className="text-purple-400 font-bold">2.</span>
                      <span>Go to Extensions â†’ Apps Script</span>
                    </li>
                    <li className="flex gap-2">
                      <span className="text-purple-400 font-bold">3.</span>
                      <span>Paste the sync script (tap "Copy Script" below)</span>
                    </li>
                    <li className="flex gap-2">
                      <span className="text-purple-400 font-bold">4.</span>
                      <span>Deploy â†’ New deployment â†’ Web app</span>
                    </li>
                    <li className="flex gap-2">
                      <span className="text-purple-400 font-bold">5. </span>
                      <span>Set "Who has access" to "Anyone" and Deploy</span>
                    </li>
                    <li className="flex gap-2">
                      <span className="text-purple-400 font-bold">6.</span>
                      <span>Copy the Web App URL and paste below</span>
                    </li>
                  </ol>
                </div>

                <button
                  onClick={() => {
                    const script = `// Two-Way Sync Script for Discipline Tracker
// Handles both saving (POST) and loading (GET) data

function doGet(e) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var lastRow = sheet.getLastRow();

    if (lastRow < 2) {
      // No data yet
      return ContentService.createTextOutput(
        JSON.stringify({ success: true, data: null })
      ).setMimeType(ContentService.MimeType.JSON);
    }

    // Get the latest data (last row, column B has JSON)
    var jsonData = sheet.getRange(lastRow, 2).getValue();
    var timestamp = sheet.getRange(lastRow, 1).getValue();

    return ContentService.createTextOutput(
      JSON.stringify({
        success: true,
        data: JSON.parse(jsonData),
        timestamp: timestamp,
        rowCount: lastRow
      })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch(err) {
    return ContentService.createTextOutput(
      JSON.stringify({ success: false, error: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    var payload = JSON.parse(e.postData.contents);
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();

    // Add header if first time
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(['Timestamp', 'State JSON', 'Device', 'Streak', 'Week']);
    }

    // Append new row with full state
    sheet.appendRow([
      payload.timestamp || new Date().toISOString(),
      JSON.stringify(payload.data),
      payload.deviceId || 'unknown',
      payload.data.streakDays || 0,
      payload.data.currentWeek || 0
    ]);

    // Keep only last 100 rows to prevent sheet bloat
    var lastRow = sheet.getLastRow();
    if (lastRow > 101) {
      sheet.deleteRows(2, lastRow - 101);
    }

    return ContentService.createTextOutput(
      JSON.stringify({ success: true, savedAt: new Date().toISOString() })
    ).setMimeType(ContentService.MimeType.JSON);

  } catch(err) {
    return ContentService.createTextOutput(
      JSON.stringify({ success: false, error: err.message })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}`;
                    navigator.clipboard.writeText(script);
                    alert('Script copied! Paste it in Google Apps Script. Remember to redeploy if you had the old script.');
                  }}
                  className="w-full py-3 rounded-lg font-semibold glass hover:bg-white/10 text-purple-300 mb-4"
                >
                  Copy Script
                </button>

                <button
                  onClick={() => setStep('url')}
                  className="w-full py-3 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600"
                >
                  I Have My Web App URL
                </button>

                <button
                  onClick={onClose}
                  className="w-full py-3 rounded-lg font-semibold text-purple-400 hover:text-purple-300 mt-3"
                >
                  Skip for Now
                </button>
              </>
            )}

            {step === 'url' && (
              <>
                <div className="mb-6">
                  <label className="block text-sm font-semibold text-purple-300 mb-2">
                    Google Apps Script Web App URL
                  </label>
                  <input
                    type="url"
                    value={webAppUrl}
                    onChange={(e) => setWebAppUrl(e.target.value)}
                    placeholder="https://script.google.com/macros/s/..."
                    className="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 focus:border-purple-400 focus:outline-none text-white placeholder-purple-400 text-sm"
                    autoFocus
                  />
                  <p className="text-[10px] text-purple-400 mt-2">
                    This URL is from your deployed Google Apps Script web app
                  </p>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setStep('intro')}
                    className="flex-1 py-3 rounded-lg font-semibold glass hover:bg-white/10 text-purple-300"
                  >
                    Back
                  </button>
                  <button
                    onClick={handleSave}
                    className="flex-1 py-3 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600"
                  >
                    Connect
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      );
    }

    // ============================================================================
    // INFO MODAL COMPONENT
    // ============================================================================

    function InfoModal({ onClose }) {
      return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 animate-slide-in overflow-y-auto">
          <div className="glass rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-2xl font-bold">How It Works</h3>
              <button
                onClick={onClose}
                className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center"
              >
                X
              </button>
            </div>

            {/* Daily Points */}
            <div className="mb-6">
              <h4 className="text-lg font-bold text-purple-300 mb-3">Daily Points</h4>
              <p className="text-sm text-purple-200 mb-3">
                Complete your 17 core habits each day. Each gives 0.5 to 3 points.
              </p>
              <div className="glass rounded-lg p-3 text-xs space-y-1">
                <div className="flex justify-between"><span>Dopamine Baseline</span><span className="text-green-400">3 pts</span></div>
                <div className="flex justify-between"><span>Lunch / Dinner / Diet / Reading</span><span className="text-green-400">2 pts each</span></div>
                <div className="flex justify-between"><span>Sleep (variable: -1 to +2)</span><span className="text-blue-400">time-based</span></div>
                <div className="flex justify-between"><span>Most other habits</span><span className="text-green-400">1 pt each</span></div>
                <div className="flex justify-between"><span>Weight Logged (just track it!)</span><span className="text-green-400">0.5 pts</span></div>
                <div className="flex justify-between"><span>Mental Reset (weekly - therapy)</span><span className="text-sky-400">2 pts/week</span></div>
              </div>
            </div>

            {/* Weekly Tiers */}
            <div className="mb-6">
              <h4 className="text-lg font-bold text-purple-300 mb-3">Weekly Tiers</h4>
              <p className="text-sm text-purple-200 mb-3">
                Points add up over 7 days. Your tier determines reward or penalty.
              </p>
              <div className="glass rounded-lg p-3 text-xs space-y-2">
                <div className="flex justify-between items-center">
                  <span>ELITE (94+ pts)</span>
                  <span className="text-green-400 font-bold">+$100 reward</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>SOLID (83+ pts)</span>
                  <span className="text-green-400 font-bold">+$60 reward</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>DECENT (70+ pts)</span>
                  <span className="text-green-400 font-bold">+$30 reward</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>STRUGGLING (55-69 pts)</span>
                  <span className="text-red-400 font-bold">-$75 penalty</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>CRISIS (&lt;55 pts)</span>
                  <span className="text-red-400 font-bold">-$200 penalty</span>
                </div>
              </div>
              <p className="text-[10px] text-purple-400 mt-2">
                * Thresholds scale down if you take off-days (e.g., 5 active days = lower targets)
              </p>
            </div>

            {/* Screen Time Quota */}
            <div className="mb-6">
              <h4 className="text-lg font-bold text-purple-300 mb-3">Screen Time Quota</h4>
              <p className="text-sm text-purple-200 mb-3">
                Track TV/screen time with the built-in timer. Two modes differentiate content types.
              </p>
              <div className="glass rounded-lg p-3 text-xs space-y-2">
                <div className="flex justify-between items-center">
                  <span>ðŸ“š Educational Mode</span>
                  <span className="text-emerald-400">+1 Career pt per 30 min</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>ðŸ“º Entertainment Mode</span>
                  <span className="text-amber-400">90 min daily quota</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>Exceeding entertainment quota</span>
                  <span className="text-red-400 font-bold">-5 pts "Time Leak"</span>
                </div>
              </div>
              <p className="text-[10px] text-purple-400 mt-2">
                * Use the timer to track all screen consumption. Educational content earns Career points!
              </p>
            </div>

            {/* Productivity Rating */}
            <div className="mb-6">
              <h4 className="text-lg font-bold text-purple-300 mb-3">Cognitive Throughput</h4>
              <p className="text-sm text-purple-200 mb-3">
                Rate your daily work output for regression analysis. Slide to set your tier.
              </p>
              <div className="glass rounded-lg p-3 text-xs space-y-2">
                <div className="flex justify-between items-center">
                  <span>ðŸ”´ 0: System Failure</span>
                  <span className="text-red-400">0 pts</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>ðŸŸ  1: Maintenance</span>
                  <span className="text-orange-400">1 pt</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>ðŸŸ¡ 2: Functional</span>
                  <span className="text-yellow-400">2 pts</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>ðŸŸ¢ 3: Power State</span>
                  <span className="text-green-400">3 pts</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>ðŸ’Ž 4: Flow State</span>
                  <span className="text-cyan-400">4 pts</span>
                </div>
              </div>
              <p className="text-[10px] text-purple-400 mt-2">
                * This data syncs to Google Sheets for correlation analysis with other habits.
              </p>
            </div>

            {/* The Two Accounts */}
            <div className="mb-6">
              <h4 className="text-lg font-bold text-purple-300 mb-3">The Two Accounts</h4>
              <div className="space-y-3">
                <div className="glass rounded-lg p-3">
                  <div className="text-green-400 font-bold mb-1">Guilt-Free Fund</div>
                  <p className="text-xs text-purple-200">
                    Your "do whatever you want" money. Skydiving? Solo trip? Random gadget?
                    Zero guilt - you earned it through discipline.
                  </p>
                </div>
                <div className="glass rounded-lg p-3">
                  <div className="text-red-400 font-bold mb-1">NRE Account (No Retrieval Ever)</div>
                  <p className="text-xs text-purple-200">
                    A locked savings you can't touch. Penalty money goes here and sits
                    untouchable - maybe unlocked in 5 years for a house down payment.
                    Watching it grow is the punishment.
                  </p>
                </div>
              </div>
            </div>

            {/* Special Rules */}
            <div className="mb-6">
              <h4 className="text-lg font-bold text-purple-300 mb-3">Special Rules</h4>
              <div className="glass rounded-lg p-3 text-xs space-y-3">
                <div>
                  <div className="font-bold text-blue-300">Sleep Velocity</div>
                  <p className="text-purple-200">Before 11 PM = +1pt | After 11 PM = -1pt</p>
                </div>
                <div>
                  <div className="font-bold text-blue-300">Weekend Buffer (Fri/Sat)</div>
                  <p className="text-purple-200">Sleep auto-awards 1pt. Free roam mode!</p>
                </div>
                <div>
                  <div className="font-bold text-blue-300">Sunday Reset</div>
                  <p className="text-purple-200">Sleep late Sunday? Monday's Career Dev points get halved.</p>
                </div>
                <div>
                  <div className="font-bold text-blue-300">Meal Flexibility</div>
                  <p className="text-purple-200">3 meals can be skipped free per week. After that, -2pts per skip.</p>
                </div>
                <div>
                  <div className="font-bold text-blue-300">Vital Rest Days</div>
                  <p className="text-purple-200">2 days/week can be rest days - auto-awards gym point as recovery.</p>
                </div>
                <div>
                  <div className="font-bold text-blue-300">Bonus Task Eligibility</div>
                  <p className="text-purple-200">Bonus tasks only count toward tier if core habits are 60%+ done. No gaming the system!</p>
                </div>
              </div>
            </div>

            {/* Why It Works */}
            <div className="mb-4">
              <h4 className="text-lg font-bold text-purple-300 mb-3">Why It Works</h4>
              <div className="glass rounded-lg p-3 text-xs text-purple-200">
                <p className="mb-2">
                  <strong className="text-white">Loss aversion:</strong> Losing $200 to an untouchable account hurts
                  way more than gaining $100 feels good.
                </p>
                <p>
                  You're not fighting willpower anymore - you're fighting your wallet.
                  Missing one gym session doesn't feel bad... but watching $200 disappear
                  into a locked account because you had a lazy week? That stings.
                </p>
              </div>
            </div>

            <button
              onClick={onClose}
              className="w-full py-3 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-purple-600 hover:to-pink-600 mt-4"
            >
              Got It
            </button>
          </div>
        </div>
      );
    }

    // ============================================================================
    // BACKFILL PROMPT COMPONENT
    // ============================================================================

    // ============================================================================
    // CONFLICT RESOLUTION MODAL (Multi-Device Sync Protection)
    // ============================================================================

    function ConflictModal({ localData, remoteData, onResolve }) {
      const formatTime = (timestamp) => {
        if (!timestamp) return 'Unknown';
        return new Date(timestamp).toLocaleString();
      };

      return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 animate-slide-in">
          <div className="glass rounded-2xl p-6 max-w-md w-full">
            <div className="text-center mb-6">
              <div className="text-6xl mb-4">âš ï¸</div>
              <h3 className="text-2xl font-bold text-amber-400 mb-2">Sync Conflict Detected</h3>
              <p className="text-purple-300 text-sm">
                Another device modified your data. Choose which version to keep.
              </p>
            </div>

            <div className="space-y-3 mb-6">
              {/* Local version */}
              <div className="glass rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="font-bold text-blue-300">This Device</span>
                  <span className="text-xs text-purple-400 mono">
                    {formatTime(localData?.lastModified)}
                  </span>
                </div>
                <div className="text-xs text-purple-200">
                  <div>Streak: {localData?.streakDays || 0} days</div>
                  <div>Balance: ${localData?.guiltFreeBalance || 0}</div>
                </div>
              </div>

              {/* Remote version */}
              <div className="glass rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="font-bold text-green-300">Other Device</span>
                  <span className="text-xs text-purple-400 mono">
                    {formatTime(remoteData?.lastModified)}
                  </span>
                </div>
                <div className="text-xs text-purple-200">
                  <div>Streak: {remoteData?.streakDays || 0} days</div>
                  <div>Balance: ${remoteData?.guiltFreeBalance || 0}</div>
                </div>
              </div>
            </div>

            <div className="flex flex-col gap-2">
              <button
                onClick={() => onResolve('remote')}
                className="py-3 rounded-lg font-semibold bg-gradient-to-r from-emerald-600 to-teal-700 text-white"
              >
                Keep Other Device (Newer)
              </button>
              <button
                onClick={() => onResolve('local')}
                className="py-3 rounded-lg font-semibold glass hover:bg-white/10 text-purple-300"
              >
                Keep This Device
              </button>
            </div>

            <p className="text-[10px] text-purple-500 text-center mt-4">
              Tip: Always close the app on other devices before making changes
            </p>
          </div>
        </div>
      );
    }

    // ============================================================================
    // BACKFILL PROMPT COMPONENT
    // ============================================================================

    function BackfillPrompt({ onBackfill, onContinue, unfilledCount }) {
      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 animate-slide-in">
          <div className="glass rounded-2xl p-6 max-w-md w-full">
            <div className="text-center mb-6">
              <div className="text-6xl mb-4">!</div>
              <h3 className="text-2xl font-bold mb-2">Missing Data Detected</h3>
              <p className="text-purple-300">
                You have {unfilledCount} day{unfilledCount > 1 ? 's' : ''} to backfill since your journey started.
              </p>
            </div>

            <div className="flex flex-col gap-3">
              <button
                onClick={onBackfill}
                className="py-3 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-purple-600 hover:to-pink-600"
              >
                Backfill Now
              </button>
              <button
                onClick={onContinue}
                className="py-3 rounded-lg font-semibold glass hover:bg-white/10 text-purple-300"
              >
                Continue with Today
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Render the app
    ReactDOM.createRoot(document.getElementById('root')).render(<DisciplineTracker />);
  </script>
</body>
</html>
