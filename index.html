<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Mobile Web App Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Discipline">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1e1b4b">
  <meta name="msapplication-TileColor" content="#1e1b4b">
  <meta name="format-detection" content="telephone=no">

  <!-- SEO and Social Meta Tags -->
  <meta name="description" content="Track your daily habits and build discipline with rewards and penalties">
  <meta name="application-name" content="Discipline Tracker">

  <title>Discipline Tracker</title>
  <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Discipline Tracker&quot;,&quot;short_name&quot;:&quot;Discipline&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%231e1b4b&quot;,&quot;theme_color&quot;:&quot;%231e1b4b&quot;}">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap');

    * {
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    .mono {
      font-family: 'Space Mono', monospace;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.8); }
    }

    .animate-pulse-red {
      animation: pulse-red 1.5s ease-in-out infinite;
    }

    .animate-slide-in {
      animation: slideIn 0.3s ease-out;
    }

    .animate-flicker {
      animation: flicker 1.5s ease-in-out infinite;
    }

    .habit-btn {
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .habit-btn:active {
      transform: scale(0.95);
    }

    .glass {
      background: rgba(15, 15, 35, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }

    .glow {
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.2);
    }

    body {
      overscroll-behavior: none;
      background: #0a0a1a;
    }

    /* Tier-based dynamic backgrounds - refined */
    @keyframes goldAura {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes crisisGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(0.9); }
    }

    .tier-elite {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.08), rgba(139, 92, 246, 0.03), rgba(212, 175, 55, 0.08));
      background-size: 200% 200%;
      animation: goldAura 6s ease-in-out infinite;
    }

    .tier-solid {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.06), rgba(139, 92, 246, 0.03));
    }

    .tier-decent {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.06), rgba(139, 92, 246, 0.03));
    }

    .tier-struggling {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(139, 92, 246, 0.03));
    }

    .tier-crisis {
      animation: crisisGlow 2s ease-in-out infinite;
    }

    /* Sunset dimming effect */
    .sunset-dimming {
      filter: brightness(0.92) saturate(0.9);
      transition: filter 0.5s ease;
    }

    .sunset-warning::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, #f97316, transparent);
      animation: slideIn 0.5s ease-out;
    }

    /* Ghost streak styling */
    .ghost-streak {
      position: absolute;
      opacity: 0.2;
      font-size: 2.5rem;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    /* Sparkline styles */
    .sparkline {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 24px;
    }

    .sparkline-bar {
      width: 4px;
      border-radius: 1px;
      transition: height 0.3s ease;
    }

    /* Long press animation */
    @keyframes longPressProgress {
      from { width: 0%; }
      to { width: 100%; }
    }

    .long-press-indicator {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #6366f1);
      border-radius: 0 0 8px 8px;
    }

    /* Swipe hint */
    .swipe-hint {
      opacity: 0.5;
      font-size: 10px;
      text-align: center;
      padding: 4px;
    }

    /* Stealth mode */
    .stealth-mode .habit-icon {
      font-family: 'Space Mono', monospace;
      font-size: 0.9rem;
    }

    /* 30-Day Heatmap styles */
    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      border-radius: 3px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .heatmap-cell:hover {
      transform: scale(1.2);
      z-index: 10;
    }

    .heatmap-level-0 { background: rgba(255, 255, 255, 0.03); }
    .heatmap-level-1 { background: rgba(99, 102, 241, 0.25); }
    .heatmap-level-2 { background: rgba(99, 102, 241, 0.45); }
    .heatmap-level-3 { background: rgba(99, 102, 241, 0.65); }
    .heatmap-level-4 { background: rgba(16, 185, 129, 0.75); }

    /* Page flip animation */
    @keyframes pageFlip {
      0% { transform: rotateY(0deg); }
      50% { transform: rotateY(-20deg); }
      100% { transform: rotateY(0deg); }
    }

    .page-flip {
      animation: pageFlip 0.3s ease-out;
    }

    @keyframes pagePop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    .page-pop {
      animation: pagePop 0.2s ease-out;
    }

    /* Counter button styles */
    .counter-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.15s ease;
      user-select: none;
    }

    .counter-btn:active {
      transform: scale(0.9);
    }

    .counter-btn-plus {
      background: linear-gradient(135deg, #059669, #047857);
      color: white;
      box-shadow: 0 2px 10px rgba(5, 150, 105, 0.3);
    }

    .counter-btn-minus {
      background: rgba(255, 255, 255, 0.1);
      color: #a78bfa;
    }

    .counter-btn-minus:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .counter-display {
      min-width: 40px;
      text-align: center;
      font-weight: bold;
      font-family: 'Space Mono', monospace;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ============================================================================
    // CONSTANTS & CONFIGURATION
    // ============================================================================

    // Week starts Sunday Jan 25, 2026 (use local timezone to avoid date shift)
    const JOURNEY_START = new Date(2026, 0, 25); // Month is 0-indexed (0 = January)
    const STORAGE_KEY = 'discipline-tracker-v5'; // Bump version for date fix
    const SHEETS_CONFIG_KEY = 'discipline-tracker-sheets-config';

    // HABITS ordered by importance (Progressive Disclosure - critical at top)
    const HABITS = [
      // TIER 1: Neural & Core (High-value habits)
      { id: 'nofap', name: 'Dopamine Baseline', icon: 'ðŸ’Ž', points: 3, stealthName: 'CORE_01', stealthIcon: 'â—†' },
      { id: 'sleep', name: 'Sleep', icon: 'ðŸ˜´', points: 2, isTime: true, stealthName: 'REST_01', stealthIcon: 'â—' },
      { id: 'sunset', name: 'Digital Sunset', icon: 'ðŸ“µ', points: 1, isTime: true, stealthName: 'SYNC_01', stealthIcon: 'â—‘' },

      // TIER 2: Nutrition (Body fuel)
      { id: 'lunch', name: 'Lunch', icon: 'ðŸ³', points: 2, stealthName: 'FUEL_01', stealthIcon: 'â–²' },
      { id: 'dinner', name: 'Dinner', icon: 'ðŸ½ï¸', points: 2, stealthName: 'FUEL_02', stealthIcon: 'â–¼' },
      { id: 'loseit', name: 'Diet Logged', icon: 'ðŸ¥—', points: 2, stealthName: 'LOG_01', stealthIcon: 'â—‡' },

      // TIER 3: Physical (Movement)
      { id: 'gym', name: 'Gym', icon: 'ðŸ’ª', points: 1, stealthName: 'MOVE_01', stealthIcon: 'â—' },
      { id: 'yoga', name: 'Yoga', icon: 'ðŸ§˜', points: 1, stealthName: 'MOVE_02', stealthIcon: 'â—‹' },

      // TIER 4: Mind & Spirit
      { id: 'meditation', name: 'Meditation', icon: 'ðŸ§˜â€â™‚ï¸', points: 1, stealthName: 'MIND_01', stealthIcon: 'â—Ž' },
      { id: 'prayer', name: 'Hanuman Chalisa', icon: 'ðŸ™', points: 1, stealthName: 'MIND_02', stealthIcon: 'âœ§' },
      { id: 'journal', name: 'Journaling', icon: 'ðŸ“', points: 1, stealthName: 'MIND_03', stealthIcon: 'â–¢' },
      { id: 'reading', name: 'Reading', icon: 'ðŸ“š', points: 2, stealthName: 'GROW_01', stealthIcon: 'â–£' },
      { id: 'career', name: 'Career Dev', icon: 'ðŸš€', points: 1, stealthName: 'GROW_02', stealthIcon: 'â–³' },

      // TIER 5: Maintenance (Low-stakes)
      { id: 'laundry', name: 'Laundry', icon: 'ðŸ§º', points: 1, stealthName: 'MAINT_01', stealthIcon: 'â–½' },
      { id: 'dishes', name: 'Dishes', icon: 'ðŸ½ï¸', points: 1, stealthName: 'MAINT_02', stealthIcon: 'â—' },
      { id: 'cleaning', name: 'Cleaning', icon: 'ðŸ§¹', points: 1, stealthName: 'MAINT_03', stealthIcon: 'â–·' }
    ];

    const TIERS = {
      ELITE: { name: 'ELITE', min: 94, icon: 'ðŸ‘‘', color: 'from-yellow-400 to-amber-600', reward: 100 },
      SOLID: { name: 'SOLID', min: 83, icon: 'ðŸ’ª', color: 'from-blue-400 to-blue-600', reward: 60 },
      DECENT: { name: 'DECENT', min: 70, icon: 'âœ“', color: 'from-green-400 to-green-600', reward: 30 },
      STRUGGLING: { name: 'STRUGGLING', min: 55, icon: 'âš ï¸', color: 'from-orange-400 to-red-500', penalty: 75 },
      CRISIS: { name: 'CRISIS', min: 0, icon: 'ðŸš¨', color: 'from-rose-600 to-red-800', penalty: 200 }
    };

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================

    // Generate time slots from 10 PM to 4 AM (in 15-min increments)
    const TIME_SLOTS = (() => {
      const slots = [];
      // 10 PM to 11:45 PM (22:00 - 23:45)
      for (let h = 22; h <= 23; h++) {
        for (let m = 0; m < 60; m += 15) {
          const hour24 = h.toString().padStart(2, '0');
          const min = m.toString().padStart(2, '0');
          const hour12 = h > 12 ? h - 12 : h;
          const ampm = 'PM';
          slots.push({
            value: `${hour24}:${min}`,
            label: `${hour12}:${min} ${ampm}`
          });
        }
      }
      // 12 AM to 4 AM (00:00 - 04:00)
      for (let h = 0; h <= 4; h++) {
        for (let m = 0; m < 60; m += 15) {
          if (h === 4 && m > 0) break; // Stop at 4:00 AM
          const hour24 = h.toString().padStart(2, '0');
          const min = m.toString().padStart(2, '0');
          const hour12 = h === 0 ? 12 : h;
          slots.push({
            value: `${hour24}:${min}`,
            label: `${hour12}:${min} AM`
          });
        }
      }
      return slots;
    })();

    const isSameDay = (d1, d2) => {
      return d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate();
    };

    const isPastDay = (dateStr) => {
      const date = new Date(dateStr);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      date.setHours(0, 0, 0, 0);
      return date < today;
    };

    const isFutureDay = (dateStr) => {
      const date = new Date(dateStr);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      date.setHours(0, 0, 0, 0);
      return date > today;
    };

    const formatDate = (dateStr) => {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    };

    // Check if a day is Friday or Saturday (weekend buffer days)
    const isWeekendDay = (dateStr) => {
      const date = new Date(dateStr);
      const day = date.getDay();
      return day === 5 || day === 6; // Friday = 5, Saturday = 6
    };

    // Check if a day is Sunday
    const isSunday = (dateStr) => {
      const date = new Date(dateStr);
      return date.getDay() === 0;
    };

    // Calculate sleep points based on time (Sleep Velocity)
    // 10:30 PM = +2 (Elite), 11:00 PM = +1 (Goal), 11:30 PM = 0, 12:30 AM+ = -1 (Penalty)
    const calculateSleepPoints = (sleepTimeStr, isWeekend) => {
      if (!sleepTimeStr) return 0;
      if (isWeekend) return 1; // Flat reward for Friday/Saturday (Free-Roam)

      const [hours, minutes] = sleepTimeStr.split(':').map(Number);
      // Convert to minutes from midnight, handling late night (after midnight)
      let totalMinutes = hours * 60 + minutes;
      // If time is between 00:00-06:00, treat as late night (add 24h worth)
      if (hours < 6) totalMinutes += 24 * 60;

      // 22:30 (10:30 PM) = 1350 mins, 23:00 (11:00 PM) = 1380 mins
      // 23:30 (11:30 PM) = 1410 mins, 00:30 (12:30 AM) = 1470 mins
      if (totalMinutes <= 1350) return 2;  // Elite: 10:30 PM or earlier
      if (totalMinutes <= 1380) return 1;  // Goal: 11:00 PM or earlier
      if (totalMinutes <= 1410) return 0;  // Baseline: 11:30 PM
      if (totalMinutes >= 1470) return -1; // Penalty: 12:30 AM or later
      return 0;
    };

    // Calculate sunset points (Digital Sunset by 10:00 PM)
    const calculateSunsetPoints = (sunsetTimeStr, isWeekend) => {
      if (!sunsetTimeStr) return 0;
      if (isWeekend) return 1; // Auto-point for weekend

      const [hours, minutes] = sunsetTimeStr.split(':').map(Number);
      let totalMinutes = hours * 60 + minutes;
      if (hours < 6) totalMinutes += 24 * 60;

      // 22:00 (10:00 PM) = 1320 mins
      return totalMinutes <= 1320 ? 1 : 0;
    };

    // Check if Sunday sleep was on time (for Monday career penalty)
    const wasSundaySleepOnTime = (week) => {
      // Find Sunday in the week (day index where getDay() === 0)
      const sundayDay = week.days.find(d => isSunday(d.date));
      if (!sundayDay || !sundayDay.sleepTime) return true; // Default to true if no data

      const sleepPoints = calculateSleepPoints(sundayDay.sleepTime, false);
      return sleepPoints >= 1; // Must be at goal (11:00 PM) or better
    };

    const createEmptyDay = (date) => ({
      date: date.toISOString(),
      habits: {
        nofap: 0, gym: 0, yoga: 0, lunch: 0, dinner: 0, loseit: 0,
        laundry: 0, dishes: 0, cleaning: 0, meditation: 0,
        prayer: 0, sunset: 0, sleep: 0, journal: 0, reading: 0, career: 0
      },
      pagesRead: 0,
      sleepTime: null,      // Store actual sleep time (HH:MM format)
      sunsetTime: null,     // Store sunset/device lockdown time
      isVitalRest: false,   // Vital Rest Day (auto-awards gym point)
      completedTasks: [],
      isOffDay: false,
      isLocked: false,
      isFilled: false,
      lastUpdated: null
    });

    const createWeek = (startDate) => {
      const days = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        days.push(createEmptyDay(date));
      }
      return { startDate: startDate.toISOString(), days };
    };

    const initializeState = () => {
      return {
        version: "4.0",
        currentWeek: 0,
        weeks: [createWeek(JOURNEY_START)],
        adHocTasks: [],
        streakDays: 0,
        longestStreak: 0,
        guiltFreeBalance: 0,
        nreBalance: 0,
        journeyStartDate: JOURNEY_START.toISOString(),
        viewMode: "today",
        lastModified: Date.now(), // For collision detection
        deviceId: Math.random().toString(36).substring(7) // Unique device identifier
      };
    };

    // ============================================================================
    // STORAGE FUNCTIONS
    // ============================================================================

    const loadFromStorage = () => {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (e) {
        console.error('Failed to load from localStorage:', e);
      }
      return null;
    };

    const saveToStorage = (data) => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('Failed to save to localStorage:', e);
      }
    };

    // ============================================================================
    // SCORING LOGIC
    // ============================================================================

    // Calculate core habit score (excludes bonus tasks)
    // Now accepts week for Sunday Reset clause and Vital Rest validation
    const calculateCoreScore = (day, week = null) => {
      if (day.isOffDay) return 0;

      const isWeekend = isWeekendDay(day.date);
      const isMonday = new Date(day.date).getDay() === 1;

      let score = 0;
      HABITS.forEach(habit => {
        if (habit.id === 'reading') {
          // Quantitative reading: 1pt per 20 pages
          score += Math.floor((day.pagesRead || 0) / 20);
        } else if (habit.id === 'sleep') {
          // Sleep Velocity: Variable points based on time
          score += calculateSleepPoints(day.sleepTime, isWeekend);
        } else if (habit.id === 'sunset') {
          // Digital Sunset: 1pt if locked by 10 PM
          score += calculateSunsetPoints(day.sunsetTime, isWeekend);
        } else if (habit.id === 'gym') {
          // Vital Rest Day: Auto-award 1pt if marked as rest day
          if (day.isVitalRest) {
            score += 1; // Recovery point
          } else {
            score += day.habits[habit.id];
          }
        } else if (habit.id === 'career') {
          // Sunday Reset Clause: If Sunday sleep was late, halve Monday career points
          let careerPoints = day.habits[habit.id];
          if (isMonday && week && !wasSundaySleepOnTime(week)) {
            careerPoints = Math.floor(careerPoints / 2);
          }
          score += careerPoints;
        } else {
          score += day.habits[habit.id];
        }
      });

      return score;
    };

    // Count vital rest days used in a week
    const countVitalRestDays = (week) => {
      return week.days.filter(d => d.isVitalRest).length;
    };

    // Calculate bonus task score
    const calculateBonusScore = (day, tasks) => {
      if (day.isOffDay) return 0;

      let score = 0;
      day.completedTasks.forEach(taskId => {
        const task = tasks.find(t => t.id === taskId);
        if (task) score += task.points;
      });

      return score;
    };

    const calculateDailyScore = (day, tasks, week = null) => {
      return calculateCoreScore(day, week) + calculateBonusScore(day, tasks);
    };

    const calculateWeekStats = (week, tasks, streakDays) => {
      const activeDaysCount = week.days.filter(d => !d.isOffDay).length;
      const activeRatio = activeDaysCount / 7;

      // Calculate core and bonus scores separately (pass week for Sunday Reset)
      const dailyCoreScores = week.days.map(day => calculateCoreScore(day, week));
      const dailyBonusScores = week.days.map(day => calculateBonusScore(day, tasks));
      const dailyScores = week.days.map(day => calculateDailyScore(day, tasks, week));

      const weeklyCoreScore = dailyCoreScores.reduce((sum, s) => sum + s, 0);
      const weeklyBonusScore = dailyBonusScores.reduce((sum, s) => sum + s, 0);
      const weeklyRawScore = dailyScores.reduce((sum, s) => sum + s, 0);

      // Proportional meal slack: 20% of total possible meals for active days
      let mealsSkipped = 0;
      week.days.forEach(day => {
        if (!day.isOffDay) {
          if (day.habits.lunch === 0) mealsSkipped++;
          if (day.habits.dinner === 0) mealsSkipped++;
        }
      });

      const freeMealAllowance = Math.floor((activeDaysCount * 2) * 0.2); // 20% slack
      const extraMealsSkipped = Math.max(0, mealsSkipped - freeMealAllowance);
      const mealPenalty = extraMealsSkipped * 2;

      const baseScore = weeklyRawScore - mealPenalty;

      const streakBonus =
        streakDays >= 30 ? 20 :
        streakDays >= 21 ? 15 :
        streakDays >= 14 ? 10 :
        streakDays >= 7 ? 5 : 0;

      const totalScore = baseScore + streakBonus;

      // Dynamic tier thresholds based on active days
      const dynamicThresholds = {
        elite: Math.round(94 * activeRatio),
        solid: Math.round(83 * activeRatio),
        decent: Math.round(70 * activeRatio),
        struggling: Math.round(55 * activeRatio)
      };

      // Core score threshold for bonus eligibility (60% of core max)
      const maxCoreScore = activeDaysCount * 19; // Max possible core score per day
      const coreThreshold = maxCoreScore * 0.6;
      const bonusEligible = weeklyCoreScore >= coreThreshold;

      // Calculate effective score: bonus only counts if core threshold met
      const effectiveScore = bonusEligible ? totalScore : (totalScore - weeklyBonusScore);

      let tier = TIERS.CRISIS;
      if (effectiveScore >= dynamicThresholds.elite) tier = TIERS.ELITE;
      else if (effectiveScore >= dynamicThresholds.solid) tier = TIERS.SOLID;
      else if (effectiveScore >= dynamicThresholds.decent) tier = TIERS.DECENT;
      else if (effectiveScore >= dynamicThresholds.struggling) tier = TIERS.STRUGGLING;

      return {
        dailyScores,
        weeklyCoreScore,
        weeklyBonusScore,
        weeklyRawScore,
        mealsSkipped,
        freeMealAllowance,
        mealPenalty,
        baseScore,
        streakBonus,
        totalScore,
        effectiveScore,
        tier,
        dynamicThresholds,
        activeDaysCount,
        bonusEligible,
        coreThreshold
      };
    };

    // ============================================================================
    // MAIN COMPONENT
    // ============================================================================

    function DisciplineTracker() {
      const [state, setState] = useState(null);
      const [showTaskModal, setShowTaskModal] = useState(false);
      const [showInfoModal, setShowInfoModal] = useState(false);
      const [showBackfillPrompt, setShowBackfillPrompt] = useState(false);
      const [showSheetsModal, setShowSheetsModal] = useState(false);
      const [isLoaded, setIsLoaded] = useState(false);
      const [stealthMode, setStealthMode] = useState(false);
      const [isSunsetWarning, setIsSunsetWarning] = useState(false);
      const [lastSaved, setLastSaved] = useState(Date.now());
      const [longPressTimer, setLongPressTimer] = useState(null);
      const [longPressProgress, setLongPressProgress] = useState(0);
      const [touchStart, setTouchStart] = useState(null);
      const [pageFlipAnim, setPageFlipAnim] = useState(null); // Track which day is animating
      const [sheetsConfig, setSheetsConfig] = useState(null);
      const [syncStatus, setSyncStatus] = useState('disconnected'); // disconnected, syncing, synced, error
      const [showConflictModal, setShowConflictModal] = useState(false);
      const [conflictData, setConflictData] = useState(null); // { local, remote }

      // Haptic feedback utility
      const triggerHaptic = (type = 'light') => {
        if ('vibrate' in navigator) {
          switch(type) {
            case 'heavy': navigator.vibrate(50); break;  // Core habit
            case 'medium': navigator.vibrate(30); break; // Regular habit
            case 'light': navigator.vibrate(15); break;  // Bonus task
            case 'sparkle': navigator.vibrate([10, 30, 10]); break; // Special
            default: navigator.vibrate(20);
          }
        }
      };

      // Check if we're in sunset warning period (30 mins before 10 PM)
      useEffect(() => {
        const checkSunsetWarning = () => {
          const now = new Date();
          const hours = now.getHours();
          const minutes = now.getMinutes();
          const totalMins = hours * 60 + minutes;
          // 21:30 (9:30 PM) = 1290 mins, 22:00 (10 PM) = 1320 mins
          setIsSunsetWarning(totalMins >= 1290 && totalMins < 1320);
        };
        checkSunsetWarning();
        const interval = setInterval(checkSunsetWarning, 60000); // Check every minute
        return () => clearInterval(interval);
      }, []);

      // Touch handlers for swipe gestures
      const handleTouchStart = (e) => {
        setTouchStart(e.touches[0].clientX);
      };

      const handleTouchEnd = (e, navigateWeek) => {
        if (!touchStart) return;
        const touchEnd = e.changedTouches[0].clientX;
        const diff = touchStart - touchEnd;
        if (Math.abs(diff) > 100) { // Minimum swipe distance
          if (diff > 0) {
            navigateWeek('next');
          } else {
            navigateWeek('prev');
          }
        }
        setTouchStart(null);
      };

      // Long press handlers for Vital Rest
      const startLongPress = (dayIndex, callback) => {
        setLongPressProgress(0);
        const timer = setInterval(() => {
          setLongPressProgress(prev => {
            if (prev >= 100) {
              clearInterval(timer);
              callback(dayIndex);
              triggerHaptic('heavy');
              return 0;
            }
            return prev + 10;
          });
        }, 80); // 800ms total for full press
        setLongPressTimer(timer);
      };

      const cancelLongPress = () => {
        if (longPressTimer) {
          clearInterval(longPressTimer);
          setLongPressTimer(null);
        }
        setLongPressProgress(0);
      };

      useEffect(() => {
        const stored = loadFromStorage();
        if (stored) {
          setState(stored);
        } else {
          const initial = initializeState();
          setState(initial);
          saveToStorage(initial);

          const unfilledPastDays = initial.weeks[0].days.filter(d =>
            isPastDay(d.date) && !d.isFilled && !d.isOffDay
          );
          if (unfilledPastDays.length > 0) {
            setShowBackfillPrompt(true);
          }
        }

        // Load Google Sheets config
        try {
          const sheetsConfigStored = localStorage.getItem(SHEETS_CONFIG_KEY);
          if (sheetsConfigStored) {
            const config = JSON.parse(sheetsConfigStored);
            setSheetsConfig(config);
            setSyncStatus('synced');
          } else {
            // Prompt for Google Sheets setup on first load
            setTimeout(() => setShowSheetsModal(true), 1500);
          }
        } catch (e) {
          console.error('Failed to load sheets config:', e);
        }

        setIsLoaded(true);
      }, []);

      // Google Sheets sync function
      const syncToGoogleSheets = async (data) => {
        if (!sheetsConfig || !sheetsConfig.webAppUrl) return;

        setSyncStatus('syncing');
        try {
          const response = await fetch(sheetsConfig.webAppUrl, {
            method: 'POST',
            mode: 'no-cors', // Google Apps Script requires this
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'sync',
              data: data,
              timestamp: new Date().toISOString()
            })
          });
          setSyncStatus('synced');
          setLastSaved(Date.now());
        } catch (error) {
          console.error('Sync failed:', error);
          setSyncStatus('error');
        }
      };

      // Save sheets config
      const saveSheetsConfig = (config) => {
        try {
          localStorage.setItem(SHEETS_CONFIG_KEY, JSON.stringify(config));
          setSheetsConfig(config);
          setSyncStatus('synced');
          setShowSheetsModal(false);
        } catch (e) {
          console.error('Failed to save sheets config:', e);
        }
      };

      // Collision detection: check if another device/tab modified the data
      const checkForConflict = (newState) => {
        const storedRaw = localStorage.getItem(STORAGE_KEY);
        if (!storedRaw) return false;

        try {
          const stored = JSON.parse(storedRaw);
          // If stored version has a newer timestamp and different device ID, there's a conflict
          if (stored.lastModified && stored.deviceId &&
              stored.lastModified > (state?.lastModified || 0) &&
              stored.deviceId !== newState.deviceId) {
            return stored;
          }
        } catch (e) {
          console.error('Error checking for conflict:', e);
        }
        return false;
      };

      const saveState = (newState, forceOverwrite = false) => {
        // Update lastModified timestamp
        newState.lastModified = Date.now();
        newState.deviceId = state?.deviceId || newState.deviceId;

        // Check for conflicts (unless forcing overwrite)
        if (!forceOverwrite) {
          const conflict = checkForConflict(newState);
          if (conflict) {
            setConflictData({ local: newState, remote: conflict });
            setShowConflictModal(true);
            return; // Don't save until conflict is resolved
          }
        }

        setState(newState);
        saveToStorage(newState);
        setLastSaved(Date.now());

        // Also sync to Google Sheets if configured
        if (sheetsConfig && sheetsConfig.webAppUrl) {
          syncToGoogleSheets(newState);
        }
      };

      // Resolve conflict by choosing local or remote data
      const resolveConflict = (choice) => {
        if (choice === 'local' && conflictData?.local) {
          saveState(conflictData.local, true); // Force overwrite
        } else if (choice === 'remote' && conflictData?.remote) {
          setState(conflictData.remote);
          setLastSaved(Date.now());
        }
        setConflictData(null);
        setShowConflictModal(false);
      };

      const stats = useMemo(() => {
        if (!state) return null;
        const week = state.weeks[state.currentWeek];
        return calculateWeekStats(week, state.adHocTasks, state.streakDays);
      }, [state]);

      // Calculate sparkline data (7-day score trend)
      const sparklineData = useMemo(() => {
        if (!state || !stats) return [];
        const week = state.weeks[state.currentWeek];
        return week.days.map((day, idx) => {
          const score = calculateDailyScore(day, state.adHocTasks, week);
          const maxPossible = 21; // Rough max daily score
          return {
            score,
            percent: Math.min(100, (score / maxPossible) * 100),
            isFuture: isFutureDay(day.date),
            isToday: isSameDay(new Date(day.date), new Date())
          };
        });
      }, [state, stats]);

      // Calculate 30-day heatmap data (GitHub-style contribution graph)
      const heatmapData = useMemo(() => {
        if (!state) return [];
        const today = new Date();
        const data = [];

        // Go back 35 days to fill a 5-row x 7-col grid
        for (let i = 34; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split('T')[0];

          // Find this day in any week
          let dayData = null;
          let week = null;
          for (const w of state.weeks) {
            const found = w.days.find(d => d.date.split('T')[0] === dateStr);
            if (found) {
              dayData = found;
              week = w;
              break;
            }
          }

          let level = 0;
          let score = 0;
          if (dayData && !dayData.isOffDay) {
            score = calculateDailyScore(dayData, state.adHocTasks, week);
            // Map score to level 0-4
            if (score >= 18) level = 4;      // Elite day
            else if (score >= 14) level = 3; // Great day
            else if (score >= 10) level = 2; // Good day
            else if (score >= 5) level = 1;  // Some effort
            else level = 0;                   // Minimal
          } else if (dayData && dayData.isOffDay) {
            level = -1; // Off day marker
          }

          data.push({
            date: dateStr,
            level,
            score,
            isToday: i === 0,
            isFuture: date > today,
            isOffDay: dayData?.isOffDay || false
          });
        }
        return data;
      }, [state]);

      // Get tier class for dynamic background
      const getTierClass = () => {
        if (!stats) return '';
        switch(stats.tier.name) {
          case 'ELITE': return 'tier-elite';
          case 'SOLID': return 'tier-solid';
          case 'DECENT': return 'tier-decent';
          case 'STRUGGLING': return 'tier-struggling';
          case 'CRISIS': return 'tier-crisis';
          default: return '';
        }
      };

      if (!isLoaded || !state) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-950 via-indigo-950 to-slate-950 flex items-center justify-center">
            <div className="text-white text-2xl font-bold animate-pulse">Loading...</div>
          </div>
        );
      }

      const currentWeek = state.weeks[state.currentWeek];
      const today = new Date();
      const todayDay = currentWeek.days.find(d => isSameDay(new Date(d.date), today));

      const toggleHabit = (dayIndex, habitId) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;
        if (habitId === 'reading' || habitId === 'sleep' || habitId === 'sunset' || habitId === 'weight') return; // These use separate inputs

        const habit = HABITS.find(h => h.id === habitId);
        const currentValue = day.habits[habitId];
        const newValue = currentValue === habit.points ? 0 : habit.points;

        // Haptic feedback based on habit importance
        if (newValue > 0) {
          if (habit.points >= 3) {
            triggerHaptic('heavy');  // Core habits (Dopamine Baseline)
          } else if (habit.points >= 2) {
            triggerHaptic('medium'); // Important habits
          } else {
            triggerHaptic('light');  // Regular habits
          }
        }

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].habits[habitId] = newValue;
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        if (habitId === 'nofap') {
          if (newValue === 3) {
            newState.streakDays++;
            if (newState.streakDays > newState.longestStreak) {
              newState.longestStreak = newState.streakDays;
            }
          } else {
            newState.streakDays = 0;
          }
        }

        saveState(newState);
        setLastSaved(Date.now());
      };

      const updateReading = (dayIndex, pages) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].pagesRead = Math.max(0, parseInt(pages) || 0);
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        saveState(newState);
      };

      const updateSleepTime = (dayIndex, time) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].sleepTime = time;
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        saveState(newState);
      };

      const updateSunsetTime = (dayIndex, time) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].sunsetTime = time;
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        saveState(newState);
      };

      const toggleVitalRest = (dayIndex) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        // Check if already at max (2) vital rest days this week
        const restCount = countVitalRestDays(currentWeek);
        if (!day.isVitalRest && restCount >= 2) {
          alert('Maximum 2 Vital Rest days per week');
          return;
        }

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].isVitalRest = !day.isVitalRest;
        // If marking as vital rest, clear gym habit (it's auto-awarded)
        if (newState.weeks[state.currentWeek].days[dayIndex].isVitalRest) {
          newState.weeks[state.currentWeek].days[dayIndex].habits.gym = 0;
        }
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        saveState(newState);
      };

      // Check if a day was backfilled (updated more than 24h after the day's date)
      const isBackfilled = (day) => {
        if (!day.lastUpdated) return false;
        const dayDate = new Date(day.date);
        const updateDate = new Date(day.lastUpdated);
        const hoursDiff = (updateDate - dayDate) / (1000 * 60 * 60);
        return hoursDiff > 24;
      };

      const toggleOffDay = (dayIndex) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked) return;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].isOffDay = !day.isOffDay;
        if (newState.weeks[state.currentWeek].days[dayIndex].isOffDay) {
          newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        }
        saveState(newState);
      };

      const toggleLock = (dayIndex) => {
        const day = currentWeek.days[dayIndex];
        if (day.isOffDay) return;
        if (!day.isFilled && !day.isLocked) {
          alert('Fill in data before locking this day');
          return;
        }

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].isLocked = !day.isLocked;
        saveState(newState);
      };

      const toggleTask = (dayIndex, taskId) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        const newState = JSON.parse(JSON.stringify(state));
        const completedTasks = newState.weeks[state.currentWeek].days[dayIndex].completedTasks;

        if (completedTasks.includes(taskId)) {
          newState.weeks[state.currentWeek].days[dayIndex].completedTasks =
            completedTasks.filter(id => id !== taskId);
        } else {
          newState.weeks[state.currentWeek].days[dayIndex].completedTasks.push(taskId);
          triggerHaptic('sparkle'); // Special sparkle vibration for bonus tasks
        }

        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        saveState(newState);
        setLastSaved(Date.now());
      };

      const addTask = (name, points) => {
        const newState = JSON.parse(JSON.stringify(state));
        newState.adHocTasks.push({
          id: Date.now().toString(),
          name,
          points
        });
        saveState(newState);
        setShowTaskModal(false);
      };

      const deleteTask = (taskId) => {
        const newState = JSON.parse(JSON.stringify(state));
        newState.adHocTasks = newState.adHocTasks.filter(t => t.id !== taskId);

        newState.weeks.forEach(week => {
          week.days.forEach(day => {
            day.completedTasks = day.completedTasks.filter(id => id !== taskId);
          });
        });

        saveState(newState);
      };

      const switchViewMode = (mode) => {
        const newState = JSON.parse(JSON.stringify(state));
        newState.viewMode = mode;
        saveState(newState);
      };

      const daysToShow = state.viewMode === 'today' ? (todayDay ? [todayDay] : []) : currentWeek.days;

      // Week navigation for swipe gestures
      const navigateWeek = (direction) => {
        // Placeholder for multi-week navigation
        triggerHaptic('light');
      };

      return (
        <div
          className={`min-h-screen bg-gradient-to-br from-slate-950 via-indigo-950 to-slate-950 text-white ${getTierClass()} ${isSunsetWarning ? 'sunset-dimming sunset-warning' : ''} ${stealthMode ? 'stealth-mode' : ''}`}
          onTouchStart={handleTouchStart}
          onTouchEnd={(e) => handleTouchEnd(e, navigateWeek)}
        >
          <div className="container mx-auto px-4 py-8 max-w-2xl">
            {/* Header */}
            <div className="text-center mb-8 animate-slide-in relative">
              {/* Stealth Mode Toggle (left) */}
              <button
                onClick={() => {
                  setStealthMode(!stealthMode);
                  triggerHaptic('sparkle');
                }}
                className={`absolute left-0 top-0 w-10 h-10 rounded-full glass flex items-center justify-center transition-all ${stealthMode ? 'bg-purple-500/30 text-white' : 'text-purple-300 hover:bg-white/10'}`}
                title="Stealth Mode"
              >
                {stealthMode ? 'â—ˆ' : 'â—‡'}
              </button>

              {/* Info Button (right) */}
              <button
                onClick={() => setShowInfoModal(true)}
                className="absolute right-0 top-0 w-10 h-10 rounded-full glass flex items-center justify-center text-purple-300 hover:bg-white/10 transition-all"
              >
                ?
              </button>

              <h1 className="text-4xl sm:text-5xl font-black mb-2 bg-gradient-to-r from-violet-300 via-fuchsia-300 to-violet-300 bg-clip-text text-transparent">
                {stealthMode ? 'SYSTEM TRACKER' : 'DISCIPLINE TRACKER'}
              </h1>
              <p className="text-purple-300 text-sm mono">{stealthMode ? 'Protocol Active' : 'Level Up or Pay Up'}</p>

              {/* Sparkline - Discipline Velocity */}
              <div className="mt-4 flex justify-center">
                <div className="sparkline">
                  {sparklineData.map((day, idx) => (
                    <div
                      key={idx}
                      className="sparkline-bar"
                      style={{
                        height: day.isFuture ? '4px' : `${Math.max(4, day.percent)}%`,
                        background: day.isFuture
                          ? 'rgba(99, 102, 241, 0.15)'
                          : day.isToday
                          ? 'linear-gradient(to top, #8b5cf6, #6366f1)'
                          : day.percent >= 70
                          ? 'linear-gradient(to top, #059669, #10b981)'
                          : day.percent >= 50
                          ? 'linear-gradient(to top, #d97706, #f59e0b)'
                          : 'linear-gradient(to top, #dc2626, #ef4444)'
                      }}
                      title={`Day ${idx + 1}: ${day.score} pts`}
                    />
                  ))}
                </div>
                <span className="ml-2 text-[10px] text-indigo-400 self-center mono">7D</span>
              </div>

              {/* Sunset Warning */}
              {isSunsetWarning && (
                <div className="mt-2 text-xs text-amber-400 animate-pulse">
                  Digital Sunset in 30 minutes...
                </div>
              )}
            </div>

            {/* Stats Cards */}
            <div className="grid grid-cols-3 gap-3 mb-6 animate-slide-in">
              <div className="glass rounded-xl p-4 text-center relative overflow-hidden">
                {/* Ghost Streak (longest streak behind current) */}
                {state.longestStreak > state.streakDays && (
                  <div className="ghost-streak mono font-black text-purple-400">
                    {state.longestStreak}
                  </div>
                )}

                {/* Streak flame with color progression */}
                <div className={`text-2xl mb-1 animate-flicker relative z-10 ${
                  state.streakDays >= 30 ? 'text-blue-400' :
                  state.streakDays >= 14 ? 'text-orange-400' :
                  'text-white'
                }`}>
                  <svg className="w-8 h-8 mx-auto" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 23c-4.97 0-9-3.58-9-8 0-3.07 2.31-5.64 5.5-7.27.5-.25 1.04.21.87.75-.35 1.1-.37 2.33.12 3.52.39.94 1.01 1.73 1.76 2.32.35.27.87.12 1.02-.3.47-1.3 1.33-2.3 2.48-2.87.45-.23.96.12.93.62-.07 1.12.19 2.08.78 2.88.36.48.88.86 1.46 1.1.38.15.81-.08.9-.48.4-1.76 1.58-3.15 3.18-3.77.52-.2 1.04.26.91.79C21.13 16.61 17.13 23 12 23z"/>
                  </svg>
                </div>
                <div className="text-2xl font-bold relative z-10">{state.streakDays}</div>
                <div className="text-xs text-purple-300 mono relative z-10">{stealthMode ? 'CNT' : 'STREAK'}</div>
                <div className="text-xs text-purple-400 mt-1 relative z-10">
                  {state.longestStreak > state.streakDays ? `Chase: ${state.longestStreak}` : `Best: ${state.longestStreak}`}
                </div>
              </div>

              <div className="glass rounded-xl p-4 text-center">
                <div className="text-2xl mb-1">{stats.tier.icon}</div>
                <div className="text-lg font-bold">{stats.effectiveScore}</div>
                <div className="text-xs text-purple-300 mono">POINTS</div>
                <div className="text-xs text-purple-400 mt-1">{stats.tier.name}</div>
                {!stats.bonusEligible && stats.weeklyBonusScore > 0 && (
                  <div className="text-[10px] text-amber-400 mt-1">+{stats.weeklyBonusScore} pending</div>
                )}
              </div>

              <div className={`glass rounded-xl p-4 text-center ${
                stats.tier.penalty ? 'animate-pulse-red' : ''
              }`}>
                <div className="text-2xl mb-1">$</div>
                <div className="text-lg font-bold mono">${state.guiltFreeBalance}</div>
                <div className="text-xs text-purple-300 mono">EARNED</div>
                {state.nreBalance > 0 && (
                  <div className="text-xs text-red-400 mt-1 font-bold">NRE: ${state.nreBalance}</div>
                )}
              </div>
            </div>

            {/* Meal Flexibility */}
            <div className="glass rounded-xl p-4 mb-6 animate-slide-in">
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-sm font-semibold text-purple-300">Meal Flexibility</div>
                  <div className="text-xs text-purple-400 mt-1">
                    {stats.mealsSkipped}/{stats.freeMealAllowance} free skips used
                    {stats.mealPenalty > 0 && <span className="text-red-400"> â€¢ -{stats.mealPenalty}pts penalty</span>}
                  </div>
                  <div className="text-[10px] text-purple-500 mt-1">
                    20% of {stats.activeDaysCount * 2} meals ({stats.activeDaysCount} active days)
                  </div>
                </div>
                <div className="text-3xl">~</div>
              </div>
            </div>

            {/* Tier Thresholds Info */}
            <div className="glass rounded-xl p-4 mb-6 animate-slide-in">
              <div className="text-sm font-semibold text-purple-300 mb-2">Dynamic Targets ({stats.activeDaysCount}/7 days active)</div>
              <div className="grid grid-cols-4 gap-2 text-xs">
                <div className="text-center">
                  <div className="text-yellow-400 font-bold">{stats.dynamicThresholds.elite}+</div>
                  <div className="text-purple-400">Elite</div>
                </div>
                <div className="text-center">
                  <div className="text-blue-400 font-bold">{stats.dynamicThresholds.solid}+</div>
                  <div className="text-purple-400">Solid</div>
                </div>
                <div className="text-center">
                  <div className="text-green-400 font-bold">{stats.dynamicThresholds.decent}+</div>
                  <div className="text-purple-400">Decent</div>
                </div>
                <div className="text-center">
                  <div className="text-orange-400 font-bold">{stats.dynamicThresholds.struggling}+</div>
                  <div className="text-purple-400">Struggle</div>
                </div>
              </div>
            </div>

            {/* Reward/Penalty Card */}
            <div className={`rounded-xl p-6 mb-6 animate-slide-in ${
              stats.tier.reward
                ? 'bg-gradient-to-br from-emerald-600 to-teal-700 glow'
                : 'bg-gradient-to-br from-rose-600 to-red-800 animate-pulse-red'
            }`}>
              <div className="text-center">
                <div className="text-sm font-semibold mb-2 opacity-90">
                  {stats.tier.reward ? 'WEEKLY REWARD' : 'WEEKLY PENALTY'}
                </div>
                <div className="text-5xl font-black mb-2 mono">
                  {stats.tier.reward ? '+' : '-'}${stats.tier.reward || stats.tier.penalty}
                </div>
                <div className="text-sm opacity-90">
                  {stats.tier.reward
                    ? `-> Guilt-Free Fund`
                    : `-> NRE Account (Locked)`}
                </div>
                <div className="text-xs mt-3 opacity-75">
                  Need {stats.dynamicThresholds.decent}+ points to avoid penalty
                </div>
                {!stats.bonusEligible && stats.weeklyBonusScore > 0 && (
                  <div className="text-xs mt-2 bg-black/20 rounded px-2 py-1 inline-block">
                    Core: {stats.weeklyCoreScore}/{Math.round(stats.coreThreshold)} needed for bonus eligibility
                  </div>
                )}
              </div>
            </div>

            {/* View Mode Toggle */}
            <div className="flex gap-2 mb-6 animate-slide-in">
              <button
                onClick={() => switchViewMode('today')}
                className={`flex-1 py-3 rounded-xl font-bold transition-all ${
                  state.viewMode === 'today'
                    ? 'bg-gradient-to-r from-violet-600 to-indigo-600 text-white'
                    : 'glass text-purple-300 hover:bg-white/10'
                }`}
              >
                Today Only
              </button>
              <button
                onClick={() => switchViewMode('all-days')}
                className={`flex-1 py-3 rounded-xl font-bold transition-all ${
                  state.viewMode === 'all-days'
                    ? 'bg-gradient-to-r from-violet-600 to-indigo-600 text-white'
                    : 'glass text-purple-300 hover:bg-white/10'
                }`}
              >
                All Days
              </button>
            </div>

            {/* Days Display */}
            <div className="space-y-4">
              {daysToShow.map((day, dayIndex) => {
                const actualDayIndex = state.viewMode === 'today'
                  ? currentWeek.days.findIndex(d => d.date === day.date)
                  : dayIndex;

                const isPast = isPastDay(day.date);
                const isToday = todayDay && day.date === todayDay.date;
                const isFuture = isFutureDay(day.date);
                const needsBackfill = isPast && !day.isFilled && !day.isOffDay;

                const dayScore = calculateDailyScore(day, state.adHocTasks, currentWeek);

                const wasBackfilled = isBackfilled(day);

                let badge = null;
                let badgeColor = '';
                if (isFuture) {
                  badge = 'Future';
                  badgeColor = 'text-purple-400';
                } else if (isToday) {
                  badge = 'TODAY';
                  badgeColor = 'text-cyan-400 font-bold';
                } else if (needsBackfill) {
                  badge = 'Missing Data';
                  badgeColor = 'text-amber-400';
                } else if (day.isLocked) {
                  badge = wasBackfilled ? 'Locked (Backfilled)' : 'Locked';
                  badgeColor = 'text-blue-400';
                } else if (day.isFilled) {
                  badge = wasBackfilled ? 'Backfilled' : 'Filled';
                  badgeColor = wasBackfilled ? 'text-amber-300' : 'text-green-400';
                }

                return (
                  <div
                    key={day.date}
                    className={`rounded-xl p-6 transition-all animate-slide-in ${
                      isFuture ? 'glass opacity-50' :
                      needsBackfill ? 'bg-amber-500/20 border-2 border-amber-500/50' :
                      day.isOffDay ? 'glass opacity-60' :
                      day.isLocked ? 'bg-blue-500/10 border-2 border-blue-500/50' :
                      'glass'
                    }`}
                    style={{ animationDelay: `${dayIndex * 0.05}s` }}
                  >
                    {/* Day Header */}
                    <div className="flex items-center justify-between mb-4">
                      <div>
                        <div className="text-xl font-bold">{formatDate(day.date)}</div>
                        {badge && <div className={`text-sm ${badgeColor} mono mt-1`}>{badge}</div>}
                      </div>
                      <div className="text-right">
                        <div className="text-3xl font-black mono">{day.isOffDay ? '-' : dayScore}</div>
                        <div className="text-xs text-purple-300 mono">points</div>
                      </div>
                    </div>

                    {!isFuture && !day.isOffDay && (
                      <>
                        {/* Habits Grid */}
                        <div className="grid grid-cols-2 gap-2 mb-4">
                          {HABITS.map(habit => {
                            const isDisabled = day.isLocked;
                            const isWeekend = isWeekendDay(day.date);

                            // Special handling for Sleep (time select 10 PM - 4 AM)
                            if (habit.id === 'sleep') {
                              const sleepTime = day.sleepTime || '';
                              const sleepPoints = calculateSleepPoints(sleepTime, isWeekend);

                              return (
                                <div
                                  key={habit.id}
                                  className={`p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                    isDisabled
                                      ? 'opacity-50 bg-gray-700'
                                      : sleepPoints >= 1
                                      ? 'bg-gradient-to-r from-emerald-600 to-teal-700 text-white'
                                      : sleepPoints < 0
                                      ? 'bg-gradient-to-r from-rose-600 to-red-800 text-white'
                                      : 'bg-white/5 text-purple-300'
                                  }`}
                                >
                                  <span className="flex items-center gap-2">
                                    <span className="text-lg habit-icon">{stealthMode ? habit.stealthIcon : habit.icon}</span>
                                    <span className="text-xs">{stealthMode ? habit.stealthName : (isWeekend ? 'Sleep (Free)' : habit.name)}</span>
                                  </span>
                                  <div className="flex flex-col items-end">
                                    <select
                                      className="w-24 bg-white/20 text-center rounded text-xs p-1 text-white appearance-none cursor-pointer"
                                      value={sleepTime}
                                      onChange={(e) => {
                                        updateSleepTime(actualDayIndex, e.target.value);
                                        if (e.target.value) triggerHaptic('medium');
                                      }}
                                      disabled={isDisabled}
                                    >
                                      <option value="" className="bg-slate-800">Select</option>
                                      {TIME_SLOTS.map(slot => (
                                        <option key={slot.value} value={slot.value} className="bg-slate-800">
                                          {slot.label}
                                        </option>
                                      ))}
                                    </select>
                                    <span className={`text-[10px] mono mt-1 ${sleepPoints < 0 ? 'text-red-300' : 'opacity-75'}`}>
                                      {sleepPoints >= 0 ? '+' : ''}{sleepPoints}pt
                                    </span>
                                  </div>
                                </div>
                              );
                            }

                            // Special handling for Digital Sunset (time select 10 PM - 4 AM)
                            if (habit.id === 'sunset') {
                              const sunsetTime = day.sunsetTime || '';
                              const sunsetPoints = calculateSunsetPoints(sunsetTime, isWeekend);

                              return (
                                <div
                                  key={habit.id}
                                  className={`p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                    isDisabled
                                      ? 'opacity-50 bg-gray-700'
                                      : sunsetPoints >= 1
                                      ? 'bg-gradient-to-r from-emerald-600 to-teal-700 text-white'
                                      : 'bg-white/5 text-purple-300'
                                  }`}
                                >
                                  <span className="flex items-center gap-2">
                                    <span className="text-lg habit-icon">{stealthMode ? habit.stealthIcon : habit.icon}</span>
                                    <span className="text-xs">{stealthMode ? habit.stealthName : (isWeekend ? 'Sunset (Free)' : habit.name)}</span>
                                  </span>
                                  <div className="flex flex-col items-end">
                                    <select
                                      className="w-24 bg-white/20 text-center rounded text-xs p-1 text-white appearance-none cursor-pointer"
                                      value={sunsetTime}
                                      onChange={(e) => {
                                        updateSunsetTime(actualDayIndex, e.target.value);
                                        if (e.target.value) triggerHaptic('light');
                                      }}
                                      disabled={isDisabled}
                                    >
                                      <option value="" className="bg-slate-800">Select</option>
                                      {TIME_SLOTS.map(slot => (
                                        <option key={slot.value} value={slot.value} className="bg-slate-800">
                                          {slot.label}
                                        </option>
                                      ))}
                                    </select>
                                    <span className="text-[10px] mono opacity-75 mt-1">+{sunsetPoints}pt</span>
                                  </div>
                                </div>
                              );
                            }

                            // Special handling for reading (quantitative input with counter)
                            if (habit.id === 'reading') {
                              const pagesRead = day.pagesRead || 0;
                              const readingPoints = Math.floor(pagesRead / 20);
                              const isComplete = pagesRead >= 20;
                              const isAnimating = pageFlipAnim === `${actualDayIndex}-reading`;

                              const incrementPages = () => {
                                if (isDisabled) return;
                                updateReading(actualDayIndex, pagesRead + 5);
                                triggerHaptic('light');
                                setPageFlipAnim(`${actualDayIndex}-reading`);
                                setTimeout(() => setPageFlipAnim(null), 300);
                              };

                              const decrementPages = () => {
                                if (isDisabled || pagesRead <= 0) return;
                                updateReading(actualDayIndex, Math.max(0, pagesRead - 5));
                              };

                              return (
                                <div
                                  key={habit.id}
                                  className={`p-3 rounded-lg font-semibold text-sm ${
                                    isDisabled
                                      ? 'opacity-50 bg-gray-700'
                                      : isComplete
                                      ? 'bg-gradient-to-r from-emerald-600 to-teal-700 text-white'
                                      : 'bg-white/5 text-purple-300'
                                  }`}
                                >
                                  <div className="flex items-center justify-between mb-2">
                                    <span className="flex items-center gap-2">
                                      <span className={`text-lg habit-icon ${isAnimating ? 'page-flip' : ''}`}>
                                        {stealthMode ? habit.stealthIcon : habit.icon}
                                      </span>
                                      <span className="text-xs">{stealthMode ? habit.stealthName : habit.name}</span>
                                    </span>
                                    <span className="text-[10px] mono opacity-75">+{readingPoints}pt</span>
                                  </div>

                                  {/* Counter-style input */}
                                  <div className="flex items-center justify-center gap-2">
                                    <button
                                      onClick={decrementPages}
                                      disabled={isDisabled || pagesRead <= 0}
                                      className={`counter-btn counter-btn-minus ${(isDisabled || pagesRead <= 0) ? 'opacity-30' : ''}`}
                                    >
                                      -
                                    </button>

                                    <div className={`counter-display text-lg ${isAnimating ? 'page-pop' : ''}`}>
                                      {pagesRead}
                                      <span className="text-[10px] opacity-60 ml-1">pg</span>
                                    </div>

                                    <button
                                      onClick={incrementPages}
                                      disabled={isDisabled}
                                      className={`counter-btn counter-btn-plus ${isDisabled ? 'opacity-30' : ''}`}
                                    >
                                      +
                                    </button>
                                  </div>

                                  {/* Progress to next point */}
                                  <div className="mt-2 h-1 bg-white/10 rounded-full overflow-hidden">
                                    <div
                                      className="h-full bg-gradient-to-r from-violet-600 to-indigo-600 transition-all duration-300"
                                      style={{ width: `${(pagesRead % 20) / 20 * 100}%` }}
                                    />
                                  </div>
                                  <div className="text-[9px] text-center mt-1 opacity-60">
                                    {20 - (pagesRead % 20)} pages to next point
                                  </div>
                                </div>
                              );
                            }

                            // Special handling for Gym (with Vital Rest via long-press)
                            if (habit.id === 'gym') {
                              const isVitalRest = day.isVitalRest;
                              const restCount = countVitalRestDays(currentWeek);
                              const canToggleRest = isVitalRest || restCount < 2;
                              const isComplete = isVitalRest || day.habits.gym === habit.points;

                              return (
                                <div
                                  key={habit.id}
                                  className={`p-3 rounded-lg font-semibold text-sm relative overflow-hidden ${
                                    isDisabled
                                      ? 'opacity-50 bg-gray-700'
                                      : isVitalRest
                                      ? 'bg-gradient-to-r from-sky-600 to-indigo-700 text-white'
                                      : isComplete
                                      ? 'bg-gradient-to-r from-emerald-600 to-teal-700 text-white'
                                      : 'bg-white/5 text-purple-300'
                                  }`}
                                  onClick={() => {
                                    if (!isDisabled && !isVitalRest) {
                                      toggleHabit(actualDayIndex, 'gym');
                                    }
                                  }}
                                  onTouchStart={() => {
                                    if (!isDisabled && canToggleRest) {
                                      startLongPress(actualDayIndex, toggleVitalRest);
                                    }
                                  }}
                                  onTouchEnd={cancelLongPress}
                                  onTouchCancel={cancelLongPress}
                                  onMouseDown={() => {
                                    if (!isDisabled && canToggleRest) {
                                      startLongPress(actualDayIndex, toggleVitalRest);
                                    }
                                  }}
                                  onMouseUp={cancelLongPress}
                                  onMouseLeave={cancelLongPress}
                                >
                                  {/* Long press progress indicator */}
                                  {longPressProgress > 0 && (
                                    <div
                                      className="long-press-indicator"
                                      style={{ width: `${longPressProgress}%` }}
                                    />
                                  )}

                                  <div className="flex items-center justify-between">
                                    <span className="flex items-center gap-2">
                                      <span className="text-lg habit-icon">{stealthMode ? habit.stealthIcon : (isVitalRest ? 'ðŸ›Œ' : habit.icon)}</span>
                                      <span className="text-xs">{stealthMode ? habit.stealthName : (isVitalRest ? 'Vital Rest' : habit.name)}</span>
                                    </span>
                                    <span className="text-xs mono opacity-75">
                                      {isVitalRest ? '+1' : day.habits.gym}/{habit.points}
                                    </span>
                                  </div>
                                  <div className="text-[9px] text-center mt-1 opacity-60">
                                    {isVitalRest ? 'Tap to cancel' : `Hold for Rest (${restCount}/2)`}
                                  </div>
                                  {isVitalRest && (
                                    <button
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        toggleVitalRest(actualDayIndex);
                                      }}
                                      className="w-full mt-1 py-1 rounded text-[10px] bg-white/20 hover:bg-white/30"
                                    >
                                      Cancel Rest
                                    </button>
                                  )}
                                </div>
                              );
                            }

                            const isComplete = day.habits[habit.id] === habit.points;

                            return (
                              <button
                                key={habit.id}
                                onClick={() => toggleHabit(actualDayIndex, habit.id)}
                                disabled={isDisabled}
                                className={`habit-btn p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                  isDisabled
                                    ? 'opacity-50 cursor-not-allowed bg-gray-700'
                                    : isComplete
                                    ? 'bg-gradient-to-r from-emerald-600 to-teal-700 text-white'
                                    : 'bg-white/5 hover:bg-white/10 text-purple-300'
                                }`}
                              >
                                <span className="flex items-center gap-2">
                                  <span className="text-lg habit-icon">{stealthMode ? habit.stealthIcon : habit.icon}</span>
                                  <span className="text-xs">{stealthMode ? habit.stealthName : habit.name}</span>
                                </span>
                                <span className="text-xs mono opacity-75">
                                  {day.habits[habit.id]}/{habit.points}
                                </span>
                              </button>
                            );
                          })}
                        </div>

                        {/* Ad-hoc Tasks (Ephemeral filtering) */}
                        {(() => {
                          // Filter tasks: hide if completed on a previous day
                          const tasksForThisDay = state.adHocTasks.filter(task => {
                            const completedEarlier = currentWeek.days.some((d, idx) =>
                              idx < actualDayIndex && d.completedTasks.includes(task.id)
                            );
                            return !completedEarlier;
                          });

                          if (tasksForThisDay.length === 0) return null;

                          return (
                            <div className="space-y-2 mb-4">
                              {tasksForThisDay.map(task => {
                                const isComplete = day.completedTasks.includes(task.id);
                                const isDisabled = day.isLocked;

                                return (
                                  <button
                                    key={task.id}
                                    onClick={() => toggleTask(actualDayIndex, task.id)}
                                    disabled={isDisabled}
                                    className={`habit-btn w-full p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                      isDisabled
                                        ? 'opacity-50 cursor-not-allowed bg-gray-700'
                                        : isComplete
                                        ? 'bg-gradient-to-r from-amber-500 to-orange-700 text-white'
                                        : 'bg-white/5 hover:bg-white/10 text-purple-300'
                                    }`}
                                  >
                                    <span className="flex items-center gap-2">
                                      <span className="text-lg">*</span>
                                      <span className="text-xs">{task.name}</span>
                                    </span>
                                    <span className="text-xs mono opacity-75">
                                      {isComplete ? task.points : 0}/{task.points}
                                    </span>
                                  </button>
                                );
                              })}
                            </div>
                          );
                        })()}

                        {/* Day Controls */}
                        <div className="flex gap-2">
                          <button
                            onClick={() => toggleOffDay(actualDayIndex)}
                            disabled={day.isLocked}
                            className={`flex-1 py-2 rounded-lg text-xs font-semibold transition-all ${
                              day.isLocked
                                ? 'opacity-50 cursor-not-allowed bg-gray-700'
                                : 'glass hover:bg-white/10 text-purple-300'
                            }`}
                          >
                            Mark Off
                          </button>
                          <button
                            onClick={() => toggleLock(actualDayIndex)}
                            className={`flex-1 py-2 rounded-lg text-xs font-semibold transition-all ${
                              day.isLocked
                                ? 'bg-blue-500/30 hover:bg-blue-500/40 text-blue-300'
                                : 'glass hover:bg-white/10 text-purple-300'
                            }`}
                          >
                            {day.isLocked ? 'Unlock' : 'Lock'}
                          </button>
                        </div>
                      </>
                    )}

                    {day.isOffDay && (
                      <div className="text-center py-4">
                        <div className="text-4xl mb-2">O</div>
                        <div className="text-purple-300 text-sm">Off Day</div>
                        <button
                          onClick={() => toggleOffDay(actualDayIndex)}
                          disabled={day.isLocked}
                          className="mt-3 px-4 py-2 rounded-lg text-xs font-semibold glass hover:bg-white/10 text-purple-300"
                        >
                          Unmark
                        </button>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>

            {/* Tasks Management */}
            {(() => {
              // Filter out tasks that have been completed on any day
              const pendingTasks = state.adHocTasks.filter(task => {
                const completedOnAnyDay = currentWeek.days.some(d =>
                  d.completedTasks.includes(task.id)
                );
                return !completedOnAnyDay;
              });

              return (
                <div className="mt-8 animate-slide-in">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-2xl font-bold">Bonus Tasks</h2>
                    <button
                      onClick={() => setShowTaskModal(true)}
                      className="px-4 py-2 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-purple-600 hover:to-pink-600 transition-all"
                    >
                      + Add Task
                    </button>
                  </div>

                  {pendingTasks.length === 0 ? (
                    <div className="glass rounded-xl p-8 text-center text-purple-400">
                      <div className="text-4xl mb-2">*</div>
                      <div className="text-sm">{state.adHocTasks.length > 0 ? 'All tasks completed!' : 'No bonus tasks yet'}</div>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {pendingTasks.map(task => (
                        <div key={task.id} className="glass rounded-xl p-4 flex items-center justify-between">
                          <div>
                            <div className="font-semibold">{task.name}</div>
                            <div className="text-xs text-purple-400 mono">{task.points} points</div>
                          </div>
                          <button
                            onClick={() => {
                              if (confirm(`Delete "${task.name}"?`)) {
                                deleteTask(task.id);
                              }
                            }}
                            className="px-3 py-1 rounded-lg text-xs font-semibold bg-red-500/20 hover:bg-red-500/30 text-red-300 transition-all"
                          >
                            Delete
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              );
            })()}

            {/* 30-Day Heatmap (GitHub-style contribution graph) */}
            <div className="glass rounded-xl p-4 mt-8 animate-slide-in">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-sm font-semibold text-purple-300">30-Day Consistency</h3>
                <div className="flex items-center gap-1 text-[10px] text-purple-400">
                  <span>Less</span>
                  <div className="flex gap-1">
                    <div className="w-3 h-3 rounded-sm heatmap-level-0" />
                    <div className="w-3 h-3 rounded-sm heatmap-level-1" />
                    <div className="w-3 h-3 rounded-sm heatmap-level-2" />
                    <div className="w-3 h-3 rounded-sm heatmap-level-3" />
                    <div className="w-3 h-3 rounded-sm heatmap-level-4" />
                  </div>
                  <span>More</span>
                </div>
              </div>
              <div className="heatmap-grid">
                {heatmapData.map((cell, idx) => (
                  <div
                    key={idx}
                    className={`heatmap-cell ${
                      cell.isFuture ? 'opacity-20 heatmap-level-0' :
                      cell.isOffDay ? 'bg-gray-700/50' :
                      `heatmap-level-${cell.level}`
                    } ${cell.isToday ? 'ring-2 ring-violet-400 ring-offset-1 ring-offset-slate-950' : ''}`}
                    title={`${cell.date}: ${cell.isOffDay ? 'Off Day' : cell.isFuture ? 'Future' : `${cell.score} pts`}`}
                  />
                ))}
              </div>
              <div className="flex justify-between mt-2 text-[10px] text-purple-500">
                <span>5 weeks ago</span>
                <span>Today</span>
              </div>
            </div>

            {/* Footer with Sync Status */}
            <div className="mt-8 text-center text-purple-500 text-xs">
              <div className="flex items-center justify-center gap-3 mb-2">
                {/* Local save indicator */}
                <div className="flex items-center gap-1">
                  <div className={`w-2 h-2 rounded-full ${Date.now() - lastSaved < 2000 ? 'bg-green-400 animate-pulse' : 'bg-green-600'}`} />
                  <span>Local</span>
                </div>

                {/* Google Sheets sync status */}
                <button
                  onClick={() => setShowSheetsModal(true)}
                  className={`flex items-center gap-1 px-2 py-1 rounded-lg transition-all ${
                    sheetsConfig
                      ? syncStatus === 'syncing'
                        ? 'bg-blue-500/20 text-blue-300'
                        : syncStatus === 'error'
                        ? 'bg-red-500/20 text-red-300'
                        : 'bg-green-500/20 text-green-300'
                      : 'bg-purple-500/20 text-purple-300 hover:bg-purple-500/30'
                  }`}
                >
                  <svg className={`w-3 h-3 ${syncStatus === 'syncing' ? 'animate-spin' : ''}`} fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5.5 16a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 16h-8z" />
                  </svg>
                  <span>
                    {sheetsConfig
                      ? syncStatus === 'syncing' ? 'Syncing...' : syncStatus === 'error' ? 'Sync Error' : 'Sheets'
                      : 'Connect Sheets'}
                  </span>
                </button>
              </div>

              <p>{sheetsConfig ? 'Synced to Google Sheets' : 'Data saved locally on this device'}</p>

              {/* Swipe hint */}
              <div className="swipe-hint mt-2">
                Swipe left/right to navigate weeks
              </div>
            </div>
          </div>

          {/* Task Modal */}
          {showTaskModal && <TaskModal onClose={() => setShowTaskModal(false)} onAdd={addTask} />}

          {/* Info Modal */}
          {showInfoModal && <InfoModal onClose={() => setShowInfoModal(false)} />}

          {/* Google Sheets Setup Modal */}
          {showSheetsModal && (
            <SheetsModal
              onClose={() => setShowSheetsModal(false)}
              onSave={saveSheetsConfig}
              currentConfig={sheetsConfig}
            />
          )}

          {/* Conflict Resolution Modal */}
          {showConflictModal && conflictData && (
            <ConflictModal
              localData={conflictData.local}
              remoteData={conflictData.remote}
              onResolve={resolveConflict}
            />
          )}

          {/* Backfill Prompt */}
          {showBackfillPrompt && (
            <BackfillPrompt
              onBackfill={() => {
                switchViewMode('all-days');
                setShowBackfillPrompt(false);
              }}
              onContinue={() => setShowBackfillPrompt(false)}
              unfilledCount={currentWeek.days.filter(d => isPastDay(d.date) && !d.isFilled && !d.isOffDay).length}
            />
          )}
        </div>
      );
    }

    // ============================================================================
    // TASK MODAL COMPONENT
    // ============================================================================

    function TaskModal({ onClose, onAdd }) {
      const [name, setName] = useState('');
      const [points, setPoints] = useState(2);

      const handleSubmit = () => {
        if (!name.trim()) {
          alert('Please enter a task name');
          return;
        }
        onAdd(name.trim(), points);
      };

      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 animate-slide-in">
          <div className="glass rounded-2xl p-6 max-w-md w-full">
            <h3 className="text-2xl font-bold mb-4">Add Bonus Task</h3>

            <div className="mb-4">
              <label className="block text-sm font-semibold text-purple-300 mb-2">Task Name</label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="e.g., Call dentist"
                className="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 focus:border-purple-400 focus:outline-none text-white placeholder-purple-400"
                autoFocus
              />
            </div>

            <div className="mb-6">
              <label className="block text-sm font-semibold text-purple-300 mb-2">Points (1-5)</label>
              <div className="flex gap-2">
                {[1, 2, 3, 4, 5].map(p => (
                  <button
                    key={p}
                    onClick={() => setPoints(p)}
                    className={`flex-1 py-3 rounded-lg font-bold transition-all ${
                      points === p
                        ? 'bg-gradient-to-r from-violet-600 to-indigo-600 text-white'
                        : 'glass text-purple-300 hover:bg-white/10'
                    }`}
                  >
                    {p}
                  </button>
                ))}
              </div>
            </div>

            <div className="flex gap-3">
              <button
                onClick={onClose}
                className="flex-1 py-3 rounded-lg font-semibold glass hover:bg-white/10 text-purple-300"
              >
                Cancel
              </button>
              <button
                onClick={handleSubmit}
                className="flex-1 py-3 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-purple-600 hover:to-pink-600"
              >
                Add Task
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================================================
    // GOOGLE SHEETS SETUP MODAL
    // ============================================================================

    function SheetsModal({ onClose, onSave, currentConfig }) {
      const [webAppUrl, setWebAppUrl] = useState(currentConfig?.webAppUrl || '');
      const [step, setStep] = useState(currentConfig ? 'connected' : 'intro');

      const handleSave = () => {
        if (!webAppUrl.trim()) {
          alert('Please enter your Google Apps Script Web App URL');
          return;
        }
        onSave({ webAppUrl: webAppUrl.trim() });
      };

      const handleDisconnect = () => {
        localStorage.removeItem(SHEETS_CONFIG_KEY);
        onSave(null);
        onClose();
      };

      return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 animate-slide-in overflow-y-auto">
          <div className="glass rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-2xl font-bold">Google Sheets Sync</h3>
              <button
                onClick={onClose}
                className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center"
              >
                X
              </button>
            </div>

            {step === 'connected' && currentConfig && (
              <div className="text-center">
                <div className="text-6xl mb-4">âœ“</div>
                <h4 className="text-xl font-bold text-green-400 mb-2">Connected!</h4>
                <p className="text-purple-300 text-sm mb-6">
                  Your data is syncing to Google Sheets.
                </p>
                <div className="glass rounded-lg p-3 mb-6 text-xs text-left">
                  <div className="text-purple-400 mb-1">Web App URL:</div>
                  <div className="text-purple-200 break-all mono">{currentConfig.webAppUrl.substring(0, 50)}...</div>
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={handleDisconnect}
                    className="flex-1 py-3 rounded-lg font-semibold bg-red-500/20 hover:bg-red-500/30 text-red-300"
                  >
                    Disconnect
                  </button>
                  <button
                    onClick={onClose}
                    className="flex-1 py-3 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600"
                  >
                    Done
                  </button>
                </div>
              </div>
            )}

            {step === 'intro' && (
              <>
                <div className="text-center mb-6">
                  <div className="text-6xl mb-4">ðŸ“Š</div>
                  <p className="text-purple-200 text-sm">
                    Back up your data to Google Sheets for safety and analysis.
                  </p>
                </div>

                <div className="glass rounded-lg p-4 mb-6">
                  <h4 className="font-bold text-purple-300 mb-3">Quick Setup (5 mins)</h4>
                  <ol className="text-xs text-purple-200 space-y-2">
                    <li className="flex gap-2">
                      <span className="text-purple-400 font-bold">1.</span>
                      <span>Create a new Google Sheet</span>
                    </li>
                    <li className="flex gap-2">
                      <span className="text-purple-400 font-bold">2.</span>
                      <span>Go to Extensions â†’ Apps Script</span>
                    </li>
                    <li className="flex gap-2">
                      <span className="text-purple-400 font-bold">3.</span>
                      <span>Paste the sync script (tap "Copy Script" below)</span>
                    </li>
                    <li className="flex gap-2">
                      <span className="text-purple-400 font-bold">4.</span>
                      <span>Deploy â†’ New deployment â†’ Web app</span>
                    </li>
                    <li className="flex gap-2">
                      <span className="text-purple-400 font-bold">5. </span>
                      <span>Set "Who has access" to "Anyone" and Deploy</span>
                    </li>
                    <li className="flex gap-2">
                      <span className="text-purple-400 font-bold">6.</span>
                      <span>Copy the Web App URL and paste below</span>
                    </li>
                  </ol>
                </div>

                <button
                  onClick={() => {
                    const script = `function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();

    // Clear and write headers on first row
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(['Timestamp', 'Week', 'Day', 'Date', 'Score', 'Streak', 'Data JSON']);
    }

    // Write each day's data
    var weeks = data.data.weeks || [];
    weeks.forEach(function(week, weekIdx) {
      week.days.forEach(function(day, dayIdx) {
        sheet.appendRow([
          data.timestamp,
          weekIdx + 1,
          dayIdx + 1,
          day.date,
          day.isFilled ? 'Filled' : 'Empty',
          data.data.streakDays,
          JSON.stringify(day)
        ]);
      });
    });

    return ContentService.createTextOutput(JSON.stringify({success: true}));
  } catch(err) {
    return ContentService.createTextOutput(JSON.stringify({error: err.message}));
  }
}`;
                    navigator.clipboard.writeText(script);
                    alert('Script copied! Paste it in Google Apps Script.');
                  }}
                  className="w-full py-3 rounded-lg font-semibold glass hover:bg-white/10 text-purple-300 mb-4"
                >
                  Copy Script
                </button>

                <button
                  onClick={() => setStep('url')}
                  className="w-full py-3 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600"
                >
                  I Have My Web App URL
                </button>

                <button
                  onClick={onClose}
                  className="w-full py-3 rounded-lg font-semibold text-purple-400 hover:text-purple-300 mt-3"
                >
                  Skip for Now
                </button>
              </>
            )}

            {step === 'url' && (
              <>
                <div className="mb-6">
                  <label className="block text-sm font-semibold text-purple-300 mb-2">
                    Google Apps Script Web App URL
                  </label>
                  <input
                    type="url"
                    value={webAppUrl}
                    onChange={(e) => setWebAppUrl(e.target.value)}
                    placeholder="https://script.google.com/macros/s/..."
                    className="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 focus:border-purple-400 focus:outline-none text-white placeholder-purple-400 text-sm"
                    autoFocus
                  />
                  <p className="text-[10px] text-purple-400 mt-2">
                    This URL is from your deployed Google Apps Script web app
                  </p>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setStep('intro')}
                    className="flex-1 py-3 rounded-lg font-semibold glass hover:bg-white/10 text-purple-300"
                  >
                    Back
                  </button>
                  <button
                    onClick={handleSave}
                    className="flex-1 py-3 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600"
                  >
                    Connect
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      );
    }

    // ============================================================================
    // INFO MODAL COMPONENT
    // ============================================================================

    function InfoModal({ onClose }) {
      return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 animate-slide-in overflow-y-auto">
          <div className="glass rounded-2xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-2xl font-bold">How It Works</h3>
              <button
                onClick={onClose}
                className="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center"
              >
                X
              </button>
            </div>

            {/* Daily Points */}
            <div className="mb-6">
              <h4 className="text-lg font-bold text-purple-300 mb-3">Daily Points</h4>
              <p className="text-sm text-purple-200 mb-3">
                Complete your 17 core habits each day. Each gives 0.5 to 3 points.
              </p>
              <div className="glass rounded-lg p-3 text-xs space-y-1">
                <div className="flex justify-between"><span>Dopamine Baseline</span><span className="text-green-400">3 pts</span></div>
                <div className="flex justify-between"><span>Lunch / Dinner / Diet / Reading</span><span className="text-green-400">2 pts each</span></div>
                <div className="flex justify-between"><span>Sleep (variable: -1 to +2)</span><span className="text-blue-400">time-based</span></div>
                <div className="flex justify-between"><span>Most other habits</span><span className="text-green-400">1 pt each</span></div>
              </div>
            </div>

            {/* Weekly Tiers */}
            <div className="mb-6">
              <h4 className="text-lg font-bold text-purple-300 mb-3">Weekly Tiers</h4>
              <p className="text-sm text-purple-200 mb-3">
                Points add up over 7 days. Your tier determines reward or penalty.
              </p>
              <div className="glass rounded-lg p-3 text-xs space-y-2">
                <div className="flex justify-between items-center">
                  <span>ELITE (94+ pts)</span>
                  <span className="text-green-400 font-bold">+$100 reward</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>SOLID (83+ pts)</span>
                  <span className="text-green-400 font-bold">+$60 reward</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>DECENT (70+ pts)</span>
                  <span className="text-green-400 font-bold">+$30 reward</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>STRUGGLING (55-69 pts)</span>
                  <span className="text-red-400 font-bold">-$75 penalty</span>
                </div>
                <div className="flex justify-between items-center">
                  <span>CRISIS (&lt;55 pts)</span>
                  <span className="text-red-400 font-bold">-$200 penalty</span>
                </div>
              </div>
              <p className="text-[10px] text-purple-400 mt-2">
                * Thresholds scale down if you take off-days (e.g., 5 active days = lower targets)
              </p>
            </div>

            {/* The Two Accounts */}
            <div className="mb-6">
              <h4 className="text-lg font-bold text-purple-300 mb-3">The Two Accounts</h4>
              <div className="space-y-3">
                <div className="glass rounded-lg p-3">
                  <div className="text-green-400 font-bold mb-1">Guilt-Free Fund</div>
                  <p className="text-xs text-purple-200">
                    Your "do whatever you want" money. Skydiving? Solo trip? Random gadget?
                    Zero guilt - you earned it through discipline.
                  </p>
                </div>
                <div className="glass rounded-lg p-3">
                  <div className="text-red-400 font-bold mb-1">NRE Account (No Retrieval Ever)</div>
                  <p className="text-xs text-purple-200">
                    A locked savings you can't touch. Penalty money goes here and sits
                    untouchable - maybe unlocked in 5 years for a house down payment.
                    Watching it grow is the punishment.
                  </p>
                </div>
              </div>
            </div>

            {/* Special Rules */}
            <div className="mb-6">
              <h4 className="text-lg font-bold text-purple-300 mb-3">Special Rules</h4>
              <div className="glass rounded-lg p-3 text-xs space-y-3">
                <div>
                  <div className="font-bold text-blue-300">Sleep Velocity</div>
                  <p className="text-purple-200">10:30 PM = +2pts | 11 PM = +1pt | 11:30 PM = 0 | 12:30 AM+ = -1pt</p>
                </div>
                <div>
                  <div className="font-bold text-blue-300">Weekend Buffer (Fri/Sat)</div>
                  <p className="text-purple-200">Sleep & Digital Sunset auto-award 1pt. Free roam mode!</p>
                </div>
                <div>
                  <div className="font-bold text-blue-300">Sunday Reset</div>
                  <p className="text-purple-200">Sleep late Sunday? Monday's Career Dev points get halved.</p>
                </div>
                <div>
                  <div className="font-bold text-blue-300">Meal Flexibility</div>
                  <p className="text-purple-200">20% of meals can be skipped free. After that, -2pts per skip.</p>
                </div>
                <div>
                  <div className="font-bold text-blue-300">Vital Rest Days</div>
                  <p className="text-purple-200">2 days/week can be rest days - auto-awards gym point as recovery.</p>
                </div>
                <div>
                  <div className="font-bold text-blue-300">Bonus Task Eligibility</div>
                  <p className="text-purple-200">Bonus tasks only count toward tier if core habits are 60%+ done. No gaming the system!</p>
                </div>
              </div>
            </div>

            {/* Why It Works */}
            <div className="mb-4">
              <h4 className="text-lg font-bold text-purple-300 mb-3">Why It Works</h4>
              <div className="glass rounded-lg p-3 text-xs text-purple-200">
                <p className="mb-2">
                  <strong className="text-white">Loss aversion:</strong> Losing $200 to an untouchable account hurts
                  way more than gaining $100 feels good.
                </p>
                <p>
                  You're not fighting willpower anymore - you're fighting your wallet.
                  Missing one gym session doesn't feel bad... but watching $200 disappear
                  into a locked account because you had a lazy week? That stings.
                </p>
              </div>
            </div>

            <button
              onClick={onClose}
              className="w-full py-3 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-purple-600 hover:to-pink-600 mt-4"
            >
              Got It
            </button>
          </div>
        </div>
      );
    }

    // ============================================================================
    // BACKFILL PROMPT COMPONENT
    // ============================================================================

    // ============================================================================
    // CONFLICT RESOLUTION MODAL (Multi-Device Sync Protection)
    // ============================================================================

    function ConflictModal({ localData, remoteData, onResolve }) {
      const formatTime = (timestamp) => {
        if (!timestamp) return 'Unknown';
        return new Date(timestamp).toLocaleString();
      };

      return (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 animate-slide-in">
          <div className="glass rounded-2xl p-6 max-w-md w-full">
            <div className="text-center mb-6">
              <div className="text-6xl mb-4">âš ï¸</div>
              <h3 className="text-2xl font-bold text-amber-400 mb-2">Sync Conflict Detected</h3>
              <p className="text-purple-300 text-sm">
                Another device modified your data. Choose which version to keep.
              </p>
            </div>

            <div className="space-y-3 mb-6">
              {/* Local version */}
              <div className="glass rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="font-bold text-blue-300">This Device</span>
                  <span className="text-xs text-purple-400 mono">
                    {formatTime(localData?.lastModified)}
                  </span>
                </div>
                <div className="text-xs text-purple-200">
                  <div>Streak: {localData?.streakDays || 0} days</div>
                  <div>Balance: ${localData?.guiltFreeBalance || 0}</div>
                </div>
              </div>

              {/* Remote version */}
              <div className="glass rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="font-bold text-green-300">Other Device</span>
                  <span className="text-xs text-purple-400 mono">
                    {formatTime(remoteData?.lastModified)}
                  </span>
                </div>
                <div className="text-xs text-purple-200">
                  <div>Streak: {remoteData?.streakDays || 0} days</div>
                  <div>Balance: ${remoteData?.guiltFreeBalance || 0}</div>
                </div>
              </div>
            </div>

            <div className="flex flex-col gap-2">
              <button
                onClick={() => onResolve('remote')}
                className="py-3 rounded-lg font-semibold bg-gradient-to-r from-emerald-600 to-teal-700 text-white"
              >
                Keep Other Device (Newer)
              </button>
              <button
                onClick={() => onResolve('local')}
                className="py-3 rounded-lg font-semibold glass hover:bg-white/10 text-purple-300"
              >
                Keep This Device
              </button>
            </div>

            <p className="text-[10px] text-purple-500 text-center mt-4">
              Tip: Always close the app on other devices before making changes
            </p>
          </div>
        </div>
      );
    }

    // ============================================================================
    // BACKFILL PROMPT COMPONENT
    // ============================================================================

    function BackfillPrompt({ onBackfill, onContinue, unfilledCount }) {
      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 animate-slide-in">
          <div className="glass rounded-2xl p-6 max-w-md w-full">
            <div className="text-center mb-6">
              <div className="text-6xl mb-4">!</div>
              <h3 className="text-2xl font-bold mb-2">Missing Data Detected</h3>
              <p className="text-purple-300">
                You have {unfilledCount} day{unfilledCount > 1 ? 's' : ''} to backfill since your journey started.
              </p>
            </div>

            <div className="flex flex-col gap-3">
              <button
                onClick={onBackfill}
                className="py-3 rounded-lg font-semibold bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-purple-600 hover:to-pink-600"
              >
                Backfill Now
              </button>
              <button
                onClick={onContinue}
                className="py-3 rounded-lg font-semibold glass hover:bg-white/10 text-purple-300"
              >
                Continue with Today
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Render the app
    ReactDOM.createRoot(document.getElementById('root')).render(<DisciplineTracker />);
  </script>
</body>
</html>
