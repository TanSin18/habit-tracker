<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Mobile Web App Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Discipline">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1e1b4b">
  <meta name="msapplication-TileColor" content="#1e1b4b">
  <meta name="format-detection" content="telephone=no">

  <!-- SEO and Social Meta Tags -->
  <meta name="description" content="Track your daily habits and build discipline with rewards and penalties">
  <meta name="application-name" content="Discipline Tracker">

  <title>Discipline Tracker</title>
  <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Discipline Tracker&quot;,&quot;short_name&quot;:&quot;Discipline&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%231e1b4b&quot;,&quot;theme_color&quot;:&quot;%231e1b4b&quot;}">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap');

    * {
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    .mono {
      font-family: 'Space Mono', monospace;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.8); }
    }

    .animate-pulse-red {
      animation: pulse-red 1.5s ease-in-out infinite;
    }

    .animate-slide-in {
      animation: slideIn 0.3s ease-out;
    }

    .animate-flicker {
      animation: flicker 1.5s ease-in-out infinite;
    }

    .habit-btn {
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .habit-btn:active {
      transform: scale(0.95);
    }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .glow {
      box-shadow: 0 0 20px rgba(147, 51, 234, 0.3);
    }

    body {
      overscroll-behavior: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ============================================================================
    // CONSTANTS & CONFIGURATION
    // ============================================================================

    const JOURNEY_START = new Date('2026-01-25T00:00:00.000Z');
    const STORAGE_KEY = 'discipline-tracker-v4';

    const HABITS = [
      { id: 'nofap', name: 'NoFap', icon: 'ðŸ’Ž', points: 3 },
      { id: 'gym', name: 'Gym', icon: 'ðŸ’ª', points: 1 },
      { id: 'yoga', name: 'Yoga', icon: 'ðŸ§˜', points: 1 },
      { id: 'lunch', name: 'Lunch', icon: 'ðŸ³', points: 2 },
      { id: 'dinner', name: 'Dinner', icon: 'ðŸ½ï¸', points: 2 },
      { id: 'laundry', name: 'Laundry', icon: 'ðŸ§º', points: 1 },
      { id: 'dishes', name: 'Dishes', icon: 'ðŸ½ï¸', points: 1 },
      { id: 'cleaning', name: 'Cleaning', icon: 'ðŸ§¹', points: 1 },
      { id: 'meditation', name: 'Meditation', icon: 'ðŸ§˜â€â™‚ï¸', points: 1 },
      { id: 'prayer', name: 'Hanuman Chalisa', icon: 'ðŸ™', points: 1 },
      { id: 'sunset', name: 'Digital Sunset', icon: 'ðŸ“µ', points: 1, isTime: true }, // 10:00 PM device lockdown
      { id: 'sleep', name: 'Sleep', icon: 'ðŸ˜´', points: 2, isTime: true }, // Variable: -1 to +2 pts
      { id: 'journal', name: 'Journaling', icon: 'ðŸ“', points: 1 },
      { id: 'reading', name: 'Reading', icon: 'ðŸ“š', points: 2 },
      { id: 'career', name: 'Career Dev', icon: 'ðŸš€', points: 1 }
    ];

    const TIERS = {
      ELITE: { name: 'ELITE', min: 94, icon: 'ðŸ‘‘', color: 'from-yellow-400 to-amber-600', reward: 100 },
      SOLID: { name: 'SOLID', min: 83, icon: 'ðŸ’ª', color: 'from-blue-400 to-blue-600', reward: 60 },
      DECENT: { name: 'DECENT', min: 70, icon: 'âœ“', color: 'from-green-400 to-green-600', reward: 30 },
      STRUGGLING: { name: 'STRUGGLING', min: 55, icon: 'âš ï¸', color: 'from-orange-400 to-red-500', penalty: 75 },
      CRISIS: { name: 'CRISIS', min: 0, icon: 'ðŸš¨', color: 'from-red-500 to-red-700', penalty: 200 }
    };

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================

    const isSameDay = (d1, d2) => {
      return d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate();
    };

    const isPastDay = (dateStr) => {
      const date = new Date(dateStr);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      date.setHours(0, 0, 0, 0);
      return date < today;
    };

    const isFutureDay = (dateStr) => {
      const date = new Date(dateStr);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      date.setHours(0, 0, 0, 0);
      return date > today;
    };

    const formatDate = (dateStr) => {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    };

    // Check if a day is Friday or Saturday (weekend buffer days)
    const isWeekendDay = (dateStr) => {
      const date = new Date(dateStr);
      const day = date.getDay();
      return day === 5 || day === 6; // Friday = 5, Saturday = 6
    };

    // Check if a day is Sunday
    const isSunday = (dateStr) => {
      const date = new Date(dateStr);
      return date.getDay() === 0;
    };

    // Calculate sleep points based on time (Sleep Velocity)
    // 10:30 PM = +2 (Elite), 11:00 PM = +1 (Goal), 11:30 PM = 0, 12:30 AM+ = -1 (Penalty)
    const calculateSleepPoints = (sleepTimeStr, isWeekend) => {
      if (!sleepTimeStr) return 0;
      if (isWeekend) return 1; // Flat reward for Friday/Saturday (Free-Roam)

      const [hours, minutes] = sleepTimeStr.split(':').map(Number);
      // Convert to minutes from midnight, handling late night (after midnight)
      let totalMinutes = hours * 60 + minutes;
      // If time is between 00:00-06:00, treat as late night (add 24h worth)
      if (hours < 6) totalMinutes += 24 * 60;

      // 22:30 (10:30 PM) = 1350 mins, 23:00 (11:00 PM) = 1380 mins
      // 23:30 (11:30 PM) = 1410 mins, 00:30 (12:30 AM) = 1470 mins
      if (totalMinutes <= 1350) return 2;  // Elite: 10:30 PM or earlier
      if (totalMinutes <= 1380) return 1;  // Goal: 11:00 PM or earlier
      if (totalMinutes <= 1410) return 0;  // Baseline: 11:30 PM
      if (totalMinutes >= 1470) return -1; // Penalty: 12:30 AM or later
      return 0;
    };

    // Calculate sunset points (Digital Sunset by 10:00 PM)
    const calculateSunsetPoints = (sunsetTimeStr, isWeekend) => {
      if (!sunsetTimeStr) return 0;
      if (isWeekend) return 1; // Auto-point for weekend

      const [hours, minutes] = sunsetTimeStr.split(':').map(Number);
      let totalMinutes = hours * 60 + minutes;
      if (hours < 6) totalMinutes += 24 * 60;

      // 22:00 (10:00 PM) = 1320 mins
      return totalMinutes <= 1320 ? 1 : 0;
    };

    // Check if Sunday sleep was on time (for Monday career penalty)
    const wasSundaySleepOnTime = (week) => {
      // Find Sunday in the week (day index where getDay() === 0)
      const sundayDay = week.days.find(d => isSunday(d.date));
      if (!sundayDay || !sundayDay.sleepTime) return true; // Default to true if no data

      const sleepPoints = calculateSleepPoints(sundayDay.sleepTime, false);
      return sleepPoints >= 1; // Must be at goal (11:00 PM) or better
    };

    const createEmptyDay = (date) => ({
      date: date.toISOString(),
      habits: {
        nofap: 0, gym: 0, yoga: 0, lunch: 0, dinner: 0,
        laundry: 0, dishes: 0, cleaning: 0, meditation: 0,
        prayer: 0, sunset: 0, sleep: 0, journal: 0, reading: 0, career: 0
      },
      pagesRead: 0,
      sleepTime: null,      // Store actual sleep time (HH:MM format)
      sunsetTime: null,     // Store sunset/device lockdown time
      completedTasks: [],
      isOffDay: false,
      isLocked: false,
      isFilled: false,
      lastUpdated: null
    });

    const createWeek = (startDate) => {
      const days = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        days.push(createEmptyDay(date));
      }
      return { startDate: startDate.toISOString(), days };
    };

    const initializeState = () => {
      return {
        version: "4.0",
        currentWeek: 0,
        weeks: [createWeek(JOURNEY_START)],
        adHocTasks: [],
        streakDays: 0,
        longestStreak: 0,
        guiltFreeBalance: 0,
        nreBalance: 0,
        journeyStartDate: JOURNEY_START.toISOString(),
        viewMode: "today"
      };
    };

    // ============================================================================
    // STORAGE FUNCTIONS
    // ============================================================================

    const loadFromStorage = () => {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (e) {
        console.error('Failed to load from localStorage:', e);
      }
      return null;
    };

    const saveToStorage = (data) => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('Failed to save to localStorage:', e);
      }
    };

    // ============================================================================
    // SCORING LOGIC
    // ============================================================================

    // Calculate core habit score (excludes bonus tasks)
    // Now accepts week for Sunday Reset clause
    const calculateCoreScore = (day, week = null) => {
      if (day.isOffDay) return 0;

      const isWeekend = isWeekendDay(day.date);
      const isMonday = new Date(day.date).getDay() === 1;

      let score = 0;
      HABITS.forEach(habit => {
        if (habit.id === 'reading') {
          // Quantitative reading: 1pt per 20 pages
          score += Math.floor((day.pagesRead || 0) / 20);
        } else if (habit.id === 'sleep') {
          // Sleep Velocity: Variable points based on time
          score += calculateSleepPoints(day.sleepTime, isWeekend);
        } else if (habit.id === 'sunset') {
          // Digital Sunset: 1pt if locked by 10 PM
          score += calculateSunsetPoints(day.sunsetTime, isWeekend);
        } else if (habit.id === 'career') {
          // Sunday Reset Clause: If Sunday sleep was late, halve Monday career points
          let careerPoints = day.habits[habit.id];
          if (isMonday && week && !wasSundaySleepOnTime(week)) {
            careerPoints = Math.floor(careerPoints / 2);
          }
          score += careerPoints;
        } else {
          score += day.habits[habit.id];
        }
      });

      return score;
    };

    // Calculate bonus task score
    const calculateBonusScore = (day, tasks) => {
      if (day.isOffDay) return 0;

      let score = 0;
      day.completedTasks.forEach(taskId => {
        const task = tasks.find(t => t.id === taskId);
        if (task) score += task.points;
      });

      return score;
    };

    const calculateDailyScore = (day, tasks, week = null) => {
      return calculateCoreScore(day, week) + calculateBonusScore(day, tasks);
    };

    const calculateWeekStats = (week, tasks, streakDays) => {
      const activeDaysCount = week.days.filter(d => !d.isOffDay).length;
      const activeRatio = activeDaysCount / 7;

      // Calculate core and bonus scores separately (pass week for Sunday Reset)
      const dailyCoreScores = week.days.map(day => calculateCoreScore(day, week));
      const dailyBonusScores = week.days.map(day => calculateBonusScore(day, tasks));
      const dailyScores = week.days.map(day => calculateDailyScore(day, tasks, week));

      const weeklyCoreScore = dailyCoreScores.reduce((sum, s) => sum + s, 0);
      const weeklyBonusScore = dailyBonusScores.reduce((sum, s) => sum + s, 0);
      const weeklyRawScore = dailyScores.reduce((sum, s) => sum + s, 0);

      // Proportional meal slack: 20% of total possible meals for active days
      let mealsSkipped = 0;
      week.days.forEach(day => {
        if (!day.isOffDay) {
          if (day.habits.lunch === 0) mealsSkipped++;
          if (day.habits.dinner === 0) mealsSkipped++;
        }
      });

      const freeMealAllowance = Math.floor((activeDaysCount * 2) * 0.2); // 20% slack
      const extraMealsSkipped = Math.max(0, mealsSkipped - freeMealAllowance);
      const mealPenalty = extraMealsSkipped * 2;

      const baseScore = weeklyRawScore - mealPenalty;

      const streakBonus =
        streakDays >= 30 ? 20 :
        streakDays >= 21 ? 15 :
        streakDays >= 14 ? 10 :
        streakDays >= 7 ? 5 : 0;

      const totalScore = baseScore + streakBonus;

      // Dynamic tier thresholds based on active days
      const dynamicThresholds = {
        elite: Math.round(94 * activeRatio),
        solid: Math.round(83 * activeRatio),
        decent: Math.round(70 * activeRatio),
        struggling: Math.round(55 * activeRatio)
      };

      // Core score threshold for bonus eligibility (60% of core max)
      const maxCoreScore = activeDaysCount * 19; // Max possible core score per day
      const coreThreshold = maxCoreScore * 0.6;
      const bonusEligible = weeklyCoreScore >= coreThreshold;

      // Calculate effective score: bonus only counts if core threshold met
      const effectiveScore = bonusEligible ? totalScore : (totalScore - weeklyBonusScore);

      let tier = TIERS.CRISIS;
      if (effectiveScore >= dynamicThresholds.elite) tier = TIERS.ELITE;
      else if (effectiveScore >= dynamicThresholds.solid) tier = TIERS.SOLID;
      else if (effectiveScore >= dynamicThresholds.decent) tier = TIERS.DECENT;
      else if (effectiveScore >= dynamicThresholds.struggling) tier = TIERS.STRUGGLING;

      return {
        dailyScores,
        weeklyCoreScore,
        weeklyBonusScore,
        weeklyRawScore,
        mealsSkipped,
        freeMealAllowance,
        mealPenalty,
        baseScore,
        streakBonus,
        totalScore,
        effectiveScore,
        tier,
        dynamicThresholds,
        activeDaysCount,
        bonusEligible,
        coreThreshold
      };
    };

    // ============================================================================
    // MAIN COMPONENT
    // ============================================================================

    function DisciplineTracker() {
      const [state, setState] = useState(null);
      const [showTaskModal, setShowTaskModal] = useState(false);
      const [showBackfillPrompt, setShowBackfillPrompt] = useState(false);
      const [isLoaded, setIsLoaded] = useState(false);

      useEffect(() => {
        const stored = loadFromStorage();
        if (stored) {
          setState(stored);
        } else {
          const initial = initializeState();
          setState(initial);
          saveToStorage(initial);

          const unfilledPastDays = initial.weeks[0].days.filter(d =>
            isPastDay(d.date) && !d.isFilled && !d.isOffDay
          );
          if (unfilledPastDays.length > 0) {
            setShowBackfillPrompt(true);
          }
        }
        setIsLoaded(true);
      }, []);

      const saveState = (newState) => {
        setState(newState);
        saveToStorage(newState);
      };

      const stats = useMemo(() => {
        if (!state) return null;
        const week = state.weeks[state.currentWeek];
        return calculateWeekStats(week, state.adHocTasks, state.streakDays);
      }, [state]);

      if (!isLoaded || !state) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center">
            <div className="text-white text-2xl font-bold animate-pulse">Loading...</div>
          </div>
        );
      }

      const currentWeek = state.weeks[state.currentWeek];
      const today = new Date();
      const todayDay = currentWeek.days.find(d => isSameDay(new Date(d.date), today));

      const toggleHabit = (dayIndex, habitId) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;
        if (habitId === 'reading' || habitId === 'sleep' || habitId === 'sunset') return; // These use separate inputs

        const habit = HABITS.find(h => h.id === habitId);
        const currentValue = day.habits[habitId];
        const newValue = currentValue === habit.points ? 0 : habit.points;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].habits[habitId] = newValue;
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        if (habitId === 'nofap') {
          if (newValue === 3) {
            newState.streakDays++;
            if (newState.streakDays > newState.longestStreak) {
              newState.longestStreak = newState.streakDays;
            }
          } else {
            newState.streakDays = 0;
          }
        }

        saveState(newState);
      };

      const updateReading = (dayIndex, pages) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].pagesRead = Math.max(0, parseInt(pages) || 0);
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        saveState(newState);
      };

      const updateSleepTime = (dayIndex, time) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].sleepTime = time;
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        saveState(newState);
      };

      const updateSunsetTime = (dayIndex, time) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].sunsetTime = time;
        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        newState.weeks[state.currentWeek].days[dayIndex].lastUpdated = new Date().toISOString();

        saveState(newState);
      };

      // Check if a day was backfilled (updated more than 24h after the day's date)
      const isBackfilled = (day) => {
        if (!day.lastUpdated) return false;
        const dayDate = new Date(day.date);
        const updateDate = new Date(day.lastUpdated);
        const hoursDiff = (updateDate - dayDate) / (1000 * 60 * 60);
        return hoursDiff > 24;
      };

      const toggleOffDay = (dayIndex) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked) return;

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].isOffDay = !day.isOffDay;
        if (newState.weeks[state.currentWeek].days[dayIndex].isOffDay) {
          newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        }
        saveState(newState);
      };

      const toggleLock = (dayIndex) => {
        const day = currentWeek.days[dayIndex];
        if (day.isOffDay) return;
        if (!day.isFilled && !day.isLocked) {
          alert('Fill in data before locking this day');
          return;
        }

        const newState = JSON.parse(JSON.stringify(state));
        newState.weeks[state.currentWeek].days[dayIndex].isLocked = !day.isLocked;
        saveState(newState);
      };

      const toggleTask = (dayIndex, taskId) => {
        const day = currentWeek.days[dayIndex];
        if (day.isLocked || day.isOffDay) return;

        const newState = JSON.parse(JSON.stringify(state));
        const completedTasks = newState.weeks[state.currentWeek].days[dayIndex].completedTasks;

        if (completedTasks.includes(taskId)) {
          newState.weeks[state.currentWeek].days[dayIndex].completedTasks =
            completedTasks.filter(id => id !== taskId);
        } else {
          newState.weeks[state.currentWeek].days[dayIndex].completedTasks.push(taskId);
        }

        newState.weeks[state.currentWeek].days[dayIndex].isFilled = true;
        saveState(newState);
      };

      const addTask = (name, points) => {
        const newState = JSON.parse(JSON.stringify(state));
        newState.adHocTasks.push({
          id: Date.now().toString(),
          name,
          points
        });
        saveState(newState);
        setShowTaskModal(false);
      };

      const deleteTask = (taskId) => {
        const newState = JSON.parse(JSON.stringify(state));
        newState.adHocTasks = newState.adHocTasks.filter(t => t.id !== taskId);

        newState.weeks.forEach(week => {
          week.days.forEach(day => {
            day.completedTasks = day.completedTasks.filter(id => id !== taskId);
          });
        });

        saveState(newState);
      };

      const switchViewMode = (mode) => {
        const newState = JSON.parse(JSON.stringify(state));
        newState.viewMode = mode;
        saveState(newState);
      };

      const daysToShow = state.viewMode === 'today' ? (todayDay ? [todayDay] : []) : currentWeek.days;

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white">
          <div className="container mx-auto px-4 py-8 max-w-2xl">
            {/* Header */}
            <div className="text-center mb-8 animate-slide-in">
              <h1 className="text-4xl sm:text-5xl font-black mb-2 bg-gradient-to-r from-purple-400 via-pink-400 to-purple-400 bg-clip-text text-transparent">
                DISCIPLINE TRACKER
              </h1>
              <p className="text-purple-300 text-sm mono">Level Up or Pay Up</p>
            </div>

            {/* Stats Cards */}
            <div className="grid grid-cols-3 gap-3 mb-6 animate-slide-in">
              <div className="glass rounded-xl p-4 text-center">
                {/* Streak flame with color progression */}
                <div className={`text-2xl mb-1 animate-flicker ${
                  state.streakDays >= 30 ? 'text-blue-400' :
                  state.streakDays >= 14 ? 'text-orange-400' :
                  'text-white'
                }`}>
                  <svg className="w-8 h-8 mx-auto" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 23c-4.97 0-9-3.58-9-8 0-3.07 2.31-5.64 5.5-7.27.5-.25 1.04.21.87.75-.35 1.1-.37 2.33.12 3.52.39.94 1.01 1.73 1.76 2.32.35.27.87.12 1.02-.3.47-1.3 1.33-2.3 2.48-2.87.45-.23.96.12.93.62-.07 1.12.19 2.08.78 2.88.36.48.88.86 1.46 1.1.38.15.81-.08.9-.48.4-1.76 1.58-3.15 3.18-3.77.52-.2 1.04.26.91.79C21.13 16.61 17.13 23 12 23z"/>
                  </svg>
                </div>
                <div className="text-2xl font-bold">{state.streakDays}</div>
                <div className="text-xs text-purple-300 mono">STREAK</div>
                <div className="text-xs text-purple-400 mt-1">Best: {state.longestStreak}</div>
              </div>

              <div className="glass rounded-xl p-4 text-center">
                <div className="text-2xl mb-1">{stats.tier.icon}</div>
                <div className="text-lg font-bold">{stats.effectiveScore}</div>
                <div className="text-xs text-purple-300 mono">POINTS</div>
                <div className="text-xs text-purple-400 mt-1">{stats.tier.name}</div>
                {!stats.bonusEligible && stats.weeklyBonusScore > 0 && (
                  <div className="text-[10px] text-amber-400 mt-1">+{stats.weeklyBonusScore} pending</div>
                )}
              </div>

              <div className={`glass rounded-xl p-4 text-center ${
                stats.tier.penalty ? 'animate-pulse-red' : ''
              }`}>
                <div className="text-2xl mb-1">$</div>
                <div className="text-lg font-bold mono">${state.guiltFreeBalance}</div>
                <div className="text-xs text-purple-300 mono">EARNED</div>
                {state.nreBalance > 0 && (
                  <div className="text-xs text-red-400 mt-1 font-bold">NRE: ${state.nreBalance}</div>
                )}
              </div>
            </div>

            {/* Meal Flexibility */}
            <div className="glass rounded-xl p-4 mb-6 animate-slide-in">
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-sm font-semibold text-purple-300">Meal Flexibility</div>
                  <div className="text-xs text-purple-400 mt-1">
                    {stats.mealsSkipped}/{stats.freeMealAllowance} free skips used
                    {stats.mealPenalty > 0 && <span className="text-red-400"> â€¢ -{stats.mealPenalty}pts penalty</span>}
                  </div>
                  <div className="text-[10px] text-purple-500 mt-1">
                    20% of {stats.activeDaysCount * 2} meals ({stats.activeDaysCount} active days)
                  </div>
                </div>
                <div className="text-3xl">~</div>
              </div>
            </div>

            {/* Tier Thresholds Info */}
            <div className="glass rounded-xl p-4 mb-6 animate-slide-in">
              <div className="text-sm font-semibold text-purple-300 mb-2">Dynamic Targets ({stats.activeDaysCount}/7 days active)</div>
              <div className="grid grid-cols-4 gap-2 text-xs">
                <div className="text-center">
                  <div className="text-yellow-400 font-bold">{stats.dynamicThresholds.elite}+</div>
                  <div className="text-purple-400">Elite</div>
                </div>
                <div className="text-center">
                  <div className="text-blue-400 font-bold">{stats.dynamicThresholds.solid}+</div>
                  <div className="text-purple-400">Solid</div>
                </div>
                <div className="text-center">
                  <div className="text-green-400 font-bold">{stats.dynamicThresholds.decent}+</div>
                  <div className="text-purple-400">Decent</div>
                </div>
                <div className="text-center">
                  <div className="text-orange-400 font-bold">{stats.dynamicThresholds.struggling}+</div>
                  <div className="text-purple-400">Struggle</div>
                </div>
              </div>
            </div>

            {/* Reward/Penalty Card */}
            <div className={`rounded-xl p-6 mb-6 animate-slide-in ${
              stats.tier.reward
                ? 'bg-gradient-to-br from-green-500 to-emerald-600 glow'
                : 'bg-gradient-to-br from-red-500 to-red-700 animate-pulse-red'
            }`}>
              <div className="text-center">
                <div className="text-sm font-semibold mb-2 opacity-90">
                  {stats.tier.reward ? 'WEEKLY REWARD' : 'WEEKLY PENALTY'}
                </div>
                <div className="text-5xl font-black mb-2 mono">
                  {stats.tier.reward ? '+' : '-'}${stats.tier.reward || stats.tier.penalty}
                </div>
                <div className="text-sm opacity-90">
                  {stats.tier.reward
                    ? `-> Guilt-Free Fund`
                    : `-> NRE Account (Locked)`}
                </div>
                <div className="text-xs mt-3 opacity-75">
                  Need {stats.dynamicThresholds.decent}+ points to avoid penalty
                </div>
                {!stats.bonusEligible && stats.weeklyBonusScore > 0 && (
                  <div className="text-xs mt-2 bg-black/20 rounded px-2 py-1 inline-block">
                    Core: {stats.weeklyCoreScore}/{Math.round(stats.coreThreshold)} needed for bonus eligibility
                  </div>
                )}
              </div>
            </div>

            {/* View Mode Toggle */}
            <div className="flex gap-2 mb-6 animate-slide-in">
              <button
                onClick={() => switchViewMode('today')}
                className={`flex-1 py-3 rounded-xl font-bold transition-all ${
                  state.viewMode === 'today'
                    ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white'
                    : 'glass text-purple-300 hover:bg-white/10'
                }`}
              >
                Today Only
              </button>
              <button
                onClick={() => switchViewMode('all-days')}
                className={`flex-1 py-3 rounded-xl font-bold transition-all ${
                  state.viewMode === 'all-days'
                    ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white'
                    : 'glass text-purple-300 hover:bg-white/10'
                }`}
              >
                All Days
              </button>
            </div>

            {/* Days Display */}
            <div className="space-y-4">
              {daysToShow.map((day, dayIndex) => {
                const actualDayIndex = state.viewMode === 'today'
                  ? currentWeek.days.findIndex(d => d.date === day.date)
                  : dayIndex;

                const isPast = isPastDay(day.date);
                const isToday = todayDay && day.date === todayDay.date;
                const isFuture = isFutureDay(day.date);
                const needsBackfill = isPast && !day.isFilled && !day.isOffDay;

                const dayScore = calculateDailyScore(day, state.adHocTasks, currentWeek);

                const wasBackfilled = isBackfilled(day);

                let badge = null;
                let badgeColor = '';
                if (isFuture) {
                  badge = 'Future';
                  badgeColor = 'text-purple-400';
                } else if (isToday) {
                  badge = 'TODAY';
                  badgeColor = 'text-cyan-400 font-bold';
                } else if (needsBackfill) {
                  badge = 'Missing Data';
                  badgeColor = 'text-amber-400';
                } else if (day.isLocked) {
                  badge = wasBackfilled ? 'Locked (Backfilled)' : 'Locked';
                  badgeColor = 'text-blue-400';
                } else if (day.isFilled) {
                  badge = wasBackfilled ? 'Backfilled' : 'Filled';
                  badgeColor = wasBackfilled ? 'text-amber-300' : 'text-green-400';
                }

                return (
                  <div
                    key={day.date}
                    className={`rounded-xl p-6 transition-all animate-slide-in ${
                      isFuture ? 'glass opacity-50' :
                      needsBackfill ? 'bg-amber-500/20 border-2 border-amber-500/50' :
                      day.isOffDay ? 'glass opacity-60' :
                      day.isLocked ? 'bg-blue-500/10 border-2 border-blue-500/50' :
                      'glass'
                    }`}
                    style={{ animationDelay: `${dayIndex * 0.05}s` }}
                  >
                    {/* Day Header */}
                    <div className="flex items-center justify-between mb-4">
                      <div>
                        <div className="text-xl font-bold">{formatDate(day.date)}</div>
                        {badge && <div className={`text-sm ${badgeColor} mono mt-1`}>{badge}</div>}
                      </div>
                      <div className="text-right">
                        <div className="text-3xl font-black mono">{day.isOffDay ? '-' : dayScore}</div>
                        <div className="text-xs text-purple-300 mono">points</div>
                      </div>
                    </div>

                    {!isFuture && !day.isOffDay && (
                      <>
                        {/* Habits Grid */}
                        <div className="grid grid-cols-2 gap-2 mb-4">
                          {HABITS.map(habit => {
                            const isDisabled = day.isLocked;
                            const isWeekend = isWeekendDay(day.date);

                            // Special handling for Sleep (time input with velocity)
                            if (habit.id === 'sleep') {
                              const sleepTime = day.sleepTime || '';
                              const sleepPoints = calculateSleepPoints(sleepTime, isWeekend);
                              const hasTime = sleepTime !== '';

                              return (
                                <div
                                  key={habit.id}
                                  className={`p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                    isDisabled
                                      ? 'opacity-50 bg-gray-700'
                                      : sleepPoints >= 1
                                      ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white'
                                      : sleepPoints < 0
                                      ? 'bg-gradient-to-r from-red-500 to-red-700 text-white'
                                      : 'bg-white/5 text-purple-300'
                                  }`}
                                >
                                  <span className="flex items-center gap-2">
                                    <span className="text-lg">{habit.icon}</span>
                                    <span className="text-xs">{isWeekend ? 'Sleep (Free)' : habit.name}</span>
                                  </span>
                                  <div className="flex flex-col items-end">
                                    <input
                                      type="time"
                                      className="w-20 bg-white/20 text-center rounded text-xs p-1 text-white"
                                      value={sleepTime}
                                      onChange={(e) => updateSleepTime(actualDayIndex, e.target.value)}
                                      disabled={isDisabled}
                                    />
                                    <span className={`text-[10px] mono mt-1 ${sleepPoints < 0 ? 'text-red-300' : 'opacity-75'}`}>
                                      {sleepPoints >= 0 ? '+' : ''}{sleepPoints}pt
                                    </span>
                                  </div>
                                </div>
                              );
                            }

                            // Special handling for Digital Sunset (time input)
                            if (habit.id === 'sunset') {
                              const sunsetTime = day.sunsetTime || '';
                              const sunsetPoints = calculateSunsetPoints(sunsetTime, isWeekend);

                              return (
                                <div
                                  key={habit.id}
                                  className={`p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                    isDisabled
                                      ? 'opacity-50 bg-gray-700'
                                      : sunsetPoints >= 1
                                      ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white'
                                      : 'bg-white/5 text-purple-300'
                                  }`}
                                >
                                  <span className="flex items-center gap-2">
                                    <span className="text-lg">{habit.icon}</span>
                                    <span className="text-xs">{isWeekend ? 'Sunset (Free)' : habit.name}</span>
                                  </span>
                                  <div className="flex flex-col items-end">
                                    <input
                                      type="time"
                                      className="w-20 bg-white/20 text-center rounded text-xs p-1 text-white"
                                      value={sunsetTime}
                                      onChange={(e) => updateSunsetTime(actualDayIndex, e.target.value)}
                                      disabled={isDisabled}
                                    />
                                    <span className="text-[10px] mono opacity-75 mt-1">+{sunsetPoints}pt</span>
                                  </div>
                                </div>
                              );
                            }

                            // Special handling for reading (quantitative input)
                            if (habit.id === 'reading') {
                              const pagesRead = day.pagesRead || 0;
                              const readingPoints = Math.floor(pagesRead / 20);
                              const isComplete = pagesRead >= 20;

                              return (
                                <div
                                  key={habit.id}
                                  className={`p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                    isDisabled
                                      ? 'opacity-50 bg-gray-700'
                                      : isComplete
                                      ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white'
                                      : 'bg-white/5 text-purple-300'
                                  }`}
                                >
                                  <span className="flex items-center gap-2">
                                    <span className="text-lg">{habit.icon}</span>
                                    <span className="text-xs">{habit.name}</span>
                                  </span>
                                  <div className="flex flex-col items-end">
                                    <input
                                      type="number"
                                      min="0"
                                      step="5"
                                      className="w-14 bg-white/20 text-center rounded text-xs p-1 text-white"
                                      value={pagesRead}
                                      onChange={(e) => updateReading(actualDayIndex, e.target.value)}
                                      disabled={isDisabled}
                                      placeholder="pgs"
                                    />
                                    <span className="text-[10px] mono opacity-75 mt-1">+{readingPoints}pt</span>
                                  </div>
                                </div>
                              );
                            }

                            const isComplete = day.habits[habit.id] === habit.points;

                            return (
                              <button
                                key={habit.id}
                                onClick={() => toggleHabit(actualDayIndex, habit.id)}
                                disabled={isDisabled}
                                className={`habit-btn p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                  isDisabled
                                    ? 'opacity-50 cursor-not-allowed bg-gray-700'
                                    : isComplete
                                    ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white'
                                    : 'bg-white/5 hover:bg-white/10 text-purple-300'
                                }`}
                              >
                                <span className="flex items-center gap-2">
                                  <span className="text-lg">{habit.icon}</span>
                                  <span className="text-xs">{habit.name}</span>
                                </span>
                                <span className="text-xs mono opacity-75">
                                  {day.habits[habit.id]}/{habit.points}
                                </span>
                              </button>
                            );
                          })}
                        </div>

                        {/* Ad-hoc Tasks (Ephemeral filtering) */}
                        {(() => {
                          // Filter tasks: hide if completed on a previous day
                          const tasksForThisDay = state.adHocTasks.filter(task => {
                            const completedEarlier = currentWeek.days.some((d, idx) =>
                              idx < actualDayIndex && d.completedTasks.includes(task.id)
                            );
                            return !completedEarlier;
                          });

                          if (tasksForThisDay.length === 0) return null;

                          return (
                            <div className="space-y-2 mb-4">
                              {tasksForThisDay.map(task => {
                                const isComplete = day.completedTasks.includes(task.id);
                                const isDisabled = day.isLocked;

                                return (
                                  <button
                                    key={task.id}
                                    onClick={() => toggleTask(actualDayIndex, task.id)}
                                    disabled={isDisabled}
                                    className={`habit-btn w-full p-3 rounded-lg font-semibold text-sm flex items-center justify-between ${
                                      isDisabled
                                        ? 'opacity-50 cursor-not-allowed bg-gray-700'
                                        : isComplete
                                        ? 'bg-gradient-to-r from-yellow-500 to-orange-600 text-white'
                                        : 'bg-white/5 hover:bg-white/10 text-purple-300'
                                    }`}
                                  >
                                    <span className="flex items-center gap-2">
                                      <span className="text-lg">*</span>
                                      <span className="text-xs">{task.name}</span>
                                    </span>
                                    <span className="text-xs mono opacity-75">
                                      {isComplete ? task.points : 0}/{task.points}
                                    </span>
                                  </button>
                                );
                              })}
                            </div>
                          );
                        })()}

                        {/* Day Controls */}
                        <div className="flex gap-2">
                          <button
                            onClick={() => toggleOffDay(actualDayIndex)}
                            disabled={day.isLocked}
                            className={`flex-1 py-2 rounded-lg text-xs font-semibold transition-all ${
                              day.isLocked
                                ? 'opacity-50 cursor-not-allowed bg-gray-700'
                                : 'glass hover:bg-white/10 text-purple-300'
                            }`}
                          >
                            Mark Off
                          </button>
                          <button
                            onClick={() => toggleLock(actualDayIndex)}
                            className={`flex-1 py-2 rounded-lg text-xs font-semibold transition-all ${
                              day.isLocked
                                ? 'bg-blue-500/30 hover:bg-blue-500/40 text-blue-300'
                                : 'glass hover:bg-white/10 text-purple-300'
                            }`}
                          >
                            {day.isLocked ? 'Unlock' : 'Lock'}
                          </button>
                        </div>
                      </>
                    )}

                    {day.isOffDay && (
                      <div className="text-center py-4">
                        <div className="text-4xl mb-2">O</div>
                        <div className="text-purple-300 text-sm">Off Day</div>
                        <button
                          onClick={() => toggleOffDay(actualDayIndex)}
                          disabled={day.isLocked}
                          className="mt-3 px-4 py-2 rounded-lg text-xs font-semibold glass hover:bg-white/10 text-purple-300"
                        >
                          Unmark
                        </button>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>

            {/* Tasks Management */}
            <div className="mt-8 animate-slide-in">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-2xl font-bold">Bonus Tasks</h2>
                <button
                  onClick={() => setShowTaskModal(true)}
                  className="px-4 py-2 rounded-lg font-semibold bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all"
                >
                  + Add Task
                </button>
              </div>

              {state.adHocTasks.length === 0 ? (
                <div className="glass rounded-xl p-8 text-center text-purple-400">
                  <div className="text-4xl mb-2">*</div>
                  <div className="text-sm">No bonus tasks yet</div>
                </div>
              ) : (
                <div className="space-y-2">
                  {state.adHocTasks.map(task => (
                    <div key={task.id} className="glass rounded-xl p-4 flex items-center justify-between">
                      <div>
                        <div className="font-semibold">{task.name}</div>
                        <div className="text-xs text-purple-400 mono">{task.points} points</div>
                      </div>
                      <button
                        onClick={() => {
                          if (confirm(`Delete "${task.name}"?`)) {
                            deleteTask(task.id);
                          }
                        }}
                        className="px-3 py-1 rounded-lg text-xs font-semibold bg-red-500/20 hover:bg-red-500/30 text-red-300 transition-all"
                      >
                        Delete
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="mt-8 text-center text-purple-500 text-xs">
              <p>Data saved locally on this device</p>
            </div>
          </div>

          {/* Task Modal */}
          {showTaskModal && <TaskModal onClose={() => setShowTaskModal(false)} onAdd={addTask} />}

          {/* Backfill Prompt */}
          {showBackfillPrompt && (
            <BackfillPrompt
              onBackfill={() => {
                switchViewMode('all-days');
                setShowBackfillPrompt(false);
              }}
              onContinue={() => setShowBackfillPrompt(false)}
              unfilledCount={currentWeek.days.filter(d => isPastDay(d.date) && !d.isFilled && !d.isOffDay).length}
            />
          )}
        </div>
      );
    }

    // ============================================================================
    // TASK MODAL COMPONENT
    // ============================================================================

    function TaskModal({ onClose, onAdd }) {
      const [name, setName] = useState('');
      const [points, setPoints] = useState(2);

      const handleSubmit = () => {
        if (!name.trim()) {
          alert('Please enter a task name');
          return;
        }
        onAdd(name.trim(), points);
      };

      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 animate-slide-in">
          <div className="glass rounded-2xl p-6 max-w-md w-full">
            <h3 className="text-2xl font-bold mb-4">Add Bonus Task</h3>

            <div className="mb-4">
              <label className="block text-sm font-semibold text-purple-300 mb-2">Task Name</label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="e.g., Call dentist"
                className="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 focus:border-purple-400 focus:outline-none text-white placeholder-purple-400"
                autoFocus
              />
            </div>

            <div className="mb-6">
              <label className="block text-sm font-semibold text-purple-300 mb-2">Points (1-5)</label>
              <div className="flex gap-2">
                {[1, 2, 3, 4, 5].map(p => (
                  <button
                    key={p}
                    onClick={() => setPoints(p)}
                    className={`flex-1 py-3 rounded-lg font-bold transition-all ${
                      points === p
                        ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white'
                        : 'glass text-purple-300 hover:bg-white/10'
                    }`}
                  >
                    {p}
                  </button>
                ))}
              </div>
            </div>

            <div className="flex gap-3">
              <button
                onClick={onClose}
                className="flex-1 py-3 rounded-lg font-semibold glass hover:bg-white/10 text-purple-300"
              >
                Cancel
              </button>
              <button
                onClick={handleSubmit}
                className="flex-1 py-3 rounded-lg font-semibold bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600"
              >
                Add Task
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================================================
    // BACKFILL PROMPT COMPONENT
    // ============================================================================

    function BackfillPrompt({ onBackfill, onContinue, unfilledCount }) {
      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 animate-slide-in">
          <div className="glass rounded-2xl p-6 max-w-md w-full">
            <div className="text-center mb-6">
              <div className="text-6xl mb-4">!</div>
              <h3 className="text-2xl font-bold mb-2">Missing Data Detected</h3>
              <p className="text-purple-300">
                You have {unfilledCount} day{unfilledCount > 1 ? 's' : ''} to backfill since your journey started.
              </p>
            </div>

            <div className="flex flex-col gap-3">
              <button
                onClick={onBackfill}
                className="py-3 rounded-lg font-semibold bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600"
              >
                Backfill Now
              </button>
              <button
                onClick={onContinue}
                className="py-3 rounded-lg font-semibold glass hover:bg-white/10 text-purple-300"
              >
                Continue with Today
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Render the app
    ReactDOM.createRoot(document.getElementById('root')).render(<DisciplineTracker />);
  </script>
</body>
</html>
